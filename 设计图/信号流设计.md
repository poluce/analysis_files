# ä¿¡å·æµå‘æ¶æ„è®¾è®¡è¯´æ˜

## ğŸ“‹ ç›®å½•
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [ä¸¤ç§ä¿¡å·è·¯å¾„](#ä¸¤ç§ä¿¡å·è·¯å¾„)
- [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é”™è¯¯](#å¸¸è§é”™è¯¯)

---

## æ ¸å¿ƒæ¦‚å¿µ

### ğŸ¯ è®¾è®¡åŸåˆ™

åœ¨ DSC/TGA çƒ­åˆ†æè½¯ä»¶çš„å››å±‚æ¶æ„ä¸­ï¼Œä¿¡å·æµå‘éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. **å‘½ä»¤å‘ä¸‹èµ° Controller**ï¼ˆå†™æ“ä½œï¼‰
   - ç”¨æˆ·æ“ä½œ â†’ UI å‘ä¿¡å· â†’ Controller åè°ƒ â†’ Service æ‰§è¡Œ

2. **é€šçŸ¥å‘ä¸Šå¯ç›´è¿**ï¼ˆè¯»æ“ä½œï¼‰
   - Service å‘ä¿¡å· â†’ UI ç›‘å¬ â†’ æ›´æ–°æ˜¾ç¤º

---

## ä¸¤ç§ä¿¡å·è·¯å¾„

### ğŸ”½ è·¯å¾„1: å‘½ä»¤è·¯å¾„ï¼ˆå‘ä¸‹ï¼‰

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
    â†“
ToolPanel::emit algorithmApplyRequested(name, params)
    â†“
MainController::handleAlgorithmApply(name, params)
    â”œâ”€ ä¸šåŠ¡è§„åˆ™æ£€æŸ¥ï¼ˆæ›²çº¿æ˜¯å¦å­˜åœ¨ï¼Ÿï¼‰
    â”œâ”€ åˆ›å»º Command å¯¹è±¡ï¼ˆæ”¯æŒæ’¤é”€ï¼‰
    â”œâ”€ è°ƒç”¨ HistoryManager::execute(cmd)
    â””â”€ è®°å½•æ—¥å¿—ã€æ›´æ–°çŠ¶æ€
        â†“
    AlgorithmCommand::execute()
        â”œâ”€ è°ƒç”¨ AlgorithmService::getAlgorithm()
        â”œâ”€ æ‰§è¡Œ algorithm->process(data)
        â””â”€ æ›´æ–° CurveManager æ•°æ®
```

**é€‚ç”¨åœºæ™¯:**
- âœ… æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„æ“ä½œ
- âœ… éœ€è¦æ’¤é”€/é‡åšçš„æ“ä½œ
- âœ… éœ€è¦åè°ƒå¤šä¸ª Service çš„æ“ä½œ
- âœ… éœ€è¦æƒé™æ£€æŸ¥ã€æ—¥å¿—è®°å½•çš„æ“ä½œ

---

### ğŸ”¼ è·¯å¾„2: é€šçŸ¥è·¯å¾„ï¼ˆå‘ä¸Šï¼‰

```
ç®—æ³•æ‰§è¡Œå®Œæˆ
    â†“
AlgorithmService::emit algorithmFinished(name, result)
    â†“
ToolPanel::onAlgorithmFinished(name, result)  â† ç›´æ¥ç›‘å¬
    â””â”€ æ›´æ–°ç»“æœè¡¨æ ¼ï¼ˆçº¯ UI æ›´æ–°ï¼‰

CurveManager::emit curveDataChanged(curveId)
    â†“
ChartView::onCurveDataChanged(curveId)  â† ç›´æ¥ç›‘å¬
    â””â”€ é‡ç»˜å›¾è¡¨
```

**é€‚ç”¨åœºæ™¯:**
- âœ… åªè¯»çš„ UI æ›´æ–°ï¼ˆæ˜¾ç¤ºç»“æœã€è¿›åº¦æ¡ï¼‰
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥ï¼ˆæ›²çº¿æ•°æ®å˜åŒ–ååˆ·æ–°å›¾è¡¨ï¼‰
- âœ… ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘çš„é€šçŸ¥

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### 1. ToolPanel å®ç°

```cpp
// ToolPanel.h
#ifndef TOOLPANEL_H
#define TOOLPANEL_H

#include <QDockWidget>
#include <QComboBox>
#include <QPushButton>
#include <QTableWidget>
#include <QFormLayout>
#include <QProgressBar>
#include <QVariantMap>

class ToolPanel : public QDockWidget {
    Q_OBJECT

public:
    explicit ToolPanel(QWidget* parent = nullptr);

    // UI æ›´æ–°æ–¹æ³•ï¼ˆè¢«åŠ¨æ¥æ”¶ï¼‰
    void showAlgorithmParams(const QString& algoName);
    void displayResults(const QVariantMap& result);

signals:
    // ===== å‘½ä»¤ä¿¡å·ï¼ˆå‘é€ç»™ Controllerï¼‰=====
    void algorithmApplyRequested(QString name, QVariantMap params);
    void parameterChanged(QString name, QVariant value);

private slots:
    // ===== é€šçŸ¥æ§½å‡½æ•°ï¼ˆç›‘å¬ Serviceï¼‰=====
    void onAlgorithmStarted(QString name);
    void onAlgorithmFinished(QString name, QVariantMap result);
    void onAlgorithmProgress(int percent);
    void onCurveDataChanged(QString curveId);

    // UI æ§ä»¶æ§½å‡½æ•°
    void onApplyButtonClicked();

private:
    void setupUI();
    void setupConnections();
    QVariantMap collectParameters();

    // UI æˆå‘˜
    QComboBox* m_algoComboBox;
    QPushButton* m_applyButton;
    QTableWidget* m_resultTable;
    QProgressBar* m_progressBar;
    QFormLayout* m_paramLayout;

    // å‚æ•°è¾“å…¥æ§ä»¶å®¹å™¨
    QMap<QString, QWidget*> m_paramWidgets;
};

#endif // TOOLPANEL_H
```

```cpp
// ToolPanel.cpp
#include "ToolPanel.h"
#include "AlgorithmService.h"
#include "CurveManager.h"
#include <QVBoxLayout>
#include <QLabel>
#include <QSpinBox>
#include <QDoubleSpinBox>

ToolPanel::ToolPanel(QWidget* parent)
    : QDockWidget("ç®—æ³•å·¥å…·", parent)
{
    setupUI();
    setupConnections();
}

void ToolPanel::setupUI() {
    auto* widget = new QWidget(this);
    auto* layout = new QVBoxLayout(widget);

    // ç®—æ³•é€‰æ‹©
    layout->addWidget(new QLabel("é€‰æ‹©ç®—æ³•:"));
    m_algoComboBox = new QComboBox();
    m_algoComboBox->addItems({"åŸºçº¿æ ¡æ­£", "å¹³æ»‘å¤„ç†", "å³°æ£€æµ‹", "åŠ¨åŠ›å­¦åˆ†æ"});
    layout->addWidget(m_algoComboBox);

    // å‚æ•°åŒºåŸŸ
    m_paramLayout = new QFormLayout();
    layout->addLayout(m_paramLayout);

    // åº”ç”¨æŒ‰é’®
    m_applyButton = new QPushButton("åº”ç”¨");
    layout->addWidget(m_applyButton);

    // è¿›åº¦æ¡
    m_progressBar = new QProgressBar();
    m_progressBar->setVisible(false);
    layout->addWidget(m_progressBar);

    // ç»“æœè¡¨æ ¼
    layout->addWidget(new QLabel("ç»“æœ:"));
    m_resultTable = new QTableWidget();
    m_resultTable->setColumnCount(2);
    m_resultTable->setHorizontalHeaderLabels({"å‚æ•°", "å€¼"});
    layout->addWidget(m_resultTable);

    layout->addStretch();
    setWidget(widget);
}

void ToolPanel::setupConnections() {
    // ========== ç›‘å¬ Service ä¿¡å·ï¼ˆé€šçŸ¥è·¯å¾„ï¼‰==========
    connect(AlgorithmService::instance(),
            &AlgorithmService::algorithmStarted,
            this, &ToolPanel::onAlgorithmStarted);

    connect(AlgorithmService::instance(),
            &AlgorithmService::algorithmFinished,
            this, &ToolPanel::onAlgorithmFinished);

    connect(AlgorithmService::instance(),
            &AlgorithmService::algorithmProgress,
            this, &ToolPanel::onAlgorithmProgress);

    // ç›‘å¬ CurveManager
    connect(CurveManager::instance(),
            &CurveManager::curveDataChanged,
            this, &ToolPanel::onCurveDataChanged);

    // ========== UI æ§ä»¶ä¿¡å·ï¼ˆå‘é€å‘½ä»¤ï¼‰==========
    connect(m_applyButton, &QPushButton::clicked,
            this, &ToolPanel::onApplyButtonClicked);

    connect(m_algoComboBox, QOverload<int>::of(&QComboBox::currentIndexChanged),
            this, [this](int index) {
        QString algoName = m_algoComboBox->currentText();
        showAlgorithmParams(algoName);
    });
}

// ========== å‘½ä»¤å‘é€æ–¹æ³• ==========
void ToolPanel::onApplyButtonClicked() {
    QString algoName = m_algoComboBox->currentText();
    QVariantMap params = collectParameters();

    // âœ… æ­£ç¡®ï¼šå‘é€ä¿¡å·ç»™ Controllerï¼Œä¸ç›´æ¥è°ƒç”¨ Service
    emit algorithmApplyRequested(algoName, params);

    // âŒ é”™è¯¯ï¼šä¸è¦è¿™æ ·åš
    // AlgorithmService::instance()->executeAsync(algoName, data, params);
}

QVariantMap ToolPanel::collectParameters() {
    QVariantMap params;
    for (auto it = m_paramWidgets.begin(); it != m_paramWidgets.end(); ++it) {
        QString paramName = it.key();
        QWidget* widget = it.value();

        if (auto* spinBox = qobject_cast<QSpinBox*>(widget)) {
            params[paramName] = spinBox->value();
        } else if (auto* doubleSpinBox = qobject_cast<QDoubleSpinBox*>(widget)) {
            params[paramName] = doubleSpinBox->value();
        }
        // ... å…¶ä»–æ§ä»¶ç±»å‹
    }
    return params;
}

// ========== é€šçŸ¥æ¥æ”¶æ–¹æ³•ï¼ˆåªè¯»æ›´æ–°ï¼‰==========
void ToolPanel::onAlgorithmStarted(QString name) {
    m_applyButton->setEnabled(false);
    m_progressBar->setVisible(true);
    m_progressBar->setValue(0);
}

void ToolPanel::onAlgorithmFinished(QString name, QVariantMap result) {
    m_applyButton->setEnabled(true);
    m_progressBar->setVisible(false);

    // çº¯ UI æ›´æ–°ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘
    displayResults(result);
}

void ToolPanel::displayResults(const QVariantMap& result) {
    m_resultTable->setRowCount(0);

    for (auto it = result.begin(); it != result.end(); ++it) {
        int row = m_resultTable->rowCount();
        m_resultTable->insertRow(row);
        m_resultTable->setItem(row, 0, new QTableWidgetItem(it.key()));
        m_resultTable->setItem(row, 1,
            new QTableWidgetItem(it.value().toString()));
    }
}

void ToolPanel::onAlgorithmProgress(int percent) {
    m_progressBar->setValue(percent);
}

void ToolPanel::onCurveDataChanged(QString curveId) {
    // å¦‚æœç»“æœè¡¨æ ¼æ˜¾ç¤ºçš„æ˜¯å½“å‰æ›²çº¿çš„æ•°æ®ï¼Œå¯èƒ½éœ€è¦æ¸…ç©º
    // è¿™æ˜¯çº¯ UI é€»è¾‘
}

void ToolPanel::showAlgorithmParams(const QString& algoName) {
    // æ¸…ç©ºå½“å‰å‚æ•°
    QLayoutItem* item;
    while ((item = m_paramLayout->takeAt(0)) != nullptr) {
        delete item->widget();
        delete item;
    }
    m_paramWidgets.clear();

    // æ ¹æ®ç®—æ³•ç±»å‹æ˜¾ç¤ºä¸åŒå‚æ•°ï¼ˆç¤ºä¾‹ï¼‰
    if (algoName == "åŸºçº¿æ ¡æ­£") {
        auto* degreeSpinBox = new QSpinBox();
        degreeSpinBox->setRange(1, 10);
        degreeSpinBox->setValue(3);
        m_paramLayout->addRow("å¤šé¡¹å¼é˜¶æ•°:", degreeSpinBox);
        m_paramWidgets["degree"] = degreeSpinBox;

    } else if (algoName == "å¹³æ»‘å¤„ç†") {
        auto* windowSpinBox = new QSpinBox();
        windowSpinBox->setRange(3, 51);
        windowSpinBox->setValue(5);
        m_paramLayout->addRow("çª—å£å¤§å°:", windowSpinBox);
        m_paramWidgets["windowSize"] = windowSpinBox;
    }
    // ... å…¶ä»–ç®—æ³•å‚æ•°
}
```

---

### 2. MainController å®ç°

```cpp
// MainController.h
#ifndef MAINCONTROLLER_H
#define MAINCONTROLLER_H

#include <QObject>
#include <QString>
#include <QVariantMap>

// å‰å‘å£°æ˜
class ProjectManager;
class CurveManager;
class AlgorithmService;
class HistoryManager;

class MainController : public QObject {
    Q_OBJECT

public:
    explicit MainController(
        ProjectManager* projectManager,
        CurveManager* curveManager,
        AlgorithmService* algorithmService,
        HistoryManager* historyManager,
        QObject* parent = nullptr
    );

public slots:
    // ===== å¤„ç† UI å‘½ä»¤çš„æ§½å‡½æ•° =====
    void handleOpenFile();
    void handleSaveProject();
    void handleUndo();
    void handleRedo();
    void handleAlgorithmApply(QString name, QVariantMap params);

signals:
    // çŠ¶æ€é€šçŸ¥ï¼ˆå¯é€‰ï¼Œç”¨äºçŠ¶æ€æ æ¶ˆæ¯ç­‰ï¼‰
    void statusMessage(QString message);
    void errorOccurred(QString error);

private:
    // ä¾èµ–æ³¨å…¥çš„ Service
    ProjectManager* m_projectManager;
    CurveManager* m_curveManager;
    AlgorithmService* m_algorithmService;
    HistoryManager* m_historyManager;

    // è¾…åŠ©æ–¹æ³•
    bool validateCurveData();
    void logOperation(const QString& operation, const QVariantMap& details);
};

#endif // MAINCONTROLLER_H
```

```cpp
// MainController.cpp
#include "MainController.h"
#include "ProjectManager.h"
#include "CurveManager.h"
#include "AlgorithmService.h"
#include "HistoryManager.h"
#include "AlgorithmCommand.h"
#include "ThermalCurve.h"
#include <QMessageBox>
#include <QDebug>

MainController::MainController(
    ProjectManager* projectManager,
    CurveManager* curveManager,
    AlgorithmService* algorithmService,
    HistoryManager* historyManager,
    QObject* parent
)
    : QObject(parent)
    , m_projectManager(projectManager)
    , m_curveManager(curveManager)
    , m_algorithmService(algorithmService)
    , m_historyManager(historyManager)
{
    Q_ASSERT(projectManager);
    Q_ASSERT(curveManager);
    Q_ASSERT(algorithmService);
    Q_ASSERT(historyManager);
}

// ========== å¤„ç†ç®—æ³•æ‰§è¡Œå‘½ä»¤ ==========
void MainController::handleAlgorithmApply(QString name, QVariantMap params) {
    qInfo() << "MainController: æ¥æ”¶åˆ°ç®—æ³•æ‰§è¡Œè¯·æ±‚" << name;

    // 1ï¸âƒ£ ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    ThermalCurve* curve = m_curveManager->getActiveCurve();
    if (!curve) {
        QString error = tr("é”™è¯¯ï¼šè¯·å…ˆé€‰æ‹©ä¸€æ¡æ›²çº¿");
        emit errorOccurred(error);
        QMessageBox::warning(nullptr, tr("é”™è¯¯"), error);
        return;
    }

    if (curve->getRawData().isEmpty()) {
        QString error = tr("é”™è¯¯ï¼šæ›²çº¿æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œç®—æ³•");
        emit errorOccurred(error);
        QMessageBox::warning(nullptr, tr("é”™è¯¯"), error);
        return;
    }

    // 2ï¸âƒ£ è·å–ç®—æ³•å®ä¾‹
    IThermalAlgorithm* algorithm = m_algorithmService->getAlgorithm(name);
    if (!algorithm) {
        QString error = tr("é”™è¯¯ï¼šæœªæ‰¾åˆ°ç®—æ³• '%1'").arg(name);
        emit errorOccurred(error);
        QMessageBox::critical(nullptr, tr("é”™è¯¯"), error);
        return;
    }

    // 3ï¸âƒ£ è®¾ç½®ç®—æ³•å‚æ•°
    algorithm->setParameters(params);

    // 4ï¸âƒ£ åˆ›å»ºå¯æ’¤é”€å‘½ä»¤
    auto* cmd = new AlgorithmCommand(
        curve->getId(),
        algorithm,
        m_curveManager,
        m_algorithmService
    );

    // 5ï¸âƒ£ é€šè¿‡ HistoryManager æ‰§è¡Œï¼ˆæ”¯æŒæ’¤é”€ï¼‰
    if (!m_historyManager->execute(cmd)) {
        QString error = tr("é”™è¯¯ï¼šç®—æ³•æ‰§è¡Œå¤±è´¥");
        emit errorOccurred(error);
        QMessageBox::critical(nullptr, tr("é”™è¯¯"), error);
        delete cmd;
        return;
    }

    // 6ï¸âƒ£ æ ‡è®°é¡¹ç›®å·²ä¿®æ”¹
    m_projectManager->setModified(true);

    // 7ï¸âƒ£ è®°å½•æ“ä½œæ—¥å¿—
    logOperation("ç®—æ³•æ‰§è¡Œ", {
        {"algorithm", name},
        {"curveId", curve->getId()},
        {"curveName", curve->getName()},
        {"parameters", params}
    });

    // 8ï¸âƒ£ å‘é€çŠ¶æ€æ¶ˆæ¯
    emit statusMessage(tr("æ­£åœ¨æ‰§è¡Œç®—æ³•: %1").arg(name));

    // æ³¨æ„ï¼šç»“æœæ˜¾ç¤ºç”± ToolPanel ç›‘å¬ AlgorithmService::algorithmFinished ä¿¡å·å¤„ç†
    // Controller ä¸è´Ÿè´£é€šçŸ¥ UI æ›´æ–°
}

void MainController::handleUndo() {
    if (!m_historyManager->canUndo()) {
        QMessageBox::information(nullptr, tr("æç¤º"), tr("æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ"));
        return;
    }

    m_historyManager->undo();
    m_projectManager->setModified(true);

    emit statusMessage(tr("å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ"));
}

void MainController::handleRedo() {
    if (!m_historyManager->canRedo()) {
        QMessageBox::information(nullptr, tr("æç¤º"), tr("æ²¡æœ‰å¯é‡åšçš„æ“ä½œ"));
        return;
    }

    m_historyManager->redo();
    m_projectManager->setModified(true);

    emit statusMessage(tr("å·²é‡åšæ“ä½œ"));
}

void MainController::logOperation(const QString& operation, const QVariantMap& details) {
    // è®°å½•åˆ°æ—¥å¿—ç³»ç»Ÿ
    QString logMsg = QString("æ“ä½œ: %1").arg(operation);
    for (auto it = details.begin(); it != details.end(); ++it) {
        logMsg += QString(", %1=%2").arg(it.key()).arg(it.value().toString());
    }
    qInfo() << logMsg;
}
```

---

### 3. åº”ç”¨ç¨‹åºå¯åŠ¨ä»£ç 

```cpp
// Application.cpp
#include "Application.h"
#include "MainWindow.h"
#include "MainController.h"
#include "ChartController.h"
#include "ProjectManager.h"
#include "CurveManager.h"
#include "AlgorithmService.h"
#include "HistoryManager.h"
#include "SignalConnectionManager.h"

class Application {
public:
    void initialize() {
        // ========== åˆ›å»ºå•ä¾‹ Serviceï¼ˆåº”ç”¨å±‚ï¼‰==========
        auto* projectManager = ProjectManager::instance();
        auto* curveManager = CurveManager::instance();
        auto* algorithmService = AlgorithmService::instance();
        auto* historyManager = HistoryManager::instance();

        // ========== åˆ›å»º Controllerï¼ˆåº”ç”¨å±‚ï¼‰==========
        m_mainController = new MainController(
            projectManager,
            curveManager,
            algorithmService,
            historyManager
        );

        m_chartController = new ChartController(
            curveManager,
            algorithmService
        );

        // ========== åˆ›å»º UIï¼ˆè¡¨ç¤ºå±‚ï¼‰==========
        m_mainWindow = new MainWindow();

        // ========== å»ºç«‹ä¿¡å·è¿æ¥ ==========
        setupSignalConnections();

        // ========== æ˜¾ç¤ºçª—å£ ==========
        m_mainWindow->show();
    }

private:
    void setupSignalConnections() {
        // ===== å‘½ä»¤è·¯å¾„ï¼šUI â†’ Controller =====

        // MainWindow â†’ MainController
        connect(m_mainWindow, &MainWindow::openFileRequested,
                m_mainController, &MainController::handleOpenFile);
        connect(m_mainWindow, &MainWindow::saveProjectRequested,
                m_mainController, &MainController::handleSaveProject);
        connect(m_mainWindow, &MainWindow::undoRequested,
                m_mainController, &MainController::handleUndo);
        connect(m_mainWindow, &MainWindow::redoRequested,
                m_mainController, &MainController::handleRedo);

        // ToolPanel â†’ MainController
        auto* toolPanel = m_mainWindow->getToolPanel();
        connect(toolPanel, &ToolPanel::algorithmApplyRequested,
                m_mainController, &MainController::handleAlgorithmApply);

        // ChartView â†’ ChartController
        auto* chartView = m_mainWindow->getChartView();
        connect(chartView, &ChartView::regionSelected,
                m_chartController, &ChartController::handleRegionSelection);

        // ===== é€šçŸ¥è·¯å¾„ï¼šService â†’ UI =====
        // (å·²åœ¨å„ UI ç»„ä»¶å†…éƒ¨çš„ setupConnections() ä¸­å®Œæˆ)
        // ä¾‹å¦‚ï¼šToolPanel ç›‘å¬ AlgorithmService::algorithmFinished

        // ===== Controller çŠ¶æ€æ¶ˆæ¯ â†’ MainWindow çŠ¶æ€æ  =====
        connect(m_mainController, &MainController::statusMessage,
                m_mainWindow, &MainWindow::showStatusMessage);
        connect(m_mainController, &MainController::errorOccurred,
                m_mainWindow, &MainWindow::showErrorMessage);
    }

    MainWindow* m_mainWindow;
    MainController* m_mainController;
    ChartController* m_chartController;
};

// main.cpp
int main(int argc, char *argv[]) {
    QApplication app(argc, argv);

    Application application;
    application.initialize();

    return app.exec();
}
```

---

## æœ€ä½³å®è·µ

### âœ… DO - æ¨èåšæ³•

1. **æ‰€æœ‰å†™æ“ä½œèµ° Controller**
```cpp
// ToolPanel.cpp
void ToolPanel::onApplyButtonClicked() {
    // âœ… å‘å°„ä¿¡å·ç»™ Controller
    emit algorithmApplyRequested(algoName, params);
}
```

2. **åªè¯»æ›´æ–°ç›´æ¥ç›‘å¬ Service**
```cpp
// ToolPanel.cpp æ„é€ å‡½æ•°
connect(AlgorithmService::instance(), &AlgorithmService::algorithmFinished,
        this, &ToolPanel::displayResults);
```

3. **ä½¿ç”¨ Command æ¨¡å¼æ”¯æŒæ’¤é”€**
```cpp
// MainController.cpp
auto* cmd = new AlgorithmCommand(...);
m_historyManager->execute(cmd);  // è‡ªåŠ¨è®°å½•å†å²
```

4. **åœ¨ Controller ä¸­åè°ƒå¤šä¸ª Service**
```cpp
void MainController::handleAlgorithmApply(...) {
    // æ£€æŸ¥ CurveManager
    // è°ƒç”¨ AlgorithmService
    // è®°å½•åˆ° HistoryManager
    // é€šçŸ¥ ProjectManager
}
```

---

### âŒ DON'T - é¿å…çš„åšæ³•

1. **âŒ UI ç›´æ¥è°ƒç”¨ Service æ‰§è¡Œå†™æ“ä½œ**
```cpp
// ToolPanel.cpp - é”™è¯¯ç¤ºä¾‹
void ToolPanel::onApplyButtonClicked() {
    // âŒ è·³è¿‡ Controllerï¼Œæ— æ³•æ’¤é”€ï¼Œæ— æ³•è®°å½•æ—¥å¿—
    AlgorithmService::instance()->executeAsync(...);
}
```

2. **âŒ é€šè¿‡ Controller è½¬å‘åªè¯»ä¿¡å·**
```cpp
// MainController.cpp - ä¸å¿…è¦çš„è½¬å‘
connect(AlgorithmService::instance(), &AlgorithmService::algorithmFinished,
        this, &MainController::onAlgorithmFinished);

void MainController::onAlgorithmFinished(Result result) {
    // âŒ åªæ˜¯è½¬å‘ï¼Œæ²¡æœ‰æ·»åŠ ä»»ä½•ä¸šåŠ¡é€»è¾‘
    emit algorithmResultReady(result);
}
```

3. **âŒ UI å±‚åŒ…å«ä¸šåŠ¡é€»è¾‘**
```cpp
// ToolPanel.cpp - é”™è¯¯ç¤ºä¾‹
void ToolPanel::onApplyButtonClicked() {
    // âŒ UI å±‚ä¸åº”è¯¥å¤„ç†ä¸šåŠ¡è§„åˆ™
    if (CurveManager::instance()->getActiveCurve() == nullptr) {
        QMessageBox::warning(...);
        return;
    }
    // âŒ UI å±‚ä¸åº”è¯¥åè°ƒå¤šä¸ª Service
    AlgorithmService::instance()->executeAsync(...);
    ProjectManager::instance()->setModified(true);
}
```



---

## å¸¸è§é”™è¯¯

### é—®é¢˜1: "ä¸ºä»€ä¹ˆä¸èƒ½ ToolPanel ç›´æ¥è°ƒç”¨ AlgorithmServiceï¼Ÿ"

**ç­”æ¡ˆ:**
- âŒ æ— æ³•å®ç°æ’¤é”€/é‡åšåŠŸèƒ½
- âŒ æ— æ³•ç»Ÿä¸€è®°å½•æ“ä½œæ—¥å¿—
- âŒ æ— æ³•åè°ƒå¤šä¸ª Serviceï¼ˆå¦‚åŒæ—¶æ›´æ–° ProjectManagerï¼‰
- âŒ UI å±‚æ‰¿æ‹…äº†ä¸šåŠ¡åè°ƒèŒè´£ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

### é—®é¢˜2: "ç›‘å¬ Service ä¿¡å·æ˜¯å¦è¿åäº†åˆ†å±‚åŸåˆ™ï¼Ÿ"

**ç­”æ¡ˆ:**
- âœ… **ä¸è¿å**ï¼Œè¿™æ˜¯åˆç†çš„è®¾è®¡
- è¡¨ç¤ºå±‚å¯ä»¥**åªè¯»è®¿é—®**åº”ç”¨å±‚çš„çŠ¶æ€
- è¿™æ˜¯**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼Œä¸æ˜¯ç›´æ¥ä¾èµ–
- é¿å…äº†ä¸å¿…è¦çš„ä¿¡å·è½¬å‘ï¼ˆService â†’ Controller â†’ UIï¼‰

### é—®é¢˜3: "ä»€ä¹ˆæ—¶å€™éœ€è¦é€šè¿‡ Controller è½¬å‘ä¿¡å·ï¼Ÿ"

**ç­”æ¡ˆ:**
åªåœ¨ä»¥ä¸‹æƒ…å†µéœ€è¦è½¬å‘ï¼š
1. Controller éœ€è¦**æ·»åŠ ä¸šåŠ¡é€»è¾‘**ï¼ˆå¦‚è¿‡æ»¤ã€è½¬æ¢ï¼‰
2. éœ€è¦**åè°ƒå¤šä¸ª Service çš„å“åº”**
3. éœ€è¦**æƒé™æ£€æŸ¥**åå†é€šçŸ¥ UI

å¦‚æœåªæ˜¯çº¯ç²¹è½¬å‘ï¼Œåº”è¯¥è®© UI ç›´æ¥ç›‘å¬ Serviceã€‚

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒè¦ç‚¹

| æ“ä½œç±»å‹ | ä¿¡å·è·¯å¾„ | åŸå›  |
|---------|---------|------|
| **å†™æ“ä½œ** | UI â†’ Controller â†’ Service | éœ€è¦æ’¤é”€ã€æ—¥å¿—ã€åè°ƒ |
| **è¯»æ“ä½œ** | Service â†’ UIï¼ˆç›´æ¥ç›‘å¬ï¼‰ | é¿å…ä¸å¿…è¦è½¬å‘ |

### ğŸ“Š åˆ¤æ–­æ ‡å‡†

**é—®è‡ªå·±ä¸‰ä¸ªé—®é¢˜:**

1. **è¿™ä¸ªæ“ä½œä¿®æ”¹æ•°æ®å—ï¼Ÿ**
   - æ˜¯ â†’ å¿…é¡»èµ° Controller
   - å¦ â†’ å¯ä»¥ç›´æ¥ç›‘å¬

2. **éœ€è¦æ’¤é”€/é‡åšå—ï¼Ÿ**
   - æ˜¯ â†’ å¿…é¡»èµ° Controller + Command æ¨¡å¼
   - å¦ â†’ çœ‹æƒ…å†µ

3. **éœ€è¦åè°ƒå¤šä¸ª Service å—ï¼Ÿ**
   - æ˜¯ â†’ å¿…é¡»èµ° Controller
   - å¦ â†’ å¯ä»¥ç›´æ¥ç›‘å¬

---

**æ¶æ„å›¾å‚è€ƒ:**
- [æ¶æ„å±‚çº§å›¾.puml](æ¶æ„å±‚çº§å›¾.puml) - è¯¦ç»†çš„å››å±‚æ¶æ„å›¾
- [æ¶æ„å›¾.puml](æ¶æ„å›¾.puml) - ç®€åŒ–çš„æ¶æ„å›¾

**ç›¸å…³æ–‡æ¡£:**
- Command æ¨¡å¼å®ç°
- Service å±‚è®¾è®¡æŒ‡å—
- å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ
