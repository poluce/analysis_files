# ç®—æ³•é“¾å¼æ‰§è¡Œé‡æ„ - ä»»åŠ¡æ‰§è¡Œæ¸…å•

**åŸºäºæ–‡æ¡£**: `æ–°è®¾è®¡æ–‡æ¡£/ç®—æ³•é“¾å¼æ‰§è¡Œé‡æ„è®¡åˆ’.md` (v1.2)
**æ‰§è¡Œæ—¥æœŸ**: 2025-11-19
**æ‰§è¡Œç­–ç•¥**: 0æ–°ç±»æ–¹æ¡ˆ - ä¸è€ƒè™‘å‘åå…¼å®¹ï¼Œç›´æ¥å…¨é¢åˆ‡æ¢

---

## ğŸ“‹ ä»»åŠ¡æ€»è§ˆ

| é˜¶æ®µ | ä»»åŠ¡æ•° | é¢„è®¡å·¥æ—¶ | çŠ¶æ€ |
|------|--------|---------|------|
| é˜¶æ®µ1: åŸºç¡€è®¾æ–½å±‚ | 2 | 2.5h | âœ… å·²å®Œæˆ |
| é˜¶æ®µ2: åè°ƒå±‚ | 2 | 7h | â¸ï¸ å¾…å¼€å§‹ |
| é˜¶æ®µ3: ç®—æ³•å¢å¼º | 2 | 2.5h | â¸ï¸ å¾…å¼€å§‹ |
| é˜¶æ®µ4: UIå±‚è°ƒæ•´ | 2 | 1.5-3h | â¸ï¸ å¾…å¼€å§‹ |
| é˜¶æ®µ5: æ¸…ç†æ—§ä»£ç  | 1 | 1h | â¸ï¸ å¾…å¼€å§‹ |
| **æ€»è®¡** | **9** | **14.5-16h** | - |

---

## ğŸ¯ é˜¶æ®µ1: åŸºç¡€è®¾æ–½å±‚ï¼ˆæ— ä¾èµ–ï¼‰

### ä»»åŠ¡1.1: OutputKeys é”®ç”Ÿæˆå·¥å…·å¢å¼º âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `Analysis/src/domain/algorithm/algorithm_result.h`

**æ”¹åŠ¨æ¸…å•**:
- [x] åˆ é™¤ `LatestSuffix` å¸¸é‡ï¼ˆç¬¬43-44è¡Œï¼‰
- [x] åˆ é™¤ `ResultTypeSuffix` å¸¸é‡ï¼ˆç¬¬46-47è¡Œï¼‰
- [x] åˆ é™¤ `latestResult(algorithmName)` å‡½æ•°ï¼ˆç¬¬66-68è¡Œï¼‰
- [x] åˆ é™¤ `resultType(algorithmName)` å‡½æ•°ï¼ˆç¬¬81-83è¡Œï¼‰
- [x] æ–°å¢ `ByTaskInfix` å¸¸é‡
- [x] æ–°å¢ `ByCurveInfix` å¸¸é‡
- [x] æ–°å¢ `LatestTaskIdSuffix` å¸¸é‡
- [x] æ–°å¢ `HistoryTaskIdsSuffix` å¸¸é‡
- [x] æ–°å¢ `byTask(algorithm, taskId)` å‡½æ•°
- [x] æ–°å¢ `latestTaskId(algorithm, curveId)` å‡½æ•°
- [x] æ–°å¢ `historyTaskIds(algorithm, curveId)` å‡½æ•°

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•é”®ç”Ÿæˆ
QString key1 = OutputKeys::byTask("differentiation", "task-001");
QCOMPARE(key1, "result/differentiation/byTask/task-001");

QString key2 = OutputKeys::latestTaskId("differentiation", "curve-123");
QCOMPARE(key2, "result/differentiation/byCurve/curve-123/latestTaskId");

QString key3 = OutputKeys::historyTaskIds("differentiation", "curve-123");
QCOMPARE(key3, "result/differentiation/byCurve/curve-123/historyTaskIds");
```

---

### ä»»åŠ¡1.2: AlgorithmContext ç»“æœå­˜å–å°è£… â¸ï¸ å¾…å¼€å§‹

**æ–‡ä»¶**:
- `Analysis/src/application/algorithm/algorithm_context.h`
- `Analysis/src/application/algorithm/algorithm_context.cpp`

**æ”¹åŠ¨æ¸…å•**:
- [ ] æ–°å¢ `m_historyDepth` æˆå‘˜å˜é‡ï¼ˆé»˜è®¤20ï¼‰
- [ ] æ–°å¢ `saveResult(taskId, algorithm, parentCurveId, result)` æ–¹æ³•
- [ ] æ–°å¢ `latestResult(algorithm, curveId)` æ–¹æ³•
- [ ] æ–°å¢ `historyResults(algorithm, curveId, limit)` æ–¹æ³•
- [ ] æ–°å¢ `setHistoryDepth(depth)` / `historyDepth()` æ–¹æ³•

**å®ç°è¦ç‚¹**:

**`saveResult()` å®ç°é€»è¾‘**:
```cpp
void AlgorithmContext::saveResult(
    const QString& taskId,
    const QString& algorithm,
    const QString& parentCurveId,
    const AlgorithmResult& result)
{
    // 1. ä¸»å­˜å‚¨ï¼ˆbyTaskï¼‰- ä¸å¯è¦†ç›–
    QString taskKey = OutputKeys::byTask(algorithm, taskId);
    setValue(taskKey, QVariant::fromValue(result));

    // 2. æ›´æ–°æœ€æ–°ä»»åŠ¡IDæŒ‡é’ˆ
    QString latestKey = OutputKeys::latestTaskId(algorithm, parentCurveId);
    setValue(latestKey, taskId);

    // 3. æ›´æ–°å†å²ä»»åŠ¡IDé˜Ÿåˆ—ï¼ˆLRUï¼‰
    QString historyKey = OutputKeys::historyTaskIds(algorithm, parentCurveId);
    QStringList history = get<QStringList>(historyKey).value_or(QStringList());

    // è¿½åŠ åˆ°é˜Ÿåˆ—å¤´éƒ¨
    history.prepend(taskId);

    // LRU è£å‰ªï¼šè¶…å‡ºæ·±åº¦æ—¶åˆ é™¤æ—§ä»»åŠ¡
    if (history.size() > m_historyDepth) {
        QStringList toRemove = history.mid(m_historyDepth);
        history = history.mid(0, m_historyDepth);

        // å¯é€‰ï¼šåˆ é™¤è¶…å‡ºæ·±åº¦çš„ä¸»å­˜å‚¨
        for (const QString& oldTaskId : toRemove) {
            QString oldKey = OutputKeys::byTask(algorithm, oldTaskId);
            remove(oldKey);
        }
    }

    setValue(historyKey, history);

    qInfo() << "[AlgorithmContext] ä¿å­˜ç»“æœ:"
            << "taskId=" << taskId
            << "algorithm=" << algorithm
            << "curveId=" << parentCurveId
            << "å†å²æ·±åº¦=" << history.size();
}
```

**`latestResult()` å®ç°é€»è¾‘**:
```cpp
std::optional<AlgorithmResult> AlgorithmContext::latestResult(
    const QString& algorithm,
    const QString& curveId) const
{
    // 1. è¯»å–æœ€æ–°ä»»åŠ¡IDæŒ‡é’ˆ
    QString latestKey = OutputKeys::latestTaskId(algorithm, curveId);
    auto taskIdOpt = get<QString>(latestKey);

    if (!taskIdOpt.has_value() || taskIdOpt.value().isEmpty()) {
        return std::nullopt;
    }

    // 2. å±•å¼€ taskId â†’ è¯»å–ä¸»å­˜å‚¨
    QString taskId = taskIdOpt.value();
    QString taskKey = OutputKeys::byTask(algorithm, taskId);

    return get<AlgorithmResult>(taskKey);
}
```

**`historyResults()` å®ç°é€»è¾‘**:
```cpp
QVector<AlgorithmResult> AlgorithmContext::historyResults(
    const QString& algorithm,
    const QString& curveId,
    int limit) const
{
    // 1. è¯»å–å†å²ä»»åŠ¡IDé˜Ÿåˆ—
    QString historyKey = OutputKeys::historyTaskIds(algorithm, curveId);
    auto historyOpt = get<QStringList>(historyKey);

    if (!historyOpt.has_value()) {
        return QVector<AlgorithmResult>();
    }

    QStringList taskIds = historyOpt.value();

    // 2. é™åˆ¶è¿”å›æ•°é‡
    if (limit > 0 && taskIds.size() > limit) {
        taskIds = taskIds.mid(0, limit);
    }

    // 3. å±•å¼€ taskId åˆ—è¡¨ â†’ è¯»å–ä¸»å­˜å‚¨
    QVector<AlgorithmResult> results;
    for (const QString& taskId : taskIds) {
        QString taskKey = OutputKeys::byTask(algorithm, taskId);
        auto resultOpt = get<AlgorithmResult>(taskKey);

        if (resultOpt.has_value()) {
            results.append(resultOpt.value());
        }
    }

    return results;
}
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•å¹¶å‘ä¿å­˜
context->saveResult("task-001", "differentiation", "curve-123", result1);
context->saveResult("task-002", "differentiation", "curve-123", result2);
context->saveResult("task-003", "differentiation", "curve-123", result3);

// éªŒè¯æœ€æ–°ç»“æœ
auto latest = context->latestResult("differentiation", "curve-123");
QVERIFY(latest.has_value());
QCOMPARE(latest->algorithmKey(), "differentiation");

// éªŒè¯å†å²ç»“æœ
auto history = context->historyResults("differentiation", "curve-123");
QCOMPARE(history.size(), 3);

// éªŒè¯æŒ‰æ—¶é—´å€’åºï¼š[result3, result2, result1]
```

**LRU è£å‰ªæµ‹è¯•**:
```cpp
context->setHistoryDepth(3);

// æ‰§è¡Œ 5 æ¬¡
for (int i = 0; i < 5; ++i) {
    QString taskId = QString("task-%1").arg(i);
    context->saveResult(taskId, "differentiation", "curve-123", result);
}

auto history = context->historyResults("differentiation", "curve-123");
QCOMPARE(history.size(), 3);  // åªä¿ç•™æœ€è¿‘ 3 æ¬¡
```

---

## ğŸ¯ é˜¶æ®µ2: åè°ƒå±‚

### ä»»åŠ¡2.1: AlgorithmCoordinator ä¿¡å·æœºåˆ¶é‡æ„ â¸ï¸ å¾…å¼€å§‹

**æ–‡ä»¶**:
- `Analysis/src/application/algorithm/algorithm_coordinator.h`
- `Analysis/src/application/algorithm/algorithm_coordinator.cpp`

**æ”¹åŠ¨æ¸…å•**:

**åˆ é™¤**:
- [ ] åˆ é™¤ `saveResultToContext()` æ–¹æ³•ï¼ˆå¤´æ–‡ä»¶ ~254è¡Œï¼Œcpp ~95-108è¡Œï¼‰
- [ ] åˆ é™¤ `onAlgorithmResultReady()` æ§½å‡½æ•°ï¼ˆcpp ~110-115è¡Œï¼‰
- [ ] åˆ é™¤ `algorithmSucceeded(QString)` ä¿¡å·ï¼ˆå¤´æ–‡ä»¶ ~122è¡Œï¼‰

**æ–°å¢**:
- [ ] æ–°å¢ `algorithmCompleted(taskId, algorithmName, parentCurveId, result)` ä¿¡å·
- [ ] æ–°å¢ `WorkflowStatus` æšä¸¾ï¼ˆIdle, Running, Completed, Failed, Cancelledï¼‰
- [ ] æ–°å¢ `PendingWorkflow` ç»“æ„ä½“ï¼ˆç±»å†…ç§æœ‰ï¼‰
- [ ] æ–°å¢ `runWorkflow(steps, curveIds)` æ–¹æ³•
- [ ] æ–°å¢ `cancelWorkflow(workflowId)` æ–¹æ³•
- [ ] æ–°å¢ `advanceWorkflow(taskId, algorithmName, result)` ç§æœ‰æ–¹æ³•
- [ ] æ–°å¢ `workflowCompleted(workflowId, outputCurveIds)` ä¿¡å·
- [ ] æ–°å¢ `workflowFailed(workflowId, errorMessage)` ä¿¡å·

**ä¿®æ”¹**:
- [ ] é‡å‘½å `onAlgorithmResultReady()` â†’ `onSyncAlgorithmResultReady()`
- [ ] ä¿®æ”¹ `onSyncAlgorithmResultReady()` å®ç°ï¼š
  - ç”Ÿæˆ taskId = `{algorithmName}-{timestamp}-{uuid}`
  - è°ƒç”¨ `context->saveResult(taskId, algorithmName, parentCurveId, result)`
  - å‘å°„ `algorithmCompleted(taskId, algorithmName, parentCurveId, result)`
  - è°ƒç”¨ `advanceWorkflow(taskId, algorithmName, result)`
- [ ] ä¿®æ”¹ `onAsyncAlgorithmFinished()` å®ç°ï¼ˆå¤´æ–‡ä»¶ ~155è¡Œï¼Œcpp ~149-167è¡Œï¼‰ï¼š
  - è°ƒç”¨ `context->saveResult(taskId, algorithmName, parentCurveId, result)`
  - åˆ é™¤ `emit algorithmSucceeded(algorithmName)`
  - å‘å°„ `algorithmCompleted(taskId, algorithmName, parentCurveId, result)`
  - è°ƒç”¨ `advanceWorkflow(taskId, algorithmName, result)`

**PendingWorkflow ç»“æ„å®šä¹‰**:
```cpp
struct PendingWorkflow {
    QString id;                         // å·¥ä½œæµå®ä¾‹ID
    QStringList steps;                  // ç®—æ³•æ­¥éª¤åˆ—è¡¨
    int currentStepIndex = 0;           // å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ æ­¥
    QStringList inputCurveIds;          // åˆå§‹è¾“å…¥æ›²çº¿
    QHash<int, QStringList> stepOutputs; // æ¯æ­¥çš„è¾“å‡ºæ›²çº¿ID
    WorkflowStatus status = WorkflowStatus::Idle;
    QString errorMessage;
};
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•å•æ¬¡æ‰§è¡Œä¿¡å·
QSignalSpy spy(coordinator, &AlgorithmCoordinator::algorithmCompleted);
coordinator->executeAlgorithm("differentiation", "curve-001");
QCOMPARE(spy.count(), 1);

QList<QVariant> args = spy.takeFirst();
QCOMPARE(args.at(1).toString(), "differentiation");  // algorithmName
QCOMPARE(args.at(2).toString(), "curve-001");        // parentCurveId
```

---

### ä»»åŠ¡2.2: å·¥ä½œæµå®ç° â¸ï¸ å¾…å¼€å§‹

**æ”¹åŠ¨æ¸…å•**:
- [ ] å®ç° `runWorkflow(steps, curveIds)` æ–¹æ³•
  - ç”Ÿæˆå·¥ä½œæµ ID: `workflow-{timestamp}-{uuid}`
  - åˆå§‹åŒ– `PendingWorkflow` çŠ¶æ€
  - æ‰§è¡Œç¬¬ä¸€æ­¥ç®—æ³•
- [ ] å®ç° `advanceWorkflow(taskId, algorithmName, result)` æ–¹æ³•
  - æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨å·¥ä½œæµ
  - éªŒè¯ç®—æ³•ååŒ¹é…å½“å‰æ­¥éª¤
  - è®°å½•å½“å‰æ­¥éª¤è¾“å‡º
  - æ¨è¿›åˆ°ä¸‹ä¸€æ­¥æˆ–å®Œæˆå·¥ä½œæµ
- [ ] å®ç° `cancelWorkflow(workflowId)` æ–¹æ³•
  - æ ‡è®°çŠ¶æ€ä¸º Cancelled
  - æ¸…ç†å·¥ä½œæµçŠ¶æ€
  - å‘å°„ `workflowFailed` ä¿¡å·

**`advanceWorkflow()` å®ç°é€»è¾‘**:
```cpp
void AlgorithmCoordinator::advanceWorkflow(
    const QString& taskId,
    const QString& algorithmName,
    const AlgorithmResult& result)
{
    if (!m_currentWorkflow.has_value()) {
        return;  // æ— æ´»åŠ¨å·¥ä½œæµ
    }

    auto& wf = m_currentWorkflow.value();

    // éªŒè¯ç®—æ³•ååŒ¹é…å½“å‰æ­¥éª¤
    if (wf.currentStepIndex >= wf.steps.size()) {
        return;  // å·²è¶…å‡ºæ­¥éª¤èŒƒå›´
    }

    QString expectedAlgorithm = wf.steps[wf.currentStepIndex];
    if (algorithmName != expectedAlgorithm) {
        return;  // ç®—æ³•åä¸åŒ¹é…
    }

    // è®°å½•å½“å‰æ­¥éª¤çš„è¾“å‡ºæ›²çº¿ID
    QStringList outputCurveIds;
    if (result.hasCurves()) {
        for (const ThermalCurve& curve : result.curves()) {
            outputCurveIds.append(curve.id());
        }
    }
    wf.stepOutputs[wf.currentStepIndex] = outputCurveIds;

    // æ¨è¿›åˆ°ä¸‹ä¸€æ­¥
    wf.currentStepIndex++;

    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (wf.currentStepIndex >= wf.steps.size()) {
        // å·¥ä½œæµå®Œæˆ
        wf.status = WorkflowStatus::Completed;
        emit workflowCompleted(wf.id, wf.stepOutputs[wf.steps.size() - 1]);
        m_currentWorkflow.reset();
        qInfo() << "[AlgorithmCoordinator] å·¥ä½œæµå®Œæˆ:" << wf.id;
        return;
    }

    // æ‰§è¡Œä¸‹ä¸€æ­¥
    QString nextAlgorithm = wf.steps[wf.currentStepIndex];
    QString nextInputCurve = outputCurveIds.isEmpty() ? wf.inputCurveIds.first() : outputCurveIds.first();

    qInfo() << "[AlgorithmCoordinator] å·¥ä½œæµæ¨è¿›:"
            << "æ­¥éª¤" << (wf.currentStepIndex + 1) << "/" << wf.steps.size()
            << "ç®—æ³•=" << nextAlgorithm;

    executeAlgorithm(nextAlgorithm, nextInputCurve);
}
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•çº¿æ€§å·¥ä½œæµ
QSignalSpy completedSpy(coordinator, &AlgorithmCoordinator::workflowCompleted);

QString wfId = coordinator->runWorkflow(
    {"movingAverage", "differentiation"},
    {"curve-001"}
);

// ç­‰å¾…å·¥ä½œæµå®Œæˆ
QVERIFY(completedSpy.wait(5000));
QCOMPARE(completedSpy.count(), 1);

QList<QVariant> args = completedSpy.takeFirst();
QCOMPARE(args.at(0).toString(), wfId);

// éªŒè¯ç”Ÿæˆäº†ä¸¤æ¡æ›²çº¿ï¼ˆå¹³æ»‘ + å¾®åˆ†ï¼‰
QStringList outputs = args.at(1).toStringList();
QCOMPARE(outputs.size(), 1);  // æœ€ç»ˆè¾“å‡ºæ˜¯å¾®åˆ†æ›²çº¿
```

---

## ğŸ¯ é˜¶æ®µ3: ç®—æ³•å¢å¼º

### ä»»åŠ¡3.1: AlgorithmDescriptor ä¾èµ–å£°æ˜ â¸ï¸ å¾…å¼€å§‹

**æ–‡ä»¶**: æ‰€æœ‰ç®—æ³•å®ç°ï¼ˆ5ä¸ªï¼‰

**æ”¹åŠ¨æ¸…å•**:
- [ ] **DifferentiationAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}`
- [ ] **IntegrationAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}`
- [ ] **MovingAverageFilterAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}`
- [ ] **BaselineCorrectionAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve, ContextKeys::SelectedPoints}`
  - `produces = {"curve"}`
- [ ] **PeakAreaAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve, ContextKeys::SelectedPoints}`
  - `produces = {"markers", "scalar", "region"}`

**è¯´æ˜**:
- `prerequisites`: ä½¿ç”¨ `ContextKeys` å¸¸é‡ï¼Œè¡¨ç¤ºç®—æ³•æ‰§è¡Œå‰å¿…é¡»å­˜åœ¨çš„ä¸Šä¸‹æ–‡æ•°æ®
- `produces`: ç»“æœç±»å‹å¥‘çº¦ï¼ˆå¦‚ `"curve"`, `"markers"`, `"scalar"`ï¼‰

**éªŒæ”¶æ ‡å‡†**:
```cpp
auto desc = algorithm->descriptor();
QVERIFY(!desc.prerequisites.isEmpty());
QVERIFY(!desc.produces.isEmpty());

// éªŒè¯ prerequisites ä½¿ç”¨ ContextKeys
QCOMPARE(desc.prerequisites.first(), ContextKeys::ActiveCurve);
```

---

### ä»»åŠ¡3.2: ä¾èµ–æ ¡éªŒå®ç° â¸ï¸ å¾…å¼€å§‹

**æ–‡ä»¶**: `algorithm_coordinator.cpp`

**æ”¹åŠ¨æ¸…å•**:
- [ ] æ–°å¢ `checkPrerequisites(algorithmName)` ç§æœ‰æ–¹æ³•
- [ ] åœ¨ `executeAlgorithm()` å‰è°ƒç”¨æ ¡éªŒ
- [ ] ç¼ºå¤±ä¾èµ–æ—¶å‘å‡º `showMessage` ä¿¡å·

**`checkPrerequisites()` å®ç°é€»è¾‘**:
```cpp
bool AlgorithmCoordinator::checkPrerequisites(const QString& algorithmName)
{
    auto algorithm = m_algorithmManager->getAlgorithm(algorithmName);
    if (!algorithm) {
        qWarning() << "[AlgorithmCoordinator] ç®—æ³•ä¸å­˜åœ¨:" << algorithmName;
        return false;
    }

    AlgorithmDescriptor desc = algorithm->descriptor();

    for (const QString& prereq : desc.prerequisites) {
        if (!m_context->contains(prereq)) {
            QString msg = QString("ç®—æ³• '%1' ç¼ºå°‘å‰ç½®ä¾èµ–: %2")
                         .arg(desc.displayName)
                         .arg(prereq);
            qWarning() << "[AlgorithmCoordinator]" << msg;
            emit showMessage(msg);
            return false;
        }
    }

    return true;
}
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•ä¾èµ–æ ¡éªŒ
curveManager->clearAll();  // æ¸…ç©ºæ›²çº¿

bool canRun = coordinator->checkPrerequisites("differentiation");
QVERIFY(!canRun);  // ç¼ºå°‘ activeCurve

curveManager->addCurve(curve);
curveManager->setActiveCurve("curve-001");

canRun = coordinator->checkPrerequisites("differentiation");
QVERIFY(canRun);  // ä¾èµ–æ»¡è¶³
```

---

## ğŸ¯ é˜¶æ®µ4: UIå±‚è°ƒæ•´

### ä»»åŠ¡4.1: MainController ä¿¡å·è¿æ¥ â¸ï¸ å¾…å¼€å§‹

**æ–‡ä»¶**:
- `Analysis/src/ui/controller/main_controller.h`
- `Analysis/src/ui/controller/main_controller.cpp`

**æ”¹åŠ¨æ¸…å•**:

**åˆ é™¤**:
- [ ] åˆ é™¤ `onCoordinatorAlgorithmSucceeded()` æ§½å‡½æ•°ï¼ˆcpp ~476-485è¡Œï¼‰
- [ ] åˆ é™¤ `algorithmSucceeded` ä¿¡å·çš„ connect è¯­å¥ï¼ˆcpp ~165-198è¡Œï¼‰

**æ–°å¢**:
- [ ] æ–°å¢ `onAlgorithmCompleted(taskId, algorithmName, parentCurveId, result)` æ§½å‡½æ•°
- [ ] æ–°å¢ `onWorkflowCompleted(workflowId, outputCurveIds)` æ§½å‡½æ•°
- [ ] æ–°å¢ `onWorkflowFailed(workflowId, errorMessage)` æ§½å‡½æ•°
- [ ] è¿æ¥ `algorithmCompleted` ä¿¡å·
- [ ] è¿æ¥ `workflowCompleted` ä¿¡å·
- [ ] è¿æ¥ `workflowFailed` ä¿¡å·

**`onAlgorithmCompleted()` å®ç°**:
```cpp
void MainController::onAlgorithmCompleted(
    const QString& taskId,
    const QString& algorithmName,
    const QString& parentCurveId,
    const AlgorithmResult& result)
{
    Q_ASSERT(m_initialized);

    qInfo() << "ç®—æ³•æ‰§è¡Œå®Œæˆ:" << algorithmName
            << "taskId:" << taskId
            << "æºæ›²çº¿:" << parentCurveId
            << "ç»“æœç±»å‹:" << static_cast<int>(result.type());

    cleanupProgressDialog();
    m_currentTaskId.clear();
    m_currentAlgorithmName.clear();

    // å¯é€‰ï¼šè‡ªåŠ¨åŒ–å·¥ä½œæµå†³ç­–
    // if (algorithmName == "differentiation") {
    //     QString dtgCurveId = result.outputCurveIds().first();
    //     m_algorithmCoordinator->executeAlgorithm("peakDetection", dtgCurveId);
    // }
}
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•ä¿¡å·è¿æ¥
QSignalSpy spy(controller, SIGNAL(/* å†…éƒ¨ä¿¡å· */));
coordinator->executeAlgorithm("differentiation", "curve-001");
// éªŒè¯ controller çš„æ§½å‡½æ•°è¢«è°ƒç”¨
```

---

### ä»»åŠ¡4.2: ChartView åŒºåŸŸå åŠ èƒ½åŠ›ç¡®è®¤ â¸ï¸ å¾…å¼€å§‹

**æ”¹åŠ¨æ¸…å•**:
- [ ] æ£€æŸ¥ `ChartView` æ˜¯å¦å·²æœ‰ `onRegionsGenerated()` æ§½å‡½æ•°
- [ ] æ£€æŸ¥ `ThermalChart` æ˜¯å¦å·²æœ‰åŒºåŸŸå åŠ æ–¹æ³•ï¼ˆå¦‚ `addCurveRegions()`ï¼‰
- [ ] è‹¥æœªå®ç°ï¼Œåˆ™éœ€è¡¥å……æœ€å°å¯ç”¨ API

**å¦‚æœéœ€è¦å®ç°**:

**ChartView æ–°å¢**:
```cpp
class ChartView : public QWidget {
public slots:
    void onRegionsGenerated(const QString& curveId,
                           const QVector<RegionData>& regions);
};
```

**ThermalChart æ–°å¢**:
```cpp
class ThermalChart : public QChart {
public:
    void addCurveRegions(const QString& curveId,
                        const QVector<RegionData>& regions);
    void clearCurveRegions(const QString& curveId);
    void clearAllRegions();

private:
    QHash<QString, QVector<QGraphicsPolygonItem*>> m_curveRegions;
};
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•åŒºåŸŸæ·»åŠ 
QVector<RegionData> regions;
RegionData region;
region.polygon = QPolygonF({QPointF(100, 0), QPointF(200, 0),
                            QPointF(200, 10), QPointF(100, 5)});
region.fillColor = QColor(255, 0, 0, 80);
region.label = "å³°é¢ç§¯: 123.45 J/g";
regions.append(region);

chartView->onRegionsGenerated("curve-001", regions);

// éªŒè¯åŒºåŸŸå·²æ·»åŠ åˆ°å›¾è¡¨
QVERIFY(chart->curveRegions("curve-001").size() == 1);

// éªŒè¯åŒºåŸŸéšæ›²çº¿åˆ é™¤
curveManager->removeCurve("curve-001");
QVERIFY(chart->curveRegions("curve-001").isEmpty());
```

---

## ğŸ¯ é˜¶æ®µ5: æ¸…ç†æ—§ä»£ç 

### ä»»åŠ¡5.1: æ¸…ç† Context ä¸­çš„æ—§æ•°æ® â¸ï¸ å¾…å¼€å§‹

**æ”¹åŠ¨æ¸…å•**:
- [ ] æœç´¢å¹¶åˆ é™¤æ‰€æœ‰ä½¿ç”¨ `OutputKeys::latestResult(algorithmName)` çš„ä»£ç 
- [ ] æœç´¢å¹¶åˆ é™¤æ‰€æœ‰ä½¿ç”¨ `OutputKeys::resultType(algorithmName)` çš„ä»£ç 
- [ ] æœç´¢ `get.*latestResult` ç¡®è®¤æ— é—ç•™è°ƒç”¨

**éªŒæ”¶å‘½ä»¤**:
```bash
# æœç´¢ç¡®è®¤
grep -r "latestResult" --include="*.cpp" --include="*.h" Analysis/src/
# åº”è¯¥åªåœ¨ algorithm_context.cpp çš„æ–°å®ç°ä¸­å‡ºç°

grep -r "resultType" --include="*.cpp" --include="*.h" Analysis/src/
# åº”è¯¥åªåœ¨ MetaKeys å‘½åç©ºé—´ä¸­å‡ºç°
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ¸…å•

### å•å…ƒæµ‹è¯•

- [ ] **æµ‹è¯•1**: å¹¶å‘æ‰§è¡Œï¼ˆæ— è¦†ç›–ï¼‰
- [ ] **æµ‹è¯•2**: LRU è£å‰ª
- [ ] **æµ‹è¯•3**: å·¥ä½œæµæ‰§è¡Œ
- [ ] **æµ‹è¯•4**: ä¾èµ–æ ¡éªŒ

### é›†æˆæµ‹è¯•

- [ ] **æµ‹è¯•5**: ç«¯åˆ°ç«¯å·¥ä½œæµ

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] **å¹¶å‘æ‰§è¡Œ**: åŒæ—¶æ‰§è¡Œ 3 æ¬¡å¾®åˆ†ï¼Œç»“æœäº’ä¸è¦†ç›–
- [ ] **å†å²æŸ¥è¯¢**: å¯ä»¥æŸ¥è¯¢æŸæ¡æ›²çº¿æŸç®—æ³•çš„æœ€è¿‘ 20 æ¬¡æ‰§è¡Œ
- [ ] **LRU è£å‰ª**: æ‰§è¡Œ 25 æ¬¡ååªä¿ç•™æœ€è¿‘ 20 æ¬¡
- [ ] **å·¥ä½œæµæ‰§è¡Œ**: æˆåŠŸæ‰§è¡Œ 2-3 æ­¥çº¿æ€§å·¥ä½œæµ
- [ ] **å·¥ä½œæµå–æ¶ˆ**: å¯ä»¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å–æ¶ˆ
- [ ] **ä¾èµ–æ ¡éªŒ**: ç¼ºå°‘å‰ç½®ä¾èµ–æ—¶æç¤ºé”™è¯¯
- [ ] **ä¿¡å·æœºåˆ¶**: æ‰€æœ‰ç®—æ³•å®Œæˆæ—¶å‘å°„ `algorithmCompleted` ä¿¡å·

### ä»£ç è´¨é‡éªŒæ”¶

- [ ] **æ— ç¼–è¯‘è­¦å‘Š**: ç¼–è¯‘æ—¶æ—  warning
- [ ] **æ— æ—§ä»£ç æ®‹ç•™**: æœç´¢ç¡®è®¤æ—  `algorithmSucceeded`/æ—§ `latestResult`
- [ ] **æ— ç¡¬ç¼–ç é”®å**: æ‰€æœ‰ Context è®¿é—®ä½¿ç”¨ OutputKeys
- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–**: æ ¸å¿ƒæ–¹æ³•æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] **é›†æˆæµ‹è¯•é€šè¿‡**: ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•é€šè¿‡

### æ€§èƒ½éªŒæ”¶

- [ ] **å­˜å‚¨æ€§èƒ½**: 1000 æ¬¡æ‰§è¡Œçš„ä¿å­˜æ—¶é—´ < 100ms
- [ ] **æŸ¥è¯¢æ€§èƒ½**: å†å²æŸ¥è¯¢ï¼ˆ10æ¡ï¼‰æ—¶é—´ < 10ms
- [ ] **å·¥ä½œæµå»¶è¿Ÿ**: 3æ­¥å·¥ä½œæµçš„æ€»å¼€é”€ < 50msï¼ˆä¸å«ç®—æ³•æ‰§è¡Œï¼‰

---

## ğŸ“Š è¿›åº¦è¿½è¸ª

| æ—¥æœŸ | å®Œæˆä»»åŠ¡ | å¤‡æ³¨ |
|------|---------|------|
| 2025-11-19 | ä»»åŠ¡1.1: OutputKeys å¢å¼º | âœ… å·²å®Œæˆ |
| 2025-11-19 | ä»»åŠ¡1.2: AlgorithmContext ç»“æœå­˜å–å°è£… | âœ… å·²å®Œæˆ |
| 2025-11-19 | é˜¶æ®µ1: åŸºç¡€è®¾æ–½å±‚ | âœ… å…¨éƒ¨å®Œæˆ |

---

## ğŸš¨ é£é™©æ¸…å•

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| ä¿¡å·è¿æ¥é—æ¼ | ä¸­ | é«˜ | ç¼–è¯‘æ—¶æœç´¢æ‰€æœ‰ `algorithmSucceeded` ç¡®è®¤åˆ é™¤å¹²å‡€ |
| Context é”®åå†²çª | ä½ | ä¸­ | ä½¿ç”¨ OutputKeys ç»Ÿä¸€ç”Ÿæˆï¼Œé¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸² |
| å·¥ä½œæµçŠ¶æ€æ··ä¹± | ä¸­ | ä¸­ | å•å®ä¾‹é™åˆ¶ï¼Œæ·»åŠ çŠ¶æ€æ—¥å¿—ï¼Œå•å…ƒæµ‹è¯•è¦†ç›– |
| LRU è£å‰ªä¸¢å¤±é‡è¦æ•°æ® | ä½ | ä½ | é…ç½®å¯è°ƒï¼ˆé»˜è®¤20ï¼‰ï¼Œå…³é”®ä»»åŠ¡ä¸è£å‰ª |

---

**æœ€åæ›´æ–°**: 2025-11-19
