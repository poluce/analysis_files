# 外推温度功能说明（v2.0 - 支持基线曲线）

## 功能概述

**外推温度算法**用于计算热分析曲线的 **Onset（起始温度）** 或 **Endset（结束温度）**，这是热分析中确定反应起始/结束点的标准方法。

**v2.0 新特性**：✨ 支持引用已有的基线曲线，提供更精确的外推计算。

## 使用方法

### 完整工作流程

#### 1. **绘制基线**（必需步骤）
- 先使用"**基线校正**"功能绘制基线曲线
- 基线会作为当前曲线的子曲线自动添加

#### 2. **选择主曲线**
- 在项目浏览器中选择主曲线（原始数据）
- 确保基线曲线已经绘制（显示为子曲线）

#### 3. **启动外推温度工具**
- 点击工具栏上的"**外推温度**"按钮

#### 4. **选择切线区域**
系统会提示：**"请选择2个点定义切线区域（峰的前沿或后沿）"**

- **第1-2个点**：在曲线的前沿或后沿选择，用于拟合切线
  - 建议选择斜率变化明显的区域
  - 两个点之间应有足够的数据点（至少 10 个以上）
  - 对于 Onset 温度：选择反应开始的下降段
  - 对于 Endset 温度：选择反应结束的平稳段

#### 5. **自动计算外推温度**
- 算法自动查找关联的基线曲线
- 拟合切线
- 计算切线与基线曲线的交点
- 显示外推温度结果

### 查看结果

算法会自动显示：

1. **外推点标注**（红色）：切线与基线曲线的交点
2. **切线可视化**：拟合的切线（延伸显示）
3. **数值标签**：外推温度数值（浮动标签）
4. **辅助标注**：切线起点、终点

## 算法原理

### 核心步骤

1. **查找基线曲线**：
   - 自动在当前曲线的子曲线中查找 `SignalType::Baseline` 的曲线
   - 如果没有找到，提示用户先绘制基线

2. **验证峰范围**：
   - 检查用户选择的切线区域是否在基线覆盖的温度范围内
   - 如果超出范围，提示错误

3. **最小二乘法拟合切线**：
   ```
   y = k * x + b
   ```
   - 提取用户选择的温度范围内的所有数据点
   - 使用最小二乘法计算斜率 k 和截距 b

4. **计算交点**：
   - 切线方程：`y_tangent = k * x + b`
   - 基线曲线：`y_baseline = getBaselineYAtTemperature(x)`（线性插值）
   - 交点条件：`|y_tangent - y_baseline| < ε`（迭代搜索）
   - 外推温度：找到最小距离对应的 x 坐标

### 交点计算算法

使用**迭代搜索法**查找切线与基线曲线的交点：

```cpp
for (double temp = baselineMinTemp; temp <= baselineMaxTemp; temp += 0.1) {
    double yTangent = slope * temp + intercept;
    double yBaseline = getBaselineYAtTemperature(baselineData, temp);
    double distance = |yTangent - yBaseline|;

    if (distance < epsilon) {
        // 找到交点
        return temp;
    }
}
```

- **搜索步长**：0.1°C
- **精度阈值**：0.001
- **容差**：如果没有精确交点，返回最接近的点（误差 < 0.1）

### 适用场景

- **TGA（热重分析）**：
  - 计算分解起始温度
  - 计算分解结束温度

- **DSC（差示扫描量热）**：
  - 计算熔融起始温度
  - 计算结晶起始温度
  - 计算玻璃化转变温度

- **ARC（加速量热仪）**：
  - 计算反应起始温度

## 注意事项

### 1. 关于基线曲线（重要！）

**必需步骤**：
- ✅ 使用前**必须先绘制基线曲线**
- ✅ 基线曲线会自动作为子曲线添加到主曲线下
- ✅ 算法会自动查找并使用关联的基线曲线

**错误处理**：
- ❌ 如果没有基线曲线 → 提示："未找到基线曲线，请先使用'基线校正'功能绘制基线"
- ❌ 如果峰范围超出基线范围 → 提示："峰范围 [T1, T2] 超出基线范围，请在基线覆盖的温度区域内选择"

### 2. 切线区域选择

- ✅ **推荐**：选择斜率稳定、变化显著的区域
- ✅ **推荐**：选择的温度范围在基线覆盖区域内
- ❌ **避免**：选择噪声较大或曲率变化剧烈的区域
- ❌ **避免**：选择超出基线温度范围的区域

### 3. 点选顺序

可以任意顺序选择2个点，算法会自动按温度排序。

### 4. 基线类型

支持所有类型的基线曲线：
- 水平基线（常数基线）
- 线性基线（一阶基线）
- 多项式基线（高阶基线）
- 自定义基线

算法通过**线性插值**获取基线曲线在任意温度的 Y 值，因此支持任意形状的基线。

## 技术实现

### 文件位置

- **算法实现**：
  - `Analysis/src/infrastructure/algorithm/temperature_extrapolation_algorithm.h`
  - `Analysis/src/infrastructure/algorithm/temperature_extrapolation_algorithm.cpp`

- **算法注册**：
  - `Analysis/src/application/application_context.cpp`

- **UI 集成**：
  - `Analysis/src/ui/main_window.cpp`

- **上下文管理**：
  - `Analysis/src/application/algorithm/algorithm_manager.cpp`

### 算法特性

- **算法类型**：B 类算法（交互式，需要用户选点）
- **输入类型**：`InputType::PointSelection`（需要选择2个点）
- **输出类型**：`OutputType::Annotation`
- **结果类型**：`ResultType::Composite`（混合输出：标注点 + 切线 + 数值）

### 上下文驱动执行

算法采用**纯上下文驱动模式**：

```cpp
// 阶段1：验证数据完整性
bool prepareContext(AlgorithmContext* context) override {
    // 1. 验证活动曲线存在
    // 2. 验证基线曲线存在（自动查找）
    // 3. 验证选点数据（2个点）
}

// 阶段2：执行计算
AlgorithmResult executeWithContext(AlgorithmContext* context) override {
    // 1. 查找基线曲线
    // 2. 验证峰范围在基线范围内
    // 3. 拟合切线
    // 4. 计算与基线曲线的交点
    // 5. 返回结果
}
```

从上下文中拉取：
- `ContextKeys::ActiveCurve` - 活动曲线
- `ContextKeys::SelectedPoints` - 用户选择的2个点
- `"curveManager"` - CurveManager（用于查找基线曲线）

### 关键辅助函数

```cpp
// 查找基线曲线（在活动曲线的子曲线中查找 SignalType::Baseline）
bool findBaselineCurve(AlgorithmContext* context, ThermalCurve& baselineCurve);

// 获取基线曲线在指定温度的 Y 值（线性插值）
double getBaselineYAtTemperature(const QVector<ThermalDataPoint>& baselineData, double temperature);

// 验证峰范围是否在基线范围内
bool validatePeakRange(const QVector<ThermalDataPoint>& baselineData, double peakTemp1, double peakTemp2);

// 计算切线与基线曲线的交点（迭代搜索法）
bool calculateIntersectionWithBaseline(double slope, double intercept,
                                        const QVector<ThermalDataPoint>& baselineData,
                                        double searchRangeMin, double searchRangeMax,
                                        double& intersectionTemp);
```

## 示例结果

```
外推温度 = 350.25 °C

元数据：
- slope (斜率): -0.0123
- intercept (截距): 4.5678
- baselineCurveId: "{uuid}"
- baselineCurveName: "基线"
- 切线方程: y = -0.0123x + 4.5678
```

## 版本历史

### v2.0（当前版本）- 支持基线曲线
- ✅ 自动引用基线曲线（从子曲线中查找）
- ✅ 验证峰范围是否在基线范围内
- ✅ 迭代搜索法计算交点
- ✅ 线性插值获取基线Y值
- ✅ 只需选择2个点（简化操作）

### v1.0 - 初始版本
- ❌ 使用简化基线（单个点定义的水平线）
- ❌ 需要选择3个点（2个切线点 + 1个基线点）

## 未来改进

1. **参数对话框**：
   - 提供UI让用户手动选择基线曲线（如果有多条基线）
   - 设置交点搜索的精度和步长

2. **切线拟合优化**：
   - 提供多种拟合方法（线性、多项式）
   - 显示拟合质量指标（R²）
   - 支持手动调整拟合范围

3. **批量计算**：
   - 支持一次性计算多个外推点
   - 导出外推温度表格

4. **可视化增强**：
   - 切线可拖动调整
   - 实时显示拟合参数
   - 显示基线曲线高亮

## 参考文献

- ASTM E928: 热重分析中外推起始温度的标准测试方法
- ISO 11357-1: 差示扫描量热法中外推起始温度和结束温度的确定

---

**版本**: v2.0.0
**日期**: 2025-11-12
**作者**: Claude Code
