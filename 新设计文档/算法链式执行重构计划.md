# ç®—æ³•é“¾å¼æ‰§è¡Œé‡æ„è®¡åˆ’

**æ–‡æ¡£ç‰ˆæœ¬**: v1.2ï¼ˆæ ¹æ®æŠ€æœ¯æ¾„æ¸…å¾®è°ƒï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-11-19
**ä¿®è®¢æ—¥æœŸ**: 2025-11-19
**çŠ¶æ€**: æŠ€æœ¯ç»†èŠ‚å·²å®Œå–„ï¼Œå¾…å®æ–½
**ç­–ç•¥**: 0æ–°ç±»æ–¹æ¡ˆ - ä¸è€ƒè™‘å‘åå…¼å®¹ï¼Œç›´æ¥å…¨é¢åˆ‡æ¢

---

## ğŸ“Œ ç›®å½•

- [1. èƒŒæ™¯ä¸ç›®æ ‡](#1-èƒŒæ™¯ä¸ç›®æ ‡)
- [2. å½“å‰é—®é¢˜åˆ†æ](#2-å½“å‰é—®é¢˜åˆ†æ)
- [3. è®¾è®¡åŸåˆ™](#3-è®¾è®¡åŸåˆ™)
- [4. æŠ€æœ¯æ–¹æ¡ˆ](#4-æŠ€æœ¯æ–¹æ¡ˆ)
- [5. ä»£ç å®šä½ä¸è¡Œå·å¼•ç”¨](#5-ä»£ç å®šä½ä¸è¡Œå·å¼•ç”¨)
- [6. è¾¹ç•Œä¸å¼‚å¸¸å¤„ç†](#6-è¾¹ç•Œä¸å¼‚å¸¸å¤„ç†)
- [7. å®æ–½è®¡åˆ’](#7-å®æ–½è®¡åˆ’)
- [8. æµ‹è¯•éªŒè¯](#8-æµ‹è¯•éªŒè¯)
- [9. é£é™©è¯„ä¼°](#9-é£é™©è¯„ä¼°)
- [10. æ—¶é—´çº¿ä¼°ç®—](#10-æ—¶é—´çº¿ä¼°ç®—)

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯

å½“å‰ç®—æ³•æ‰§è¡Œæ¶æ„å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç»“æœäº¤ä»˜çš„"æœ€åä¸€å…¬é‡Œ"ä¸æ¸…æ™°**
   - AlgorithmManager ç›´æ¥æ“ä½œ CurveManagerï¼ˆè¶Šæƒï¼‰
   - AlgorithmCoordinator å°†ç»“æœå­˜å…¥ Contextï¼ˆæ— äººè¯»å–ï¼‰
   - MainController æ”¶åˆ°é€šçŸ¥åæ— å®é™…å¤„ç†ï¼ˆè´£ä»»ç¼ºå¤±ï¼‰

2. **ä¸æ”¯æŒç®—æ³•é“¾å¼æ‰§è¡Œ**
   - ä¿¡å·åªæºå¸¦ç®—æ³•åï¼ˆä¿¡æ¯ä¸è¶³ï¼‰
   - å¹¶å‘æ‰§è¡Œä¼šè¦†ç›–ç»“æœï¼ˆå­˜å‚¨ç¼ºé™·ï¼‰
   - æ— æ³•è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ­¥ç®—æ³•ï¼ˆç¼ºå°‘ç¼–æ’ï¼‰

3. **è®¾è®¡é¢„ç•™åŠŸèƒ½æœªæ¿€æ´»**
   - `AlgorithmDescriptor` çš„ `prerequisites/produces` å­—æ®µä»æœªä½¿ç”¨
   - `OutputKeys::latestResult()` å­˜å‚¨æœºåˆ¶æœ‰è¦†ç›–é—®é¢˜
   - Context ä¸­çš„ç»“æœæ— äººè¯»å–ï¼Œæˆä¸º"æ­»æ•°æ®"

### 1.2 ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**: åœ¨ä¸æ–°å¢ç±»çš„å‰æä¸‹ï¼Œå®ç°ç®—æ³•é“¾å¼æ‰§è¡Œèƒ½åŠ›ï¼ŒåŒæ—¶ä¿®å¤ç°æœ‰æ¶æ„é—®é¢˜ã€‚

**å…·ä½“ç›®æ ‡**:
- âœ… æ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªç®—æ³•ï¼Œç»“æœäº’ä¸è¦†ç›–
- âœ… æ”¯æŒå†å²ç»“æœæŸ¥è¯¢ï¼ˆæ¯æ¡æ›²çº¿ä¿ç•™æœ€è¿‘ N æ¬¡æ‰§è¡Œï¼‰
- âœ… æ”¯æŒçº¿æ€§å·¥ä½œæµï¼ˆè‡ªåŠ¨é“¾å¼æ‰§è¡Œå¤šä¸ªç®—æ³•ï¼‰
- âœ… å¼ºç±»å‹ä¿¡å·æœºåˆ¶ï¼ˆæºå¸¦å®Œæ•´ç»“æœä¿¡æ¯ï¼‰
- âœ… èŒè´£æ¸…æ™°ï¼ˆCoordinator ç¼–æ’ï¼ŒManager è½åœ°ï¼ŒController å†³ç­–ï¼‰

---

## 2. å½“å‰é—®é¢˜åˆ†æ

### 2.1 ä¿¡å·æœºåˆ¶é—®é¢˜

**ç°çŠ¶**:
```cpp
// AlgorithmCoordinator
emit algorithmSucceeded(const QString& algorithmName);  // åªæœ‰ç®—æ³•å
```

**é—®é¢˜**:
- âŒ æ— æ³•åŒºåˆ†å¹¶å‘ä»»åŠ¡ï¼ˆç¼ºå°‘ taskIdï¼‰
- âŒ ä¸çŸ¥é“æ˜¯å¯¹å“ªæ¡æ›²çº¿æ‰§è¡Œçš„ï¼ˆç¼ºå°‘ parentCurveIdï¼‰
- âŒ ä¸åŒ…å«ç»“æœæ•°æ®ï¼ˆç¼ºå°‘ AlgorithmResultï¼‰
- âŒ UI å¿…é¡»ä» Context è¯»å–ç»“æœï¼ˆè€¦åˆ OutputKeys å†…éƒ¨å®ç°ï¼‰

### 2.2 å­˜å‚¨æœºåˆ¶é—®é¢˜

**ç°çŠ¶**:
```cpp
// AlgorithmCoordinator::saveResultToContext
m_context->setValue(
    OutputKeys::latestResult(algorithmName),  // é”®å: result/{algorithm}/latest
    QVariant::fromValue(result)
);
```

**é—®é¢˜**:
- âŒ è¦†ç›–å¼å­˜å‚¨ï¼ˆåŒä¸€ç®—æ³•å¤šæ¬¡æ‰§è¡Œä¼šä¸¢å¤±å†å²ï¼‰
- âŒ å¹¶å‘æ‰§è¡Œç»“æœæ··ä¹±ï¼ˆæœ€åä¸€æ¬¡è¦†ç›–å‰é¢çš„ï¼‰
- âŒ æ— æ³•åŒºåˆ†ä¸åŒæ›²çº¿çš„ç»“æœï¼ˆé”®ä¸­ç¼ºå°‘ curveIdï¼‰

### 2.3 èŒè´£åˆ†æ•£é—®é¢˜

**ç°çŠ¶**:
```
AlgorithmManager::handleAlgorithmResult()
  â†’ AlgorithmManager::addCurveWithHistory()  // ç›´æ¥æ“ä½œ CurveManager

AlgorithmCoordinator::onAsyncAlgorithmFinished()
  â†’ saveResultToContext()  // ç¼“å­˜ç»“æœï¼ˆä½†æ— äººè¯»å–ï¼‰
  â†’ emit algorithmSucceeded(algorithmName)  // å¼±é€šçŸ¥

MainController::onCoordinatorAlgorithmSucceeded()
  â†’ cleanupProgressDialog()  // åªåšæ¸…ç†ï¼Œä¸å¤„ç†ç»“æœ
```

**é—®é¢˜**:
- âŒ Manager è¶Šæƒï¼ˆåº”ç”¨å±‚ç›´æ¥æ“ä½œé¢†åŸŸæ¨¡å‹ï¼‰
- âŒ Coordinator èŒè´£ä¸æ˜ï¼ˆç¼–æ’è¿˜æ˜¯ç¼“å­˜ï¼Ÿï¼‰
- âŒ Controller è´£ä»»ç¼ºå¤±ï¼ˆæ— æ³•ä¸»åŠ¨æ„ŸçŸ¥ç»“æœï¼‰

---

## 3. è®¾è®¡åŸåˆ™

### 3.1 æ ¸å¿ƒåŸåˆ™

1. **0æ–°ç±»åŸåˆ™**
   - ä¸å¼•å…¥ Repositoryã€ResultHandlerã€WorkflowManager ç­‰æ–°ç±»
   - ä»…åœ¨ç°æœ‰ç±»å†…å¢åŠ å°èŒƒå›´æ–¹æ³•ä¸ä¿¡å·
   - ä¿æŒæ¶æ„ç®€æ´ï¼Œé¿å…è¿‡åº¦è®¾è®¡

2. **å•ä¸€èŒè´£åŸåˆ™**
   - **AlgorithmManager**: ç»Ÿä¸€ç»“æœè½åœ°ï¼ˆæ›²çº¿â†’CurveManagerï¼Œæ ‡æ³¨â†’ä¿¡å·ï¼‰
   - **AlgorithmCoordinator**: æµç¨‹ç¼–æ’ä¸ç»“æœç¼“å­˜
   - **MainController**: å†³ç­–ä¸ UI äº¤äº’

3. **ä¿¡æ¯å®Œå¤‡åŸåˆ™**
   - ä¿¡å·å¿…é¡»æºå¸¦å®Œæ•´ä¿¡æ¯ï¼ˆtaskId, algorithmName, parentCurveId, resultï¼‰
   - é¿å…å¼ºåˆ¶ä¸‹æ¸¸è®¿é—® Context å†…éƒ¨å®ç°

4. **ä¸è¦†ç›–åŸåˆ™**
   - æŒ‰ taskId å­˜å‚¨ä¸»æ•°æ®ï¼ˆä¸å¯è¦†ç›–ï¼‰
   - æŒ‰ curveId ç»´æŠ¤ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰

### 3.2 æ¶æ„çº¦æŸ

- âœ… **Coordinator åªç¼–æ’ï¼Œä¸è½åœ°**: ç»“æœä¿å­˜åˆ° Contextï¼Œå‘å‡ºå®Œæˆä¿¡å·
- âœ… **Manager ç»Ÿä¸€è½åœ°**: æ›²çº¿æ·»åŠ åˆ° CurveManagerï¼Œæ ‡æ³¨/åŒºåŸŸå‘ä¸“ç”¨ä¿¡å·
- âœ… **UI è®¢é˜…æ¨¡å‹äº‹ä»¶**: é€šè¿‡ CurveManager å’Œä¸“ç”¨ä¿¡å·æ›´æ–°ï¼Œä¸è®¿é—® Context
- âœ… **Context ä»…ç”¨äºç¼“å­˜å’ŒæŸ¥è¯¢**: æ”¯æŒå†å²æŸ¥è¯¢å’Œç®—æ³•é“¾ä¾èµ–æ£€æŸ¥

---

## 4. æŠ€æœ¯æ–¹æ¡ˆ

### 4.1 é”®ç©ºé—´è®¾è®¡

**æ··åˆç´¢å¼•æ–¹æ¡ˆ**ï¼ˆtaskId ä¸»é”® + curveId ç´¢å¼•ï¼‰:

```
ä¸»å­˜å‚¨ï¼ˆä¸å¯è¦†ç›–ï¼Œä¾¿äºå†å²/å¹¶å‘ï¼‰ï¼š
  result/{algorithm}/byTask/{taskId} â†’ AlgorithmResult

æ›²çº¿ç´¢å¼•ï¼ˆå¿«é€Ÿå®šä½æœ€æ–°ä¸å†å²ï¼‰ï¼š
  result/{algorithm}/byCurve/{parentCurveId}/latestTaskId â†’ taskId
  result/{algorithm}/byCurve/{parentCurveId}/historyTaskIds â†’ [taskId1, taskId2, ...]
```

**ä¼˜åŠ¿**:
- âœ… ä¸ä¼šè¦†ç›–å†å²ï¼ˆtaskId ä¸»é”®ä¿è¯å”¯ä¸€æ€§ï¼‰
- âœ… å¹¶å‘å®‰å…¨ï¼ˆæ¯æ¬¡æ‰§è¡Œç‹¬ç«‹å­˜å‚¨ï¼‰
- âœ… å¿«é€ŸæŸ¥è¯¢ï¼ˆlatestTaskId æŒ‡é’ˆ O(1) å®šä½ï¼‰
- âœ… å¯æ§æ·±åº¦ï¼ˆhistoryTaskIds æ”¯æŒ LRU è£å‰ªï¼‰

### 4.2 ä¿¡å·æœºåˆ¶é‡æ„

**åˆ é™¤**:
```cpp
// æ—§ä¿¡å·ï¼ˆä¿¡æ¯ä¸è¶³ï¼‰
void algorithmSucceeded(const QString& algorithmName);
```

**æ–°å¢**:
```cpp
// å¼ºç±»å‹å®Œæˆä¿¡å·ï¼ˆå”¯ä¸€çš„ç»“æœé€šçŸ¥ä¿¡å·ï¼‰
void algorithmCompleted(const QString& taskId,
                       const QString& algorithmName,
                       const QString& parentCurveId,
                       const AlgorithmResult& result);
```

**ç»Ÿä¸€åŒæ­¥å’Œå¼‚æ­¥**:
- åŒæ­¥æ‰§è¡Œï¼šç”Ÿæˆ taskId = `{algorithmName}-{timestamp}-{uuid}` (ä½¿ç”¨ QUuid é¿å…ç¢°æ’)
- å¼‚æ­¥æ‰§è¡Œï¼šä½¿ç”¨ Worker è¿”å›çš„ taskId (åŒæ ·æ ¼å¼)
- ä¸¤è€…éƒ½å‘å°„åŒä¸€ä¸ª `algorithmCompleted` ä¿¡å·

### 4.3 è½»é‡çº§å·¥ä½œæµ

**åœ¨ AlgorithmCoordinator å†…éƒ¨å®ç°**ï¼ˆä¸æ–°å»ºç±»ï¼‰:

```cpp
// ç±»å†…å°ç»“æ„
struct PendingWorkflow {
    QString id;                         // å·¥ä½œæµå®ä¾‹ID
    QStringList steps;                  // ç®—æ³•æ­¥éª¤åˆ—è¡¨
    int currentStepIndex = 0;           // å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ æ­¥
    QStringList inputCurveIds;          // åˆå§‹è¾“å…¥æ›²çº¿
    QHash<int, QStringList> stepOutputs; // æ¯æ­¥çš„è¾“å‡ºæ›²çº¿ID
    WorkflowStatus status;
    QString errorMessage;
};

// æ–°å¢æ–¹æ³•
QString runWorkflow(const QStringList& steps, const QStringList& curveIds);
void cancelWorkflow(const QString& workflowId);

// æ–°å¢ä¿¡å·
void workflowCompleted(const QString& workflowId, const QStringList& outputCurveIds);
void workflowFailed(const QString& workflowId, const QString& errorMessage);
```

**ç‰¹æ€§**:
- âœ… ä»…æ”¯æŒçº¿æ€§æµç¨‹ï¼ˆä¸æ”¯æŒ DAGï¼‰
- âœ… å•å®ä¾‹æ‰§è¡Œï¼ˆä¸æ”¯æŒå¹¶å‘å·¥ä½œæµï¼‰
- âœ… è‡ªåŠ¨æ¨è¿›ï¼ˆç›‘å¬ algorithmCompleted ä¿¡å·ï¼‰
- âœ… æ”¯æŒå–æ¶ˆï¼ˆçŸ­è·¯åç»­æ­¥éª¤ï¼‰

### 4.4 API è½®å»“

#### OutputKeysï¼ˆæ–°å¢å‡½æ•°ï¼‰

```cpp
namespace OutputKeys {
    // åˆ é™¤æ—§å‡½æ•°
    // QString latestResult(const QString& algorithmName);
    // QString resultType(const QString& algorithmName);

    // æ–°å¢å‡½æ•°
    QString byTask(const QString& algorithm, const QString& taskId);
    QString latestTaskId(const QString& algorithm, const QString& curveId);
    QString historyTaskIds(const QString& algorithm, const QString& curveId);
}
```

#### AlgorithmContextï¼ˆæ–°å¢æ–¹æ³•ï¼‰

```cpp
class AlgorithmContext {
public:
    // æ–°å¢ï¼šç»“æœä¸“ç”¨ API
    void saveResult(const QString& taskId,
                   const QString& algorithm,
                   const QString& parentCurveId,
                   const AlgorithmResult& result);

    std::optional<AlgorithmResult> latestResult(const QString& algorithm,
                                                const QString& curveId) const;

    QVector<AlgorithmResult> historyResults(const QString& algorithm,
                                           const QString& curveId,
                                           int limit = 10) const;

    void setHistoryDepth(int depth);
    int historyDepth() const;

private:
    int m_historyDepth = 20;  // æ–°å¢æˆå‘˜ï¼ˆé»˜è®¤ä¿ç•™20æ¬¡å†å²ï¼‰
};
```

#### AlgorithmCoordinatorï¼ˆè°ƒæ•´ï¼‰

```cpp
class AlgorithmCoordinator {
public:
    // åˆ é™¤æ–¹æ³•
    // void saveResultToContext(const QString&, const AlgorithmResult&);

    // æ–°å¢ï¼šå·¥ä½œæµ
    enum class WorkflowStatus { Idle, Running, Completed, Failed, Cancelled };
    QString runWorkflow(const QStringList& steps, const QStringList& curveIds);
    void cancelWorkflow(const QString& workflowId);

signals:
    // åˆ é™¤ä¿¡å·
    // void algorithmSucceeded(const QString& algorithmName);

    // æ–°å¢ä¿¡å·
    void algorithmCompleted(const QString& taskId,
                           const QString& algorithmName,
                           const QString& parentCurveId,
                           const AlgorithmResult& result);

    void workflowCompleted(const QString& workflowId, const QStringList& outputCurveIds);
    void workflowFailed(const QString& workflowId, const QString& errorMessage);

private slots:
    // é‡å‘½åï¼ˆé¿å…æ··æ·†ï¼‰
    void onSyncAlgorithmResultReady(const QString&, const AlgorithmResult&);

private:
    struct PendingWorkflow { /*...*/ };
    std::optional<PendingWorkflow> m_currentWorkflow;

    void advanceWorkflow(const QString& taskId,
                        const QString& algorithmName,
                        const AlgorithmResult& result);
};
```

---

## 5. ä»£ç å®šä½ä¸è¡Œå·å¼•ç”¨

æ ¹æ®è¯„å®¡æ„è§ï¼Œæœ¬ç« èŠ‚æä¾›å…³é”®ä»£ç çš„ç²¾ç¡®å®šä½ï¼Œä¾¿äºå¿«é€Ÿå®šä½ä¿®æ”¹ç‚¹ã€‚

### 5.1 AlgorithmCoordinator ç›¸å…³

**æ–‡ä»¶**: `Analysis/src/application/algorithm/algorithm_coordinator.h`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| `algorithmSucceeded` ä¿¡å·å®šä¹‰ | ~122 | éœ€åˆ é™¤æ­¤æ—§ä¿¡å· |
| `onAsyncAlgorithmFinished` æ§½å£°æ˜ | ~155 | éœ€ä¿®æ”¹å®ç°ï¼Œå‘å°„æ–°ä¿¡å· |
| `saveResultToContext` æ–¹æ³•å£°æ˜ | ~254 | éœ€åˆ é™¤æ­¤æ–¹æ³• |

**æ–‡ä»¶**: `Analysis/src/application/algorithm/algorithm_coordinator.cpp`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| æ„é€ å‡½æ•°ä¿¡å·è¿æ¥ | ~32-44 | éœ€è°ƒæ•´è¿æ¥æ–°ä¿¡å· |
| `saveResultToContext` å®ç° | ~95-108 | éœ€åˆ é™¤æ•´ä¸ªæ–¹æ³• |
| `onAlgorithmResultReady` å®ç° | ~110-115 | éœ€åˆ é™¤/é‡å‘½åä¸º onSyncAlgorithmResultReady |
| `onAsyncAlgorithmFinished` å®ç° | ~149-167 | éœ€ä¿®æ”¹ï¼šè°ƒç”¨ saveResultï¼Œå‘å°„ algorithmCompleted |

### 5.2 OutputKeys ç›¸å…³

**æ–‡ä»¶**: `Analysis/src/domain/algorithm/algorithm_result.h`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| `OutputKeys` å‘½åç©ºé—´ | ~39-108 | éœ€æ–°å¢ byTask/latestTaskId/historyTaskIds |
| `latestResult` å‡½æ•° | ~66-68 | éœ€åˆ é™¤æ—§å‡½æ•° |
| `resultType` å‡½æ•° | ~73-76 | éœ€åˆ é™¤æ—§å‡½æ•° |

### 5.3 AlgorithmContext ç›¸å…³

**æ–‡ä»¶**: `Analysis/src/application/algorithm/algorithm_context.h`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| ç±»å®šä¹‰ | ~20+ | éœ€æ–°å¢ saveResult/latestResult/historyResults æ–¹æ³• |
| ç§æœ‰æˆå‘˜ | ç±»æœ«å°¾ | éœ€æ–°å¢ m_historyDepth æˆå‘˜ |

### 5.4 AlgorithmManager ç›¸å…³

**æ–‡ä»¶**: `Analysis/src/application/algorithm/algorithm_manager.h`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| `algorithmFinished` ä¿¡å· | ~81+ | å·²æœ‰å¼ºç±»å‹å®Œæˆä¿¡å·ï¼ŒCoordinator å¯å¤ç”¨ |
| `handleAlgorithmResult` | ~53+ | ä¿æŒç°çŠ¶ï¼Œç»Ÿä¸€è½åœ°é€»è¾‘ |

### 5.5 MainController ç›¸å…³

**æ–‡ä»¶**: `Analysis/src/ui/controller/main_controller.cpp`

| ä»£ç ä½ç½® | è¡Œå·ï¼ˆå‚è€ƒï¼‰ | è¯´æ˜ |
|---------|-------------|------|
| `setAlgorithmCoordinator` | ~165-198 | éœ€è°ƒæ•´ä¿¡å·è¿æ¥ |
| `onCoordinatorAlgorithmSucceeded` | ~476-485 | éœ€åˆ é™¤æ­¤æ§½å‡½æ•° |

---

## 6. è¾¹ç•Œä¸å¼‚å¸¸å¤„ç†

æ ¹æ®è¯„å®¡æ„è§ï¼Œè¡¥å……è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸åœºæ™¯çš„å¤„ç†ç­–ç•¥ã€‚

### 6.1 è¦†ç›–ç­–ç•¥

**è§„åˆ™**:
- âœ… **ä¸»å­˜å‚¨ï¼ˆbyTaskï¼‰**: æ°¸ä¸è¦†ç›–ï¼Œæ¯æ¬¡æ‰§è¡Œç‹¬ç«‹å­˜å‚¨
- âœ… **æœ€æ–°æŒ‡é’ˆï¼ˆlatestTaskIdï¼‰**: æ¯æ¬¡æ›´æ–°ä¸ºæœ€æ–°çš„ taskId
- âœ… **å†å²é˜Ÿåˆ—ï¼ˆhistoryTaskIdsï¼‰**: è¿½åŠ åˆ°é˜Ÿåˆ—å¤´éƒ¨ï¼Œè¶…å‡ºæ·±åº¦æ—¶ LRU è£å‰ª

**ç¤ºä¾‹**:
```cpp
// ç¬¬1æ¬¡æ‰§è¡Œ
saveResult("task-001", "differentiation", "curve-123", result1);
// byTask/task-001 â†’ result1
// latestTaskId â†’ "task-001"
// historyTaskIds â†’ ["task-001"]

// ç¬¬2æ¬¡æ‰§è¡Œ
saveResult("task-002", "differentiation", "curve-123", result2);
// byTask/task-001 â†’ result1  ï¼ˆä¸å˜ï¼‰
// byTask/task-002 â†’ result2  ï¼ˆæ–°å¢ï¼‰
// latestTaskId â†’ "task-002"  ï¼ˆè¦†ç›–æŒ‡é’ˆï¼‰
// historyTaskIds â†’ ["task-002", "task-001"]  ï¼ˆè¿½åŠ ï¼‰

// ç¬¬21æ¬¡æ‰§è¡Œï¼ˆè¶…å‡ºæ·±åº¦20ï¼‰
saveResult("task-021", "differentiation", "curve-123", result21);
// byTask/task-001 â†’ result1  ï¼ˆå¯é€‰ï¼šè¢«æ¸…ç†ï¼‰
// byTask/task-021 â†’ result21 ï¼ˆæ–°å¢ï¼‰
// latestTaskId â†’ "task-021"
// historyTaskIds â†’ ["task-021", "task-020", ..., "task-002"]  ï¼ˆè£å‰ªä¸º20ä¸ªï¼‰
```

### 6.2 å–æ¶ˆ/å¤±è´¥å¤„ç†

**åœºæ™¯1ï¼šç®—æ³•æ‰§è¡Œå¤±è´¥**

**ç­–ç•¥**:
```cpp
AlgorithmResult result = AlgorithmResult::failure("differentiation", "æ•°æ®ä¸è¶³");
// æ˜¯å¦å†™å…¥å­˜å‚¨ï¼Ÿ
// é€‰é¡¹Aï¼šä¸å†™å…¥ï¼ˆæ¨èï¼‰ - å¤±è´¥ç»“æœä¸è®¡å…¥å†å²
// é€‰é¡¹Bï¼šå†™å…¥ä½†æ ‡è®° isSuccess=false - ä¾¿äºè°ƒè¯•å’Œå®¡è®¡
```

**æ¨èæ–¹æ¡ˆ**: ä¸å†™å…¥ Contextï¼Œåªé€šè¿‡ `algorithmFailed` ä¿¡å·é€šçŸ¥ UI

**åœºæ™¯2ï¼šå·¥ä½œæµå–æ¶ˆ**

**ç­–ç•¥**:
```cpp
void AlgorithmCoordinator::cancelWorkflow(const QString& workflowId) {
    if (m_currentWorkflow && m_currentWorkflow->id == workflowId) {
        m_currentWorkflow->status = WorkflowStatus::Cancelled;

        // 1. æ˜¯å¦å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ç®—æ³•ï¼Ÿ
        // æ–¹æ¡ˆAï¼šç«‹å³ä¸­æ­¢ï¼ˆéœ€è¦ AlgorithmManager æ”¯æŒï¼‰
        // æ–¹æ¡ˆBï¼šç­‰å¾…å½“å‰æ­¥éª¤å®Œæˆï¼Œä¸æ‰§è¡Œåç»­æ­¥éª¤

        // 2. æ˜¯å¦ä¿ç•™å·²å®Œæˆæ­¥éª¤çš„ç»“æœï¼Ÿ
        // æ–¹æ¡ˆAï¼šä¿ç•™ï¼ˆæ¨èï¼‰ - ä¸­é—´ç»“æœå¯èƒ½æœ‰ç”¨
        // æ–¹æ¡ˆBï¼šå…¨éƒ¨åˆ é™¤ - ä¿æŒä¸€è‡´æ€§

        m_currentWorkflow.reset();
        emit workflowFailed(workflowId, "ç”¨æˆ·å–æ¶ˆ");
    }
}
```

**æ¨èæ–¹æ¡ˆ**:
- ç­‰å¾…å½“å‰æ­¥éª¤å®Œæˆï¼ˆæ–¹æ¡ˆBï¼‰
- ä¿ç•™å·²å®Œæˆæ­¥éª¤çš„ç»“æœï¼ˆæ–¹æ¡ˆAï¼‰
- å‘å°„ `workflowFailed` é€šçŸ¥ UI

### 6.3 Composite ç»“æœå¤„ç†

**åœºæ™¯**ï¼šå³°é¢ç§¯ç®—æ³•è¿”å›æ··åˆç»“æœï¼ˆæ›²çº¿ + æ•°å€¼ + æ ‡æ³¨ç‚¹ï¼‰

**å­˜å‚¨ç­–ç•¥**:
```cpp
AlgorithmResult result = AlgorithmResult::success("peakArea", "curve-001", ResultType::Composite);
result.addCurve(baselineCurve);  // åŸºçº¿æ›²çº¿
result.setArea(123.45, "J/g");   // å³°é¢ç§¯æ•°å€¼
result.addMarker(startPoint);    // èµ·ç‚¹æ ‡æ³¨

// Context å­˜å‚¨
context->saveResult(taskId, "peakArea", "curve-001", result);
// ç´¢å¼•é”®ä»ä»¥ parentCurveId ä¸ºä¸»
// latestTaskId(peakArea, curve-001) â†’ taskId
// å†å²é˜Ÿåˆ—æŒ‰ parentCurveId ç»´æŠ¤
```

**å…³é”®ç‚¹**:
- âœ… å®Œæ•´çš„ `AlgorithmResult` å¯¹è±¡ä¸€æ¬¡æ€§å­˜å‚¨
- âœ… ç´¢å¼•é”®ä½¿ç”¨ `parentCurveId`ï¼ˆè¾“å…¥æ›²çº¿ï¼‰ï¼Œä¸ä½¿ç”¨è¾“å‡ºæ›²çº¿
- âœ… å¦‚æœäº§ç”Ÿå¤šæ¡å­æ›²çº¿ï¼Œä¸æ”¹å˜ç´¢å¼•ç»´åº¦

### 6.4 å¹¶å‘å®‰å…¨

**åœºæ™¯**ï¼šåŒæ—¶å¯¹ 3 æ¡æ›²çº¿æ‰§è¡Œå¾®åˆ†

```cpp
// çº¿ç¨‹1
executeAsync("differentiation", "curve-001");  // taskId = "task-001"

// çº¿ç¨‹2
executeAsync("differentiation", "curve-002");  // taskId = "task-002"

// çº¿ç¨‹3
executeAsync("differentiation", "curve-003");  // taskId = "task-003"
```

**å¹¶å‘éš”ç¦»**:
```
ä¸»å­˜å‚¨ï¼ˆéš”ç¦»ï¼‰ï¼š
  byTask/task-001 â†’ result1
  byTask/task-002 â†’ result2
  byTask/task-003 â†’ result3

æ›²çº¿ç´¢å¼•ï¼ˆç‹¬ç«‹ï¼‰ï¼š
  byCurve/curve-001/latestTaskId â†’ "task-001"
  byCurve/curve-002/latestTaskId â†’ "task-002"
  byCurve/curve-003/latestTaskId â†’ "task-003"
```

**ä¿è¯**:
- âœ… taskId å…¨å±€å”¯ä¸€ï¼ˆæ—¶é—´æˆ³ + UUIDï¼‰
- âœ… ä¸åŒæ›²çº¿çš„ç´¢å¼•å®Œå…¨ç‹¬ç«‹
- âœ… AlgorithmContext çš„è¯»å†™åªåœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼›å·¥ä½œçº¿ç¨‹ä½¿ç”¨ AlgorithmTask çš„ä¸Šä¸‹æ–‡å¿«ç…§ï¼Œä¸å¹¶å‘è®¿é—®åŒä¸€å®ä¾‹

### 6.5 å·¥ä½œæµå¼‚å¸¸çŸ­è·¯

**åœºæ™¯**ï¼šå·¥ä½œæµç¬¬2æ­¥å¤±è´¥

```cpp
runWorkflow({"movingAverage", "differentiation", "peakDetection"}, {"curve-001"});

// æ­¥éª¤1ï¼šmovingAverage - æˆåŠŸ
// æ­¥éª¤2ï¼šdifferentiation - å¤±è´¥ï¼ˆæ•°æ®å¼‚å¸¸ï¼‰
// æ­¥éª¤3ï¼špeakDetection - ä¸æ‰§è¡Œ
```

**å¤„ç†ç­–ç•¥**:
```cpp
void AlgorithmCoordinator::onAlgorithmFailed(...) {
    if (!m_currentWorkflow.has_value()) {
        return;  // æ— æ´»åŠ¨å·¥ä½œæµ
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥ä½œæµä¸­çš„æ­¥éª¤
    QString expectedAlgorithm = m_currentWorkflow->steps[m_currentWorkflow->currentStepIndex];
    if (algorithmName == expectedAlgorithm) {
        // å·¥ä½œæµå¤±è´¥ï¼ŒçŸ­è·¯åç»­æ­¥éª¤
        m_currentWorkflow->status = WorkflowStatus::Failed;
        m_currentWorkflow->errorMessage = errorMessage;

        emit workflowFailed(m_currentWorkflow->id, errorMessage);
        m_currentWorkflow.reset();

        qWarning() << "[AlgorithmCoordinator] å·¥ä½œæµå¤±è´¥ï¼Œå·²çŸ­è·¯åç»­æ­¥éª¤";
    }
}
```

**å…³é”®ç‚¹**:
- âœ… ç«‹å³ç»ˆæ­¢å·¥ä½œæµ
- âœ… ä¿ç•™å·²å®Œæˆæ­¥éª¤çš„ç»“æœ
- âœ… å‘å°„ `workflowFailed` ä¿¡å·
- âœ… æ¸…ç†å·¥ä½œæµçŠ¶æ€

---

## 7. å®æ–½è®¡åˆ’

### é˜¶æ®µ 1: åŸºç¡€è®¾æ–½å±‚ï¼ˆæ— ä¾èµ–ï¼‰

#### 1.1 OutputKeys é”®ç”Ÿæˆå·¥å…·å¢å¼º

**æ–‡ä»¶**: `Analysis/src/domain/algorithm/algorithm_result.h`

**æ”¹åŠ¨æ¸…å•**:
- [ ] åˆ é™¤ `latestResult(algorithmName)` å‡½æ•°
- [ ] åˆ é™¤ `resultType(algorithmName)` å‡½æ•°
- [ ] æ–°å¢ `byTask(algorithm, taskId)` å‡½æ•°
- [ ] æ–°å¢ `latestTaskId(algorithm, curveId)` å‡½æ•°
- [ ] æ–°å¢ `historyTaskIds(algorithm, curveId)` å‡½æ•°

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•é”®ç”Ÿæˆ
QString key1 = OutputKeys::byTask("differentiation", "task-001");
QCOMPARE(key1, "result/differentiation/byTask/task-001");

QString key2 = OutputKeys::latestTaskId("differentiation", "curve-123");
QCOMPARE(key2, "result/differentiation/byCurve/curve-123/latestTaskId");
```

---

#### 1.2 AlgorithmContext ç»“æœå­˜å–å°è£…

**æ–‡ä»¶**:
- `Analysis/src/application/algorithm/algorithm_context.h`
- `Analysis/src/application/algorithm/algorithm_context.cpp`

**æ”¹åŠ¨æ¸…å•**:
- [ ] æ–°å¢ `m_historyDepth` æˆå‘˜å˜é‡ï¼ˆé»˜è®¤20ï¼‰
- [ ] æ–°å¢ `saveResult()` æ–¹æ³•ï¼ˆå®ç° LRU è£å‰ªï¼‰
- [ ] æ–°å¢ `latestResult()` æ–¹æ³•ï¼ˆè¯»å–æœ€æ–°æŒ‡é’ˆ â†’ å±•å¼€ taskIdï¼‰
- [ ] æ–°å¢ `historyResults()` æ–¹æ³•ï¼ˆè¯»å–å†å²é˜Ÿåˆ— â†’ å±•å¼€åˆ—è¡¨ï¼‰
- [ ] æ–°å¢ `setHistoryDepth()/historyDepth()` æ–¹æ³•

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•å¹¶å‘ä¿å­˜
context->saveResult("task-001", "differentiation", "curve-123", result1);
context->saveResult("task-002", "differentiation", "curve-123", result2);
context->saveResult("task-003", "differentiation", "curve-123", result3);

auto latest = context->latestResult("differentiation", "curve-123");
QVERIFY(latest.has_value());
QCOMPARE(latest->algorithmKey(), "differentiation");
// éªŒè¯æ˜¯ task-003 çš„ç»“æœ

auto history = context->historyResults("differentiation", "curve-123");
QCOMPARE(history.size(), 3);
// éªŒè¯æŒ‰æ—¶é—´å€’åºï¼š[result3, result2, result1]
```

**LRU è£å‰ªæµ‹è¯•**:
```cpp
context->setHistoryDepth(3);

// æ‰§è¡Œ 5 æ¬¡
for (int i = 0; i < 5; ++i) {
    QString taskId = QString("task-%1").arg(i);
    context->saveResult(taskId, "differentiation", "curve-123", result);
}

auto history = context->historyResults("differentiation", "curve-123");
QCOMPARE(history.size(), 3);  // åªä¿ç•™æœ€è¿‘ 3 æ¬¡
```

---

### é˜¶æ®µ 2: åè°ƒå±‚

#### 2.1 AlgorithmCoordinator ä¿¡å·æœºåˆ¶é‡æ„

**æ–‡ä»¶**:
- `Analysis/src/application/algorithm/algorithm_coordinator.h`
- `Analysis/src/application/algorithm/algorithm_coordinator.cpp`

**æ”¹åŠ¨æ¸…å•**:

**åˆ é™¤**:
- [ ] åˆ é™¤ `saveResultToContext()` æ–¹æ³•
- [ ] åˆ é™¤ `onAlgorithmResultReady()` æ§½å‡½æ•°
- [ ] åˆ é™¤ `algorithmSucceeded(QString)` ä¿¡å·

**æ–°å¢**:
- [ ] æ–°å¢ `algorithmCompleted(taskId, algorithmName, parentCurveId, result)` ä¿¡å·
- [ ] æ–°å¢ `WorkflowStatus` æšä¸¾
- [ ] æ–°å¢ `PendingWorkflow` ç»“æ„ä½“ï¼ˆç±»å†…ï¼‰
- [ ] æ–°å¢ `runWorkflow()` æ–¹æ³•
- [ ] æ–°å¢ `cancelWorkflow()` æ–¹æ³•
- [ ] æ–°å¢ `advanceWorkflow()` ç§æœ‰æ–¹æ³•
- [ ] æ–°å¢ `workflowCompleted()` ä¿¡å·
- [ ] æ–°å¢ `workflowFailed()` ä¿¡å·

**ä¿®æ”¹**:
- [ ] é‡å‘½å `onAlgorithmResultReady()` â†’ `onSyncAlgorithmResultReady()`
- [ ] ä¿®æ”¹ `onSyncAlgorithmResultReady()` å®ç°ï¼š
  - ç”Ÿæˆ taskIdï¼ˆç®—æ³•å + æ—¶é—´æˆ³ + UUIDï¼Œå¦‚ `differentiation-1700000000-{uuid}`ï¼‰
  - è°ƒç”¨ `context->saveResult()`
  - å‘å°„ `algorithmCompleted()`
  - è°ƒç”¨ `advanceWorkflow()`
- [ ] ä¿®æ”¹ `onAsyncAlgorithmFinished()` å®ç°ï¼š
  - è°ƒç”¨ `context->saveResult()`
  - åˆ é™¤ `emit algorithmSucceeded()`
  - å‘å°„ `algorithmCompleted()`
  - è°ƒç”¨ `advanceWorkflow()`

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•å•æ¬¡æ‰§è¡Œä¿¡å·
QSignalSpy spy(coordinator, &AlgorithmCoordinator::algorithmCompleted);
coordinator->executeAlgorithm("differentiation", "curve-001");
QCOMPARE(spy.count(), 1);

QList<QVariant> args = spy.takeFirst();
QCOMPARE(args.at(1).toString(), "differentiation");  // algorithmName
QCOMPARE(args.at(2).toString(), "curve-001");        // parentCurveId
```

---

#### 2.2 å·¥ä½œæµå®ç°

**æ”¹åŠ¨æ¸…å•**:
- [ ] å®ç° `runWorkflow()` æ–¹æ³•
  - ç”Ÿæˆå·¥ä½œæµ ID
  - åˆå§‹åŒ– `PendingWorkflow` çŠ¶æ€
  - æ‰§è¡Œç¬¬ä¸€æ­¥ç®—æ³•
- [ ] å®ç° `advanceWorkflow()` æ–¹æ³•
  - æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨å·¥ä½œæµ
  - éªŒè¯ç®—æ³•ååŒ¹é…å½“å‰æ­¥éª¤
  - è®°å½•å½“å‰æ­¥éª¤è¾“å‡º
  - æ¨è¿›åˆ°ä¸‹ä¸€æ­¥æˆ–å®Œæˆå·¥ä½œæµ
- [ ] å®ç° `cancelWorkflow()` æ–¹æ³•
  - æ ‡è®°çŠ¶æ€ä¸º Cancelled
  - æ¸…ç†å·¥ä½œæµçŠ¶æ€

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•çº¿æ€§å·¥ä½œæµ
QSignalSpy completedSpy(coordinator, &AlgorithmCoordinator::workflowCompleted);

QString wfId = coordinator->runWorkflow(
    {"movingAverage", "differentiation"},
    {"curve-001"}
);

// ç­‰å¾…å·¥ä½œæµå®Œæˆ
QVERIFY(completedSpy.wait(5000));
QCOMPARE(completedSpy.count(), 1);

QList<QVariant> args = completedSpy.takeFirst();
QCOMPARE(args.at(0).toString(), wfId);

// éªŒè¯ç”Ÿæˆäº†ä¸¤æ¡æ›²çº¿ï¼ˆå¹³æ»‘ + å¾®åˆ†ï¼‰
QStringList outputs = args.at(1).toStringList();
QCOMPARE(outputs.size(), 1);  // æœ€ç»ˆè¾“å‡ºæ˜¯å¾®åˆ†æ›²çº¿
```

---

### é˜¶æ®µ 3: ç®—æ³•å¢å¼º

#### 3.1 AlgorithmDescriptor ä¾èµ–å£°æ˜

**æ–‡ä»¶**: æ‰€æœ‰ç®—æ³•å®ç°ï¼ˆ5ä¸ªï¼‰

**æ”¹åŠ¨æ¸…å•**:
- [ ] **DifferentiationAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}` (ç»“æœç±»å‹å¥‘çº¦)
- [ ] **IntegrationAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}` (ç»“æœç±»å‹å¥‘çº¦)
- [ ] **MovingAverageFilterAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve}`
  - `produces = {"curve"}` (ç»“æœç±»å‹å¥‘çº¦)
- [ ] **BaselineCorrectionAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve, ContextKeys::SelectedPoints}`
  - `produces = {"curve"}` (ç»“æœç±»å‹å¥‘çº¦)
- [ ] **TemperatureExtrapolationAlgorithm**:
  - `prerequisites = {ContextKeys::ActiveCurve, ContextKeys::BaselineCurves}`
  - `produces = {"markers", "scalar"}` (ç»“æœç±»å‹å¥‘çº¦)

**è¯´æ˜**:
- `prerequisites`: ä½¿ç”¨ `ContextKeys` å¸¸é‡ï¼ˆå¦‚ `ContextKeys::ActiveCurve`ï¼‰ï¼Œè¡¨ç¤ºç®—æ³•æ‰§è¡Œå‰å¿…é¡»å­˜åœ¨çš„ä¸Šä¸‹æ–‡æ•°æ®
- `produces`: ç»“æœç±»å‹å¥‘çº¦ï¼ˆå¦‚ `"curve"`, `"markers"`, `"scalar"`ï¼‰ï¼Œæè¿°ç®—æ³•äº§ç”Ÿçš„è¾“å‡ºç±»å‹ï¼Œä¸æ˜¯å…·ä½“çš„é”®å

**éªŒæ”¶æ ‡å‡†**:
```cpp
auto desc = algorithm->descriptor();
QVERIFY(!desc.prerequisites.isEmpty());
QVERIFY(!desc.produces.isEmpty());

// éªŒè¯ prerequisites ä½¿ç”¨ ContextKeys
QCOMPARE(desc.prerequisites.first(), ContextKeys::ActiveCurve);
```

---

#### 3.2 ä¾èµ–æ ¡éªŒå®ç°

**æ–‡ä»¶**: `algorithm_coordinator.cpp`

**æ”¹åŠ¨æ¸…å•**:
- [ ] æ–°å¢ `checkPrerequisites(algorithmName)` ç§æœ‰æ–¹æ³•
- [ ] åœ¨ `executeAlgorithm()` å‰è°ƒç”¨æ ¡éªŒ
- [ ] ç¼ºå¤±ä¾èµ–æ—¶å‘å‡º `showMessage` ä¿¡å·

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•ä¾èµ–æ ¡éªŒ
curveManager->clearAll();  // æ¸…ç©ºæ›²çº¿

bool canRun = coordinator->checkPrerequisites("differentiation");
QVERIFY(!canRun);  // ç¼ºå°‘ activeCurve

curveManager->addCurve(curve);
curveManager->setActiveCurve("curve-001");

canRun = coordinator->checkPrerequisites("differentiation");
QVERIFY(canRun);  // ä¾èµ–æ»¡è¶³
```

---

### é˜¶æ®µ 4: UI å±‚è°ƒæ•´

#### 4.1 MainController ä¿¡å·è¿æ¥

**æ–‡ä»¶**:
- `Analysis/src/ui/controller/main_controller.h`
- `Analysis/src/ui/controller/main_controller.cpp`

**æ”¹åŠ¨æ¸…å•**:

**åˆ é™¤**:
- [ ] åˆ é™¤ `onCoordinatorAlgorithmSucceeded()` æ§½å‡½æ•°
- [ ] åˆ é™¤ `algorithmSucceeded` ä¿¡å·çš„ connect è¯­å¥

**æ–°å¢**:
- [ ] æ–°å¢ `onAlgorithmCompleted()` æ§½å‡½æ•°ï¼ˆ4ä¸ªå‚æ•°ï¼‰
- [ ] æ–°å¢ `onWorkflowCompleted()` æ§½å‡½æ•°
- [ ] æ–°å¢ `onWorkflowFailed()` æ§½å‡½æ•°
- [ ] è¿æ¥ `algorithmCompleted` ä¿¡å·
- [ ] è¿æ¥ `workflowCompleted` ä¿¡å·
- [ ] è¿æ¥ `workflowFailed` ä¿¡å·

**å®ç°**:
```cpp
void MainController::onAlgorithmCompleted(
    const QString& taskId,
    const QString& algorithmName,
    const QString& parentCurveId,
    const AlgorithmResult& result)
{
    Q_ASSERT(m_initialized);

    qInfo() << "ç®—æ³•æ‰§è¡Œå®Œæˆ:" << algorithmName
            << "taskId:" << taskId
            << "æºæ›²çº¿:" << parentCurveId
            << "ç»“æœç±»å‹:" << static_cast<int>(result.type());

    cleanupProgressDialog();
    m_currentTaskId.clear();
    m_currentAlgorithmName.clear();

    // å¯é€‰ï¼šè‡ªåŠ¨åŒ–å·¥ä½œæµå†³ç­–
    // if (algorithmName == "differentiation") {
    //     QString dtgCurveId = result.outputCurveIds().first();
    //     m_algorithmCoordinator->executeAlgorithm("peakDetection", dtgCurveId);
    // }
}
```

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•ä¿¡å·è¿æ¥
QSignalSpy spy(controller, SIGNAL(/* å†…éƒ¨ä¿¡å· */));
coordinator->executeAlgorithm("differentiation", "curve-001");
// éªŒè¯ controller çš„æ§½å‡½æ•°è¢«è°ƒç”¨
```

---

#### 4.2 ChartView åŒºåŸŸå åŠ èƒ½åŠ›ç¡®è®¤ä¸è¡¥å……

**èƒŒæ™¯**:
æœ¬è®¡åˆ’å‡å®š AlgorithmManager å¯ä»¥å‘å°„ `regionsGenerated()` ä¿¡å·ï¼Œç”± ChartView/ThermalChart æ¥æ”¶å¹¶æ˜¾ç¤ºåŒºåŸŸï¼ˆå¦‚å³°é¢ç§¯çš„é˜´å½±å¡«å……ï¼‰ã€‚éœ€è¦ç¡®è®¤æ­¤èƒ½åŠ›æ˜¯å¦å·²å®ç°ã€‚

**ç¡®è®¤æ­¥éª¤**:
1. æ£€æŸ¥ `ChartView` æ˜¯å¦å·²æœ‰ `onRegionsGenerated()` æ§½å‡½æ•°
2. æ£€æŸ¥ `ThermalChart` æ˜¯å¦å·²æœ‰åŒºåŸŸå åŠ æ–¹æ³•ï¼ˆå¦‚ `addCurveRegions()`ï¼‰
3. è‹¥æœªå®ç°ï¼Œåˆ™éœ€è¡¥å……æœ€å°å¯ç”¨ API

**å¦‚æœæœªå®ç°ï¼Œéœ€æ–°å¢**:

**æ–‡ä»¶**: `Analysis/src/ui/chart_view.h` å’Œ `thermal_chart.h`

**ChartView æ–°å¢**:
```cpp
class ChartView : public QWidget {
public slots:
    void onRegionsGenerated(const QString& curveId,
                           const QVector<RegionData>& regions);
};
```

**ThermalChart æ–°å¢**:
```cpp
class ThermalChart : public QChart {
public:
    // æ·»åŠ æ›²çº¿å…³è”çš„åŒºåŸŸï¼ˆå¦‚å³°é¢ç§¯é˜´å½±ï¼‰
    void addCurveRegions(const QString& curveId,
                        const QVector<RegionData>& regions);

    // æ¸…é™¤æ›²çº¿çš„åŒºåŸŸ
    void clearCurveRegions(const QString& curveId);

    // æ¸…é™¤æ‰€æœ‰åŒºåŸŸ
    void clearAllRegions();

private:
    // åŒºåŸŸå­˜å‚¨ï¼šcurveId â†’ QGraphicsPolygonItem åˆ—è¡¨
    QHash<QString, QVector<QGraphicsPolygonItem*>> m_curveRegions;
};
```

**RegionData ç»“æ„å®šä¹‰** (å¦‚ä¸å­˜åœ¨):
```cpp
struct RegionData {
    QPolygonF polygon;         // åŒºåŸŸå¤šè¾¹å½¢ï¼ˆæ•°æ®åæ ‡ï¼‰
    QColor fillColor;          // å¡«å……é¢œè‰²ï¼ˆå¸¦é€æ˜åº¦ï¼‰
    QString label;             // æ ‡ç­¾æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
    QPointF labelPosition;     // æ ‡ç­¾ä½ç½®ï¼ˆå¯é€‰ï¼‰
};
```

**å®ç°è¦ç‚¹**:
- åŒºåŸŸä»¥ `QGraphicsPolygonItem` å½¢å¼æ·»åŠ åˆ° QChart
- æ”¯æŒåŠé€æ˜å¡«å……ï¼ˆå¦‚ `QColor(255, 0, 0, 100)`ï¼‰
- åŒºåŸŸä¸æ›²çº¿ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼ˆåˆ é™¤æ›²çº¿æ—¶è‡ªåŠ¨æ¸…é™¤åŒºåŸŸï¼‰
- Z-order æ§åˆ¶ï¼šåŒºåŸŸåœ¨æ›²çº¿ä¸‹æ–¹ï¼ˆ`setZValue(-1)`ï¼‰

**éªŒæ”¶æ ‡å‡†**:
```cpp
// æµ‹è¯•åŒºåŸŸæ·»åŠ 
QVector<RegionData> regions;
RegionData region;
region.polygon = QPolygonF({QPointF(100, 0), QPointF(200, 0),
                            QPointF(200, 10), QPointF(100, 5)});
region.fillColor = QColor(255, 0, 0, 80);
region.label = "å³°é¢ç§¯: 123.45 J/g";
regions.append(region);

chartView->onRegionsGenerated("curve-001", regions);

// éªŒè¯åŒºåŸŸå·²æ·»åŠ åˆ°å›¾è¡¨
QVERIFY(chart->curveRegions("curve-001").size() == 1);

// éªŒè¯åŒºåŸŸéšæ›²çº¿åˆ é™¤
curveManager->removeCurve("curve-001");
QVERIFY(chart->curveRegions("curve-001").isEmpty());
```

**å·¥æ—¶ä¼°ç®—**: 2h (å¦‚éœ€å®ç°) / 0.5h (å¦‚å·²å®ç°ï¼Œä»…éœ€ç¡®è®¤)

---

### é˜¶æ®µ 5: æ¸…ç†æ—§ä»£ç 

#### 5.1 æ¸…ç† Context ä¸­çš„æ—§æ•°æ®

**æ”¹åŠ¨æ¸…å•**:
- [ ] åˆ é™¤æ‰€æœ‰ä½¿ç”¨ `OutputKeys::latestResult(algorithmName)` çš„ä»£ç 
- [ ] åˆ é™¤æ‰€æœ‰ä½¿ç”¨ `OutputKeys::resultType(algorithmName)` çš„ä»£ç 
- [ ] æœç´¢ `get.*latestResult` ç¡®è®¤æ— é—ç•™è°ƒç”¨

**éªŒæ”¶**:
```bash
# æœç´¢ç¡®è®¤
grep -r "latestResult" --include="*.cpp" --include="*.h" Analysis/src/
# åº”è¯¥åªåœ¨ OutputKeys å®šä¹‰å’Œ AlgorithmContext å®ç°ä¸­å‡ºç°
```

---

## 8. æµ‹è¯•éªŒè¯

### 8.1 å•å…ƒæµ‹è¯•

#### æµ‹è¯• 1: å¹¶å‘æ‰§è¡Œï¼ˆæ— è¦†ç›–ï¼‰

```cpp
void TestAlgorithmContext::testConcurrentExecution()
{
    AlgorithmContext context;

    AlgorithmResult result1 = AlgorithmResult::success("differentiation", "curve-001", ResultType::Curve);
    AlgorithmResult result2 = AlgorithmResult::success("differentiation", "curve-001", ResultType::Curve);
    AlgorithmResult result3 = AlgorithmResult::success("differentiation", "curve-001", ResultType::Curve);

    // å¹¶å‘ä¿å­˜
    context.saveResult("task-001", "differentiation", "curve-001", result1);
    context.saveResult("task-002", "differentiation", "curve-001", result2);
    context.saveResult("task-003", "differentiation", "curve-001", result3);

    // éªŒè¯æœ€æ–°ç»“æœ
    auto latest = context.latestResult("differentiation", "curve-001");
    QVERIFY(latest.has_value());

    // éªŒè¯å†å²ç»“æœ
    auto history = context.historyResults("differentiation", "curve-001");
    QCOMPARE(history.size(), 3);

    // éªŒè¯ä¸»å­˜å‚¨ï¼ˆbyTaskï¼‰
    auto task1 = context.get<AlgorithmResult>(OutputKeys::byTask("differentiation", "task-001"));
    QVERIFY(task1.has_value());
}
```

#### æµ‹è¯• 2: LRU è£å‰ª

```cpp
void TestAlgorithmContext::testHistoryLRU()
{
    AlgorithmContext context;
    context.setHistoryDepth(3);  // åªä¿ç•™ 3 æ¬¡

    // æ‰§è¡Œ 5 æ¬¡
    for (int i = 0; i < 5; ++i) {
        QString taskId = QString("task-%1").arg(i);
        AlgorithmResult result = AlgorithmResult::success("differentiation", "curve-001", ResultType::Curve);
        context.saveResult(taskId, "differentiation", "curve-001", result);
    }

    // éªŒè¯å†å²é˜Ÿåˆ—åªæœ‰ 3 ä¸ª
    auto history = context.historyResults("differentiation", "curve-001");
    QCOMPARE(history.size(), 3);

    // éªŒè¯æ˜¯æœ€è¿‘çš„ 3 ä¸ªï¼ˆtask-4, task-3, task-2ï¼‰
    QString latestKey = OutputKeys::latestTaskId("differentiation", "curve-001");
    QString latestTaskId = context.get<QString>(latestKey).value();
    QCOMPARE(latestTaskId, "task-4");
}
```

#### æµ‹è¯• 3: å·¥ä½œæµæ‰§è¡Œ

```cpp
void TestAlgorithmCoordinator::testWorkflowExecution()
{
    QSignalSpy completedSpy(coordinator, &AlgorithmCoordinator::workflowCompleted);
    QSignalSpy failedSpy(coordinator, &AlgorithmCoordinator::workflowFailed);

    // å‡†å¤‡æµ‹è¯•æ›²çº¿
    ThermalCurve curve = createTestCurve();
    curveManager->addCurve(curve);

    // æ‰§è¡Œå·¥ä½œæµ
    QString wfId = coordinator->runWorkflow(
        {"movingAverage", "differentiation"},
        {curve.id()}
    );

    QVERIFY(!wfId.isEmpty());

    // ç­‰å¾…å®Œæˆï¼ˆæœ€å¤š 5 ç§’ï¼‰
    QVERIFY(completedSpy.wait(5000));
    QCOMPARE(completedSpy.count(), 1);
    QCOMPARE(failedSpy.count(), 0);

    // éªŒè¯è¾“å‡º
    QList<QVariant> args = completedSpy.takeFirst();
    QCOMPARE(args.at(0).toString(), wfId);

    QStringList outputs = args.at(1).toStringList();
    QCOMPARE(outputs.size(), 1);  // æœ€ç»ˆè¾“å‡ºæ›²çº¿
}
```

#### æµ‹è¯• 4: ä¾èµ–æ ¡éªŒ

```cpp
void TestAlgorithmCoordinator::testPrerequisites()
{
    curveManager->clearAll();

    // æ— æ´»åŠ¨æ›²çº¿æ—¶
    bool canRun = coordinator->checkPrerequisites("differentiation");
    QVERIFY(!canRun);

    // æ·»åŠ æ›²çº¿å¹¶è®¾ä¸ºæ´»åŠ¨
    ThermalCurve curve = createTestCurve();
    curveManager->addCurve(curve);
    curveManager->setActiveCurve(curve.id());

    // å†æ¬¡æ£€æŸ¥
    canRun = coordinator->checkPrerequisites("differentiation");
    QVERIFY(canRun);
}
```

### 8.2 é›†æˆæµ‹è¯•

#### æµ‹è¯• 5: ç«¯åˆ°ç«¯å·¥ä½œæµ

```cpp
void TestIntegration::testEndToEndWorkflow()
{
    // 1. å¯¼å…¥æ•°æ®
    ThermalCurve curve = importTestData("test_tga.txt");

    // 2. æ‰§è¡Œå·¥ä½œæµ
    QString wfId = coordinator->runWorkflow(
        {"movingAverage", "differentiation", "peakDetection"},
        {curve.id()}
    );

    // 3. ç­‰å¾…å®Œæˆ
    QSignalSpy spy(coordinator, &AlgorithmCoordinator::workflowCompleted);
    QVERIFY(spy.wait(10000));

    // 4. éªŒè¯ç»“æœ
    QStringList outputs = spy.at(0).at(1).toStringList();
    QVERIFY(!outputs.isEmpty());

    // 5. éªŒè¯å†å²è®°å½•
    auto smoothHistory = context->historyResults("movingAverage", curve.id());
    QCOMPARE(smoothHistory.size(), 1);

    auto diffHistory = context->historyResults("differentiation", outputs.first());
    QCOMPARE(diffHistory.size(), 1);
}
```

---

## 9. é£é™©è¯„ä¼°

### 9.1 é«˜é£é™©é¡¹

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **ä¿¡å·è¿æ¥é—æ¼** | ä¸­ | é«˜ | ç¼–è¯‘æ—¶æœç´¢æ‰€æœ‰ `algorithmSucceeded` ç¡®è®¤åˆ é™¤å¹²å‡€ |
| **Context é”®åå†²çª** | ä½ | ä¸­ | ä½¿ç”¨ OutputKeys ç»Ÿä¸€ç”Ÿæˆï¼Œé¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸² |
| **å·¥ä½œæµçŠ¶æ€æ··ä¹±** | ä¸­ | ä¸­ | å•å®ä¾‹é™åˆ¶ï¼Œæ·»åŠ çŠ¶æ€æ—¥å¿—ï¼Œå•å…ƒæµ‹è¯•è¦†ç›– |
| **LRU è£å‰ªä¸¢å¤±é‡è¦æ•°æ®** | ä½ | ä½ | é…ç½®å¯è°ƒï¼ˆé»˜è®¤10ï¼‰ï¼Œå…³é”®ä»»åŠ¡ä¸è£å‰ª |

### 9.2 ä¸­é£é™©é¡¹

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **æ—§ä»£ç å›å½’** | ä¸­ | ä¸­ | å…¨é¢æœç´¢ `latestResult`/`algorithmSucceeded` |
| **æ€§èƒ½é—®é¢˜ï¼ˆé¢‘ç¹å­˜å‚¨ï¼‰** | ä½ | ä½ | Context å·²æœ‰ä¼˜åŒ–ï¼Œå¿…è¦æ—¶æ‰¹é‡å†™å…¥ |
| **å·¥ä½œæµå–æ¶ˆä¸å½»åº•** | ä¸­ | ä½ | å–æ¶ˆæ—¶æ¸…ç†æ‰€æœ‰çŠ¶æ€ï¼Œæ·»åŠ é›†æˆæµ‹è¯• |

### 9.3 ä½é£é™©é¡¹

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **ä¾èµ–æ ¡éªŒè¯¯æŠ¥** | ä½ | ä½ | å®Œå–„æ ¡éªŒé€»è¾‘ï¼Œæ·»åŠ å•å…ƒæµ‹è¯• |
| **å†å²æŸ¥è¯¢æ€§èƒ½** | ä½ | ä½ | é™åˆ¶æŸ¥è¯¢æ·±åº¦ï¼ˆé»˜è®¤10ï¼‰ï¼Œå»¶è¿ŸåŠ è½½ |

---

## 10. æ—¶é—´çº¿ä¼°ç®—

### 10.1 å·¥ä½œé‡ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| **é˜¶æ®µ1** | OutputKeys å¢å¼º | 0.5h | P0 |
| **é˜¶æ®µ1** | AlgorithmContext å¢å¼º | 2h | P0 |
| **é˜¶æ®µ2** | AlgorithmCoordinator ä¿¡å·é‡æ„ | 3h | P0 |
| **é˜¶æ®µ2** | å·¥ä½œæµå®ç° | 4h | P1 |
| **é˜¶æ®µ3** | ç®—æ³•ä¾èµ–å£°æ˜ | 1h | P2 |
| **é˜¶æ®µ3** | ä¾èµ–æ ¡éªŒå®ç° | 1.5h | P2 |
| **é˜¶æ®µ4** | MainController è°ƒæ•´ | 1h | P0 |
| **é˜¶æ®µ4** | Region å åŠ èƒ½åŠ›ç¡®è®¤/å®ç° | 0.5h-2h | P1 |
| **é˜¶æ®µ5** | æ¸…ç†æ—§ä»£ç  | 1h | P1 |
| **æµ‹è¯•** | å•å…ƒæµ‹è¯•ç¼–å†™ | 4h | P0 |
| **æµ‹è¯•** | é›†æˆæµ‹è¯•éªŒè¯ | 2h | P1 |
| **æ€»è®¡** | - | **20-21.5h** | - |

### 8.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | äº¤ä»˜ç‰© | æˆªæ­¢æ—¥æœŸ |
|--------|--------|---------|
| **M1: åŸºç¡€è®¾æ–½å®Œæˆ** | OutputKeys + AlgorithmContext å®ç°å¹¶é€šè¿‡å•å…ƒæµ‹è¯• | Day 1 |
| **M2: ä¿¡å·æœºåˆ¶å®Œæˆ** | AlgorithmCoordinator é‡æ„å®Œæˆï¼Œå‘å°„æ–°ä¿¡å· | Day 2 |
| **M3: å·¥ä½œæµå®Œæˆ** | çº¿æ€§å·¥ä½œæµå¯ç”¨ï¼Œé€šè¿‡é›†æˆæµ‹è¯• | Day 3 |
| **M4: å…¨é¢é›†æˆ** | UI å±‚è°ƒæ•´å®Œæˆï¼Œæ—§ä»£ç æ¸…ç†å¹²å‡€ | Day 4 |
| **M5: å‘å¸ƒå°±ç»ª** | æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ–‡æ¡£æ›´æ–°å®Œæˆ | Day 5 |

### 8.3 å»ºè®®å¼€å‘é¡ºåº

**ç¬¬ 1 å¤©**ï¼ˆæ ¸å¿ƒåŸºç¡€ï¼‰:
1. OutputKeys å¢å¼ºï¼ˆ0.5hï¼‰
2. AlgorithmContext å¢å¼ºï¼ˆ2hï¼‰
3. å•å…ƒæµ‹è¯•ç¼–å†™ï¼ˆAlgorithmContextï¼‰ï¼ˆ1.5hï¼‰
4. ä»£ç å®¡æŸ¥ä¸è°ƒæ•´ï¼ˆ0.5hï¼‰

**ç¬¬ 2 å¤©**ï¼ˆåè°ƒå±‚é‡æ„ï¼‰:
1. AlgorithmCoordinator ä¿¡å·åˆ é™¤ä¸æ–°å¢ï¼ˆ2hï¼‰
2. åŒæ­¥/å¼‚æ­¥æ§½å‡½æ•°æ”¹é€ ï¼ˆ1hï¼‰
3. MainController ä¿¡å·è¿æ¥è°ƒæ•´ï¼ˆ1hï¼‰
4. å•å…ƒæµ‹è¯•ï¼ˆä¿¡å·å‘å°„ï¼‰ï¼ˆ1hï¼‰

**ç¬¬ 3 å¤©**ï¼ˆå·¥ä½œæµå®ç°ï¼‰:
1. PendingWorkflow ç»“æ„è®¾è®¡ï¼ˆ0.5hï¼‰
2. runWorkflow() å®ç°ï¼ˆ1.5hï¼‰
3. advanceWorkflow() å®ç°ï¼ˆ1.5hï¼‰
4. cancelWorkflow() å®ç°ï¼ˆ0.5hï¼‰
5. å·¥ä½œæµå•å…ƒæµ‹è¯•ï¼ˆ2hï¼‰

**ç¬¬ 4 å¤©**ï¼ˆç®—æ³•å¢å¼ºä¸é›†æˆï¼‰:
1. 5ä¸ªç®—æ³• prerequisites/produces è¡¥å……ï¼ˆ1hï¼‰
2. ä¾èµ–æ ¡éªŒå®ç°ï¼ˆ1.5hï¼‰
3. æ¸…ç†æ—§ä»£ç ï¼ˆ1hï¼‰
4. é›†æˆæµ‹è¯•ç¼–å†™ï¼ˆ2hï¼‰

**ç¬¬ 5 å¤©**ï¼ˆæµ‹è¯•ä¸ä¼˜åŒ–ï¼‰:
1. ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ1hï¼‰
2. æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1hï¼‰
3. ä»£ç å®¡æŸ¥ä¸ bug ä¿®å¤ï¼ˆ2hï¼‰
4. æ–‡æ¡£æ›´æ–°ï¼ˆ1hï¼‰

---

## 11. éªŒæ”¶æ ‡å‡†

### 11.1 åŠŸèƒ½éªŒæ”¶

- [ ] **å¹¶å‘æ‰§è¡Œ**: åŒæ—¶æ‰§è¡Œ 3 æ¬¡å¾®åˆ†ï¼Œç»“æœäº’ä¸è¦†ç›–
- [ ] **å†å²æŸ¥è¯¢**: å¯ä»¥æŸ¥è¯¢æŸæ¡æ›²çº¿æŸç®—æ³•çš„æœ€è¿‘ 20 æ¬¡æ‰§è¡Œ
- [ ] **LRU è£å‰ª**: æ‰§è¡Œ 25 æ¬¡ååªä¿ç•™æœ€è¿‘ 20 æ¬¡
- [ ] **å·¥ä½œæµæ‰§è¡Œ**: æˆåŠŸæ‰§è¡Œ 2-3 æ­¥çº¿æ€§å·¥ä½œæµ
- [ ] **å·¥ä½œæµå–æ¶ˆ**: å¯ä»¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å–æ¶ˆ
- [ ] **ä¾èµ–æ ¡éªŒ**: ç¼ºå°‘å‰ç½®ä¾èµ–æ—¶æç¤ºé”™è¯¯
- [ ] **ä¿¡å·æœºåˆ¶**: æ‰€æœ‰ç®—æ³•å®Œæˆæ—¶å‘å°„ `algorithmCompleted` ä¿¡å·

### 11.2 ä»£ç è´¨é‡éªŒæ”¶

- [ ] **æ— ç¼–è¯‘è­¦å‘Š**: ç¼–è¯‘æ—¶æ—  warning
- [ ] **æ— æ—§ä»£ç æ®‹ç•™**: æœç´¢ç¡®è®¤æ—  `algorithmSucceeded`/æ—§ `latestResult`
- [ ] **æ— ç¡¬ç¼–ç é”®å**: æ‰€æœ‰ Context è®¿é—®ä½¿ç”¨ OutputKeys
- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–**: æ ¸å¿ƒæ–¹æ³•æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] **é›†æˆæµ‹è¯•é€šè¿‡**: ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•é€šè¿‡

### 11.3 æ€§èƒ½éªŒæ”¶

- [ ] **å­˜å‚¨æ€§èƒ½**: 1000 æ¬¡æ‰§è¡Œçš„ä¿å­˜æ—¶é—´ < 100ms
- [ ] **æŸ¥è¯¢æ€§èƒ½**: å†å²æŸ¥è¯¢ï¼ˆ10æ¡ï¼‰æ—¶é—´ < 10ms
- [ ] **å·¥ä½œæµå»¶è¿Ÿ**: 3æ­¥å·¥ä½œæµçš„æ€»å¼€é”€ < 50msï¼ˆä¸å«ç®—æ³•æ‰§è¡Œï¼‰

---

## 10. åç»­æ‰©å±•æ–¹å‘

### 10.1 çŸ­æœŸï¼ˆPhase 2ï¼‰

- [ ] **å·¥ä½œæµ DAG æ”¯æŒ**: å…è®¸åˆ†æ”¯å’ŒèšåˆèŠ‚ç‚¹
- [ ] **å¹¶å‘å·¥ä½œæµ**: æ”¯æŒåŒæ—¶æ‰§è¡Œå¤šä¸ªå·¥ä½œæµå®ä¾‹
- [ ] **å·¥ä½œæµæŒä¹…åŒ–**: ä¿å­˜å·¥ä½œæµå®šä¹‰åˆ°æ–‡ä»¶/æ•°æ®åº“
- [ ] **è‡ªåŠ¨è§¦å‘è§„åˆ™**: åœ¨ AlgorithmDescriptor ä¸­å®šä¹‰ `autoTrigger`

### 10.2 ä¸­æœŸï¼ˆPhase 3ï¼‰

- [ ] **å·¥ä½œæµå¯è§†åŒ–ç¼–è¾‘å™¨**: æ‹–æ‹½å¼å·¥ä½œæµè®¾è®¡
- [ ] **æ¡ä»¶åˆ†æ”¯**: æ ¹æ®ç®—æ³•ç»“æœé€‰æ‹©ä¸åŒè·¯å¾„
- [ ] **å¾ªç¯æ‰§è¡Œ**: æ”¯æŒæ‰¹é‡å¤„ç†å¤šæ¡æ›²çº¿
- [ ] **é”™è¯¯æ¢å¤**: å¤±è´¥æ­¥éª¤çš„é‡è¯•æœºåˆ¶

### 10.3 é•¿æœŸï¼ˆPhase 4ï¼‰

- [ ] **è„šæœ¬åŒ–å·¥ä½œæµ**: æ”¯æŒ Lua/Python è„šæœ¬å®šä¹‰æµç¨‹
- [ ] **åˆ†å¸ƒå¼æ‰§è¡Œ**: å·¥ä½œæµæ­¥éª¤åˆ†å¸ƒåˆ°å¤šå°æœºå™¨
- [ ] **å¢é‡è®¡ç®—**: ç¼“å­˜ä¸­é—´ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
- [ ] **ç‰ˆæœ¬ç®¡ç†**: å·¥ä½œæµå®šä¹‰çš„ç‰ˆæœ¬æ§åˆ¶

---

## é™„å½•

### A. å…³é”®ç±»å›¾

```
AlgorithmContext (åŸºç¡€è®¾æ–½)
  â”œâ”€ saveResult(taskId, algorithm, curveId, result)
  â”œâ”€ latestResult(algorithm, curveId)
  â””â”€ historyResults(algorithm, curveId, limit)

AlgorithmCoordinator (åè°ƒå±‚)
  â”œâ”€ algorithmCompleted(taskId, algorithm, curveId, result) [ä¿¡å·]
  â”œâ”€ workflowCompleted(workflowId, outputs) [ä¿¡å·]
  â”œâ”€ runWorkflow(steps, curveIds)
  â””â”€ advanceWorkflow(taskId, algorithm, result) [ç§æœ‰]

MainController (UIå±‚)
  â”œâ”€ onAlgorithmCompleted(...) [æ§½å‡½æ•°]
  â”œâ”€ onWorkflowCompleted(...) [æ§½å‡½æ•°]
  â””â”€ onWorkflowFailed(...) [æ§½å‡½æ•°]
```

### B. æ•°æ®æµå›¾

```
ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œå¾®åˆ†"
  â†“
MainController::onAlgorithmRequested()
  â†“
AlgorithmCoordinator::executeAlgorithm()
  â†“
AlgorithmManager::executeAsync()
  â†“
AlgorithmWorker::run() (å·¥ä½œçº¿ç¨‹)
  â†“
AlgorithmManager::onWorkerFinished()
  â”œâ”€ handleAlgorithmResult() â†’ è½åœ°åˆ° CurveManager
  â””â”€ emit algorithmFinished(taskId, algorithmName, result, elapsedMs)
      â†“
AlgorithmCoordinator::onAsyncAlgorithmFinished()
  â”œâ”€ context->saveResult(taskId, ...) â†’ ç¼“å­˜ç»“æœ
  â”œâ”€ emit algorithmCompleted(taskId, ...) â†’ é€šçŸ¥ UI
  â””â”€ advanceWorkflow(...) â†’ æ¨è¿›å·¥ä½œæµï¼ˆå¦‚æœ‰ï¼‰
      â†“
MainController::onAlgorithmCompleted()
  â””â”€ cleanupProgressDialog() + è‡ªå®šä¹‰é€»è¾‘
```

### C. ApplicationContext ä¿¡å·è¿æ¥å…³ç³»å›¾

æœ¬èŠ‚è¡¥å……è¯´æ˜ ApplicationContext ç»Ÿä¸€åˆå§‹åŒ–åï¼Œå„ç»„ä»¶ä¹‹é—´çš„ä¿¡å·è¿æ¥å…³ç³»ã€‚

#### C.1 AlgorithmManager â†’ ChartView (æ ‡æ³¨ä¸åŒºåŸŸ)

**ä¿¡å·å®šä¹‰** (`algorithm_manager.h`):
```cpp
class AlgorithmManager : public QObject {
signals:
    void markersGenerated(const QString& parentCurveId,
                         const QVector<MarkerData>& markers);

    void regionsGenerated(const QString& parentCurveId,
                         const QVector<RegionData>& regions);
};
```

**è¿æ¥ä½ç½®** (`ApplicationContext::initialize()` æˆ– `main_controller.cpp`):
```cpp
// åœ¨ MainController ä¸­è¿æ¥
connect(m_algorithmManager, &AlgorithmManager::markersGenerated,
        m_chartView, &ChartView::onMarkersGenerated);

connect(m_algorithmManager, &AlgorithmManager::regionsGenerated,
        m_chartView, &ChartView::onRegionsGenerated);
```

**ç”¨é€”**:
- å³°å€¼æ£€æµ‹ã€å¤–æ¨æ³•ç­‰ç®—æ³•äº§ç”Ÿçš„æ ‡æ³¨ç‚¹ç›´æ¥å‘é€åˆ°å›¾è¡¨æ˜¾ç¤º
- å³°é¢ç§¯è®¡ç®—äº§ç”Ÿçš„åŒºåŸŸï¼ˆé˜´å½±å¡«å……ï¼‰ç›´æ¥å‘é€åˆ°å›¾è¡¨æ˜¾ç¤º
- é¿å…é€šè¿‡ CurveManager ä¸­è½¬ï¼Œå‡å°‘è€¦åˆ

#### C.2 CurveManager â†’ ChartView (æ›²çº¿ç”Ÿå‘½å‘¨æœŸ)

**ä¿¡å·å®šä¹‰** (`curve_manager.h`):
```cpp
class CurveManager : public QObject {
signals:
    void curveAdded(const QString& curveId);
    void curveRemoved(const QString& curveId);
    void curveDataChanged(const QString& curveId);
    void curvesCleared();
    void activeCurveChanged(const QString& curveId);
};
```

**è¿æ¥ä½ç½®** (`ApplicationContext::initialize()` æˆ– `chart_view.cpp`):
```cpp
// åœ¨ ChartView åˆå§‹åŒ–æ—¶è¿æ¥
connect(m_curveManager, &CurveManager::curveAdded,
        this, &ChartView::onCurveAdded);

connect(m_curveManager, &CurveManager::curveRemoved,
        this, &ChartView::onCurveRemoved);

connect(m_curveManager, &CurveManager::curveDataChanged,
        this, &ChartView::onCurveDataChanged);

connect(m_curveManager, &CurveManager::curvesCleared,
        this, &ChartView::onCurvesCleared);
```

**ç”¨é€”**:
- å“åº”å¼æ›´æ–°å›¾è¡¨ï¼ˆæ–°å¢/åˆ é™¤/ä¿®æ”¹æ›²çº¿æ—¶è‡ªåŠ¨åˆ·æ–°ï¼‰
- UI ä¸éœ€è¦ä¸»åŠ¨æŸ¥è¯¢ï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨æ›´æ–°
- æ”¯æŒæ’¤é”€/é‡åšæ—¶çš„è‡ªåŠ¨åŒæ­¥

#### C.3 AlgorithmManager â†’ MainController (æ‰§è¡Œè¿›åº¦)

**ä¿¡å·å®šä¹‰** (`algorithm_manager.h`):
```cpp
class AlgorithmManager : public QObject {
signals:
    void algorithmProgress(const QString& taskId, int percentage);
    void algorithmFinished(const QString& taskId,
                          const QString& algorithmName,
                          const AlgorithmResult& result,
                          qint64 elapsedMs);
    void algorithmFailed(const QString& taskId,
                        const QString& algorithmName,
                        const QString& errorMessage);
};
```

**è¿æ¥ä½ç½®** (`main_controller.cpp::setAlgorithmManager()`):
```cpp
connect(m_algorithmManager, &AlgorithmManager::algorithmProgress,
        this, &MainController::onAlgorithmProgress);

connect(m_algorithmManager, &AlgorithmManager::algorithmFinished,
        m_algorithmCoordinator, &AlgorithmCoordinator::onAsyncAlgorithmFinished);

connect(m_algorithmManager, &AlgorithmManager::algorithmFailed,
        this, &MainController::onAlgorithmFailed);
```

**ç”¨é€”**:
- æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆé•¿æ—¶é—´ç®—æ³•ï¼‰
- é€šçŸ¥ Coordinator æ›´æ–°ç¼“å­˜å¹¶å‘å°„ `algorithmCompleted`
- å¤„ç†ç®—æ³•å¤±è´¥ï¼ˆæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†ï¼‰

#### C.4 AlgorithmCoordinator â†’ MainController (å·¥ä½œæµçŠ¶æ€)

**æ–°å¢ä¿¡å·** (`algorithm_coordinator.h`):
```cpp
class AlgorithmCoordinator : public QObject {
signals:
    void algorithmCompleted(const QString& taskId,
                           const QString& algorithmName,
                           const QString& parentCurveId,
                           const AlgorithmResult& result);

    void workflowCompleted(const QString& workflowId,
                          const QStringList& outputCurveIds);

    void workflowFailed(const QString& workflowId,
                       const QString& errorMessage);
};
```

**è¿æ¥ä½ç½®** (`main_controller.cpp::setAlgorithmCoordinator()`):
```cpp
connect(m_algorithmCoordinator, &AlgorithmCoordinator::algorithmCompleted,
        this, &MainController::onAlgorithmCompleted);

connect(m_algorithmCoordinator, &AlgorithmCoordinator::workflowCompleted,
        this, &MainController::onWorkflowCompleted);

connect(m_algorithmCoordinator, &AlgorithmCoordinator::workflowFailed,
        this, &MainController::onWorkflowFailed);
```

**ç”¨é€”**:
- MainController æ¥æ”¶ç®—æ³•å®Œæˆé€šçŸ¥ï¼ˆæºå¸¦å®Œæ•´ç»“æœä¿¡æ¯ï¼‰
- å¤„ç†å·¥ä½œæµæˆåŠŸ/å¤±è´¥ï¼ˆå…³é—­è¿›åº¦å¯¹è¯æ¡†ã€æ˜¾ç¤ºé€šçŸ¥ï¼‰
- æ”¯æŒè‡ªå®šä¹‰é€»è¾‘ï¼ˆå¦‚è‡ªåŠ¨è§¦å‘ä¸‹ä¸€ä¸ªç®—æ³•ï¼‰

#### C.5 å®Œæ•´ä¿¡å·æµå›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ApplicationContext         â”‚
                    â”‚  (ç»Ÿä¸€åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚              â”‚
                 â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CurveManagerâ”‚  â”‚AlgorithmManagerâ”‚ â”‚AlgorithmCoordâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚           â”‚              â”‚                   â”‚
    â”‚ curveAddedâ”‚   algorithmFinished      algorithmCompleted
    â”‚ curveRemovedâ”‚ algorithmProgress       workflowCompleted
    â”‚ curveDataChangedâ”‚ algorithmFailed     workflowFailed
    â”‚ curvesCleared   â”‚ markersGenerated            â”‚
    â”‚           â”‚     â”‚ regionsGenerated            â”‚
    â”‚           â”‚     â”‚                             â”‚
    â–¼           â–¼     â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ChartView            â”‚          â”‚  MainController  â”‚
â”‚  (UI: å›¾è¡¨æ˜¾ç¤ºä¸äº¤äº’)     â”‚          â”‚  (UI: å†³ç­–ä¸åè°ƒ)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿æ¥å»ºç«‹é¡ºåº** (åœ¨ `ApplicationContext::initialize()` ä¸­):
1. **åŸºç¡€è®¾æ–½å±‚** â†’ æ— ä¾èµ–
2. **é¢†åŸŸæ¨¡å‹å±‚** (CurveManager) â†’ è¿æ¥åˆ° ChartView
3. **åº”ç”¨æœåŠ¡å±‚** (AlgorithmManager) â†’ è¿æ¥åˆ° ChartView + Coordinator
4. **åè°ƒå±‚** (AlgorithmCoordinator) â†’ è¿æ¥åˆ° MainController
5. **æ§åˆ¶å™¨å±‚** (MainController) â†’ è®¢é˜…æ‰€æœ‰éœ€è¦çš„ä¿¡å·

### D. é”®ç©ºé—´ç¤ºä¾‹

```
# æ‰§è¡Œ 3 æ¬¡å¾®åˆ†ç®—æ³•

ä¸»å­˜å‚¨ï¼ˆæ°¸ä¹…ä¿ç•™ï¼‰ï¼š
  result/differentiation/byTask/task-001 â†’ AlgorithmResult (timestamp: 10:00)
  result/differentiation/byTask/task-002 â†’ AlgorithmResult (timestamp: 10:05)
  result/differentiation/byTask/task-003 â†’ AlgorithmResult (timestamp: 10:10)

æ›²çº¿ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰ï¼š
  result/differentiation/byCurve/curve-001/latestTaskId â†’ "task-003"
  result/differentiation/byCurve/curve-001/historyTaskIds â†’ ["task-003", "task-002", "task-001"]
```

---

**æ–‡æ¡£ç»“æŸ**

**å®¡æ‰¹æµç¨‹**:
- [ ] æŠ€æœ¯è´Ÿè´£äººå®¡æ‰¹
- [ ] æ¶æ„å¸ˆå®¡æ‰¹
- [ ] å¼€å§‹å®æ–½
