# 曲线级联删除功能说明

## 版本信息

**版本**: v1.0.0
**日期**: 2025-11-08
**作者**: Claude Code

## 问题背景

### 原有问题

之前的删除逻辑有以下问题：

1. **过于严格的保护**：任何有子曲线的曲线都不能删除
2. **不符合实际需求**：
   - 例如，在微分曲线上画了基线
   - 想删除微分曲线时，应该可以删除
   - 但旧逻辑会阻止删除，要求先手动删除基线

### 用户场景示例

```
原始曲线 (TGA)
  └── 微分曲线 (DTG)
        └── 基线曲线

用户想删除微分曲线：
  - 旧逻辑：❌ 禁止删除，因为微分曲线有子曲线（基线）
  - 新逻辑：✅ 允许删除，并自动删除基线曲线
```

## 新的删除逻辑

### 核心原则

1. **只保护主曲线**：
   - 主曲线 = 从文件导入的原始数据（`isMainCurve() == true`）
   - 主曲线不能被删除，只能通过"清空项目"功能移除

2. **派生曲线可以删除**：
   - 派生曲线 = 算法生成的曲线（微分、积分、基线等）
   - 即使派生曲线有子曲线，也可以删除

3. **级联删除子曲线**：
   - 删除曲线时，自动递归删除所有子曲线
   - 删除前会显示确认对话框，告知用户将删除的子曲线列表

### 删除保护判断

```cpp
// 判断是否可以删除
bool canDelete(ThermalCurve* curve) {
    // 主曲线不能删除
    if (curve->isMainCurve()) {
        return false;  // ❌ 禁止删除
    }

    // 派生曲线可以删除（即使有子曲线）
    return true;  // ✅ 允许删除
}
```

## 删除流程

### 流程图

```
用户请求删除曲线
  ↓
检查曲线是否存在 → [否] → 提示错误
  ↓ [是]
检查是否是主曲线 → [是] → 显示警告，禁止删除
  ↓ [否]
检查是否有子曲线
  ↓ [是]
显示确认对话框：
  "曲线有 N 个子曲线，删除此曲线将同时删除所有子曲线。是否继续？"
  ↓
用户选择 → [否] → 取消删除
  ↓ [是]
执行级联删除（递归删除所有子曲线）
  ↓
完成
```

### 删除策略对比

| 曲线类型 | 有无子曲线 | 旧逻辑 | 新逻辑 |
|---------|-----------|--------|--------|
| 主曲线 | 无 | ❌ 禁止 | ❌ 禁止 |
| 主曲线 | 有 | ❌ 禁止 | ❌ 禁止 |
| 派生曲线 | 无 | ✅ 允许 | ✅ 允许 |
| 派生曲线 | 有 | ❌ 禁止 | ✅ 允许（级联删除） |

## 实现细节

### 1. CurveManager 新增方法

#### `removeCurveRecursively()`

递归删除曲线及其所有子曲线（级联删除）。

```cpp
int CurveManager::removeCurveRecursively(const QString& curveId)
{
    if (!m_curves.contains(curveId)) {
        return 0;
    }

    int totalDeleted = 0;

    // 1. 递归删除所有子曲线
    QVector<ThermalCurve*> children = getChildren(curveId);
    for (ThermalCurve* child : children) {
        if (child) {
            totalDeleted += removeCurveRecursively(child->id());
        }
    }

    // 2. 删除本身
    if (removeCurve(curveId)) {
        totalDeleted++;
    }

    return totalDeleted;
}
```

**特性**：
- ✅ 深度优先遍历（先删除子曲线，再删除父曲线）
- ✅ 每删除一条曲线都会发射 `curveRemoved` 信号
- ✅ 返回删除的曲线总数（包括子曲线）

### 2. MainController 修改逻辑

#### `onCurveDeleteRequested()` 方法改进

```cpp
void MainController::onCurveDeleteRequested(const QString& curveId)
{
    // 1. 检查曲线是否存在
    ThermalCurve* curve = m_curveManager->getCurve(curveId);
    if (!curve) {
        return;
    }

    // 2. 禁止删除主曲线（保持不变）
    if (curve->isMainCurve()) {
        QMessageBox::warning(..., "主曲线不能删除");
        return;
    }

    // 3. 检查是否有子曲线
    if (m_curveManager->hasChildren(curveId)) {
        // 显示确认对话框（新增）
        QMessageBox::StandardButton reply = QMessageBox::question(
            ...,
            "曲线有 N 个子曲线，删除此曲线将同时删除所有子曲线。是否继续？",
            QMessageBox::Yes | QMessageBox::No,
            QMessageBox::No  // 默认 No（更安全）
        );

        if (reply == QMessageBox::No) {
            return;  // 用户取消
        }

        // 用户确认，执行级联删除（新增）
        int totalDeleted = m_curveManager->removeCurveRecursively(curveId);
        return;
    }

    // 4. 没有子曲线，直接删除（保持不变）
    m_curveManager->removeCurve(curveId);
}
```

## 用户交互示例

### 示例 1：删除无子曲线的派生曲线

**场景**：删除一条没有子曲线的微分曲线

**操作**：
1. 用户选择微分曲线，点击删除
2. 系统直接删除，无需确认

**结果**：微分曲线被删除

---

### 示例 2：删除有子曲线的派生曲线

**场景**：删除一条在其上画了基线的微分曲线

**曲线树结构**：
```
原始曲线 (TGA)
  └── 微分曲线 (DTG)          ← 用户要删除这个
        └── 基线曲线            ← 子曲线
```

**操作**：
1. 用户选择微分曲线，点击删除
2. 系统显示确认对话框：

   ```
   确认级联删除

   曲线 "微分曲线" 有 1 个子曲线：

     - 基线曲线

   删除此曲线将同时删除所有子曲线。

   是否继续删除？

   [是(Y)]  [否(N)]  ← 默认选择"否"
   ```

3. 用户点击"是"

**结果**：
- 微分曲线被删除
- 基线曲线被级联删除
- 控制台输出：`级联删除完成，共删除 2 条曲线（包括子曲线）`

---

### 示例 3：尝试删除主曲线

**场景**：用户尝试删除原始导入的 TGA 曲线

**操作**：
1. 用户选择主曲线，点击删除
2. 系统显示警告对话框：

   ```
   无法删除主曲线

   曲线 "TGA 原始数据" 是主曲线（数据源），不能被删除。

   主曲线是从文件导入的原始数据，是所有派生曲线的基础。
   如果需要移除，请使用 文件 → 清空项目 功能。

   [确定]
   ```

**结果**：主曲线未被删除

---

### 示例 4：多层级联删除

**场景**：删除有多级子曲线的派生曲线

**曲线树结构**：
```
原始曲线 (TGA)
  └── 微分曲线 (DTG)          ← 用户要删除这个
        ├── 基线曲线 1          ← 子曲线
        └── 基线曲线 2          ← 子曲线
              └── 峰面积曲线     ← 孙曲线
```

**操作**：
1. 用户选择微分曲线，点击删除
2. 系统显示确认对话框：

   ```
   确认级联删除

   曲线 "微分曲线" 有 2 个子曲线：

     - 基线曲线 1
     - 基线曲线 2

   删除此曲线将同时删除所有子曲线。

   是否继续删除？

   [是(Y)]  [否(N)]  ← 默认选择"否"
   ```

3. 用户点击"是"

**结果**：
- 微分曲线被删除
- 基线曲线 1 被删除
- 基线曲线 2 被删除
- 峰面积曲线被级联删除（基线曲线 2 的子曲线）
- 控制台输出：`级联删除完成，共删除 4 条曲线（包括子曲线）`

**注意**：确认对话框只显示直接子曲线（2 个），但删除时会递归删除所有后代曲线（包括孙曲线）。

---

## 技术细节

### 删除顺序

采用**深度优先遍历**（DFS）策略：

```
删除 A
  ├─ 删除 B（A的子曲线）
  │   ├─ 删除 D（B的子曲线）
  │   └─ 删除 E（B的子曲线）
  ├─ 删除 C（A的子曲线）
  └─ 删除 A 本身
```

### 信号发射

每删除一条曲线都会发射 `curveRemoved` 信号，确保 UI 及时更新。

**删除顺序与信号发射**：
```
信号: curveRemoved("D")  ← 先删除最深层的子曲线
信号: curveRemoved("E")
信号: curveRemoved("B")
信号: curveRemoved("C")
信号: curveRemoved("A")  ← 最后删除根曲线
```

### 活动曲线处理

如果被删除的曲线（或其子曲线）是当前活动曲线，`CurveManager` 会自动清空活动曲线并发射 `activeCurveChanged("")` 信号。

## 安全性考虑

### 默认选择"否"

确认对话框默认选择"否"（`QMessageBox::No`），防止用户误操作。

### 子曲线列表预览

确认对话框会显示前 5 个子曲线的名称，让用户了解将删除的内容：

```
曲线 "微分曲线" 有 12 个子曲线：

  - 基线曲线 1
  - 基线曲线 2
  - 峰面积曲线 1
  - 峰面积曲线 2
  - 积分曲线
  - ... (还有 7 个)
```

### 日志记录

每次删除都会在控制台输出详细日志，方便调试和追踪：

```
CurveManager::removeCurveRecursively - 递归删除子曲线: baseline_001（父曲线: derivative_001）
CurveManager: 已删除曲线 baseline_001
CurveManager::removeCurveRecursively - 删除曲线本身: baseline_001
CurveManager::removeCurveRecursively - 递归删除子曲线: baseline_002（父曲线: derivative_001）
CurveManager: 已删除曲线 baseline_002
CurveManager::removeCurveRecursively - 删除曲线本身: baseline_002
CurveManager: 已删除曲线 derivative_001
CurveManager::removeCurveRecursively - 删除曲线本身: derivative_001
MainController::onCurveDeleteRequested - 级联删除完成，共删除 3 条曲线（包括子曲线）
```

## 边界情况处理

### 1. 曲线不存在

**场景**：尝试删除一个不存在的曲线 ID

**处理**：
- `removeCurveRecursively()` 返回 0
- 控制台输出警告：`曲线不存在: xxx`

---

### 2. 空子曲线列表

**场景**：曲线的子曲线在查询后、删除前被其他操作删除

**处理**：
- 遍历子曲线时会检查 `child != nullptr`
- 跳过空指针，继续删除其他子曲线

---

### 3. 删除过程中活动曲线改变

**场景**：删除的曲线或其子曲线是当前活动曲线

**处理**：
- `CurveManager::removeCurve()` 会自动检查并清空活动曲线
- 发射 `activeCurveChanged("")` 信号
- UI 会自动更新（取消选择）

---

## 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|---------|------|
| `curve_manager.h` | 修改 | 添加 `removeCurveRecursively()` 方法声明 |
| `curve_manager.cpp` | 修改 | 实现 `removeCurveRecursively()` 递归删除逻辑 |
| `main_controller.cpp` | 修改 | 修改 `onCurveDeleteRequested()` 删除逻辑 |

---

## 测试建议

### 测试用例 1：删除无子曲线的派生曲线

**前提**：有一条微分曲线，无子曲线

**操作**：删除微分曲线

**预期**：微分曲线直接删除，无确认对话框

---

### 测试用例 2：删除有 1 个子曲线的派生曲线

**前提**：微分曲线 → 基线曲线

**操作**：删除微分曲线

**预期**：
1. 显示确认对话框，显示 1 个子曲线
2. 用户确认后，微分曲线和基线曲线都被删除
3. 控制台输出：`共删除 2 条曲线`

---

### 测试用例 3：删除有多级子曲线的派生曲线

**前提**：微分曲线 → 基线曲线 → 峰面积曲线

**操作**：删除微分曲线

**预期**：
1. 显示确认对话框，显示 1 个子曲线（基线曲线）
2. 用户确认后，3 条曲线都被删除（包括峰面积曲线）
3. 控制台输出：`共删除 3 条曲线`

---

### 测试用例 4：用户取消删除

**前提**：微分曲线 → 基线曲线

**操作**：删除微分曲线，点击"否"

**预期**：
1. 显示确认对话框
2. 用户点击"否"后，所有曲线保持不变

---

### 测试用例 5：尝试删除主曲线

**前提**：主曲线（从文件导入）

**操作**：删除主曲线

**预期**：显示警告对话框，禁止删除

---

### 测试用例 6：删除活动曲线

**前提**：微分曲线是当前活动曲线，有子曲线

**操作**：删除微分曲线

**预期**：
1. 显示确认对话框
2. 删除后，活动曲线被清空
3. UI 取消选择

---

## 兼容性

### 向后兼容

- ✅ `removeCurve()` 方法保持不变，仅删除单条曲线
- ✅ 所有现有调用 `removeCurve()` 的代码继续正常工作
- ✅ 新增的 `removeCurveRecursively()` 是可选方法

### UI 兼容

- ✅ 删除操作的 UI 入口不变（右键菜单、删除按钮等）
- ✅ 确认对话框风格与现有对话框一致

---

## 未来扩展建议

### 1. 批量删除

支持同时删除多条曲线（多选）。

### 2. 撤销/重做

集成到 HistoryManager，支持撤销级联删除操作。

### 3. 删除预览

在确认对话框中显示完整的删除树结构（包括孙曲线）。

### 4. 删除统计

在确认对话框中显示将删除的曲线总数（包括所有后代曲线）。

示例：
```
删除此曲线将同时删除：
  - 1 个直接子曲线
  - 2 个后代曲线
  - 共 4 条曲线

是否继续？
```

---

## 总结

### 改进前后对比

| 维度 | 改进前 | 改进后 |
|------|--------|--------|
| **灵活性** | ❌ 有子曲线就不能删除 | ✅ 可以删除派生曲线（级联删除子曲线） |
| **用户体验** | ❌ 需要手动逐个删除子曲线 | ✅ 一次操作删除所有相关曲线 |
| **安全性** | ✅ 严格保护 | ✅ 确认对话框保护 + 主曲线保护 |
| **符合直觉** | ❌ 不符合用户预期 | ✅ 符合"删除文件夹连同内容一起删除"的直觉 |

### 核心价值

1. **提高效率**：用户无需手动逐个删除子曲线
2. **符合直觉**：类似文件系统删除文件夹的行为
3. **保持安全**：主曲线保护 + 确认对话框双重保护
4. **代码清晰**：递归删除逻辑清晰，易于维护

---

**版权声明**：本文档由 Claude Code 自动生成。
