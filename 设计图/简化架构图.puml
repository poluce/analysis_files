@startuml DSC_TGA_Four_Layer_Architecture
!define RECTANGLE class

skinparam packageStyle rectangle
skinparam linetype ortho
skinparam nodesep 10
skinparam ranksep 20

' å®šä¹‰é¢œè‰²ä¸»é¢˜
skinparam package {
    BackgroundColor<<è¡¨ç¤ºå±‚>> #E3F2FD
    BorderColor<<è¡¨ç¤ºå±‚>> #1976D2
    BackgroundColor<<åº”ç”¨å±‚>> #F3E5F5
    BorderColor<<åº”ç”¨å±‚>> #7B1FA2
    BackgroundColor<<é¢†åŸŸå±‚>> #FFF3E0
    BorderColor<<é¢†åŸŸå±‚>> #F57C00
    BackgroundColor<<åŸºç¡€è®¾æ–½å±‚>> #E8F5E9
    BorderColor<<åŸºç¡€è®¾æ–½å±‚>> #388E3C
}

skinparam class {
    BackgroundColor<<è¡¨ç¤ºå±‚>> #BBDEFB
    BorderColor<<è¡¨ç¤ºå±‚>> #1976D2
    BackgroundColor<<åº”ç”¨å±‚>> #E1BEE7
    BorderColor<<åº”ç”¨å±‚>> #7B1FA2
    BackgroundColor<<é¢†åŸŸå±‚>> #FFE0B2
    BorderColor<<é¢†åŸŸå±‚>> #F57C00
    BackgroundColor<<åŸºç¡€è®¾æ–½å±‚>> #C8E6C9
    BorderColor<<åŸºç¡€è®¾æ–½å±‚>> #388E3C
}

title DSC/TGAçƒ­åˆ†æè½¯ä»¶ - å››å±‚æ¶æ„è®¾è®¡å›¾\nåŸºäºQt/C++å¼€å‘

' ========== è¡¨ç¤ºå±‚ (Presentation Layer) ==========
package "ğŸ–¥ï¸ è¡¨ç¤ºå±‚" <<è¡¨ç¤ºå±‚>> {
    class MainWindow <<è¡¨ç¤ºå±‚>> {
        - menuBar: QMenuBar*
        - toolBar: QToolBar*
        - statusBar: QStatusBar*
        - dockWidgets: QList<QDockWidget*>
        --
        + setupUI(): void
        + showProgress(msg: QString): void
        + updateCurveList(): void
        --
        <<signal>> openFileRequested()
        <<signal>> saveProjectRequested()
        <<signal>> undoRequested()
        <<signal>> redoRequested()
    }
    
    class ChartView <<è¡¨ç¤ºå±‚>> {
        - chart: QChart*
        - series: QMap<QString, QLineSeries*>
        - rubberBand: QRubberBand*
        --
        + addCurve(id: QString, data): void
        + removeCurve(id: QString): void
        + updateCurve(id: QString): void
        + zoomToRegion(rect: QRectF): void
        + exportToImage(path: QString): void
        --
        <<signal>> regionSelected(curveId, startIdx, endIdx)
        <<signal>> pointClicked(curveId, pointIdx)
        <<signal>> zoomChanged(level: double)
    }
    
    class ToolPanel <<è¡¨ç¤ºå±‚>> {
        - paramLayout: QFormLayout*
        - resultTable: QTableWidget*
        - propertyTree: QTreeWidget*
        --
        + showAlgorithmParams(algo): void
        + showCurveProperties(curve): void
        + showAnalysisResults(results): void
        --
        <<signal>> parameterChanged(name, value)
        <<signal>> algorithmApplied(name)
    }
    
    MainWindow *-- ChartView
    MainWindow *-- ToolPanel
}

' ========== åº”ç”¨å±‚ (Application Layer) ==========
package "âš™ï¸ åº”ç”¨å±‚" <<åº”ç”¨å±‚>> {
    
    package "Controllers" {
        class MainController <<åº”ç”¨å±‚>> {
            - projectManager: ProjectManager*
            - curveManager: CurveManager*
            - algorithmService: AlgorithmService*
            - historyManager: HistoryManager*
            --
            + handleOpenFile(): void
            + handleSaveProject(): void
            + handleUndo(): void
            + handleRedo(): void
            + coordinateWorkflow(): void
        }
        
        class ChartController <<åº”ç”¨å±‚>> {
            - curveManager: CurveManager*
            - algorithmService: AlgorithmService*
            --
            + handleRegionSelection(id, start, end): void
            + handlePointClick(id, idx): void
            + calculatePeakArea(region): double
            + updateChartDisplay(): void
        }
    }
    
    package "Services" {
        class ProjectManager <<åº”ç”¨å±‚>> {
            - currentProject: ThermalProject*
            - recentProjects: QStringList
            - isModified: bool
            --
            + createProject(): ThermalProject*
            + openProject(path: QString): bool
            + saveProject(path: QString): bool
            + closeProject(): bool
            + getRecentProjects(): QStringList
            --
            <<signal>> projectOpened(project)
            <<signal>> projectSaved()
            <<signal>> projectModified()
        }
        
        class CurveManager <<åº”ç”¨å±‚>> {
            - curves: QMap<QString, ThermalCurve*>
            - activeCurveId: QString
            --
            + addCurve(curve: ThermalCurve*): QString
            + removeCurve(id: QString): void
            + getCurve(id: QString): ThermalCurve*
            + getActiveCurve(): ThermalCurve*
            + setActiveCurve(id: QString): void
            --
            <<signal>> curveAdded(id, curve)
            <<signal>> curveRemoved(id)
            <<signal>> curveDataChanged(id)
            <<signal>> activeCurveChanged(id)
        }
        
        class AlgorithmService <<åº”ç”¨å±‚>> {
            - algorithms: QMap<QString, IThermalAlgorithm*>
            - threadPool: QThreadPool*
            --
            + registerAlgorithm(algo): void
            + getAlgorithm(name): IThermalAlgorithm*
            + executeAsync(algo, data, callback): void
            + getAlgorithmList(): QStringList
            --
            <<signal>> algorithmStarted(name)
            <<signal>> algorithmFinished(name, result)
            <<signal>> algorithmProgress(percent)
        }
        
        class HistoryManager <<åº”ç”¨å±‚>> {
            - undoStack: QStack<ICommand*>
            - redoStack: QStack<ICommand*>
            - maxHistorySize: int
            --
            + execute(cmd: ICommand*): bool
            + undo(): void
            + redo(): void
            + canUndo(): bool
            + canRedo(): bool
            + getHistory(): QList<QString>
            --
            <<signal>> historyChanged()
        }
    }
    
    MainController --> ProjectManager
    MainController --> CurveManager
    MainController --> AlgorithmService
    MainController --> HistoryManager
    ChartController --> CurveManager
    ChartController --> AlgorithmService
}

' ========== é¢†åŸŸå±‚ (Domain Layer) ==========
package "ğŸ¯ é¢†åŸŸå±‚" <<é¢†åŸŸå±‚>> {
    
    package "Data Models" {
        class ThermalDataPoint <<é¢†åŸŸå±‚>> {
            - temperature: double
            - value: double
            - time: double
            - metadata: QVariantMap
            --
            + getTemperature(): double
            + getValue(): double
            + getTime(): double
            + getMetadata(key): QVariant
        }
        
        class ThermalCurve <<é¢†åŸŸå±‚>> {
            - id: QString
            - name: QString
            - rawData: QVector<ThermalDataPoint>
            - processedData: QVector<ThermalDataPoint>
            - metadata: QVariantMap
            --
            + getRawData(): const QVector<ThermalDataPoint>&
            + getProcessedData(): QVector<ThermalDataPoint>&
            + setProcessedData(data): void
            + resetToRaw(): void
            + getName(): QString
            + setName(name): void
            + getMetadata(): QVariantMap
        }
        
        class ThermalProject <<é¢†åŸŸå±‚>> {
            - name: QString
            - curves: QList<QString>
            - settings: QVariantMap
            - notes: QString
            - createdDate: QDateTime
            --
            + addCurve(curveId): void
            + removeCurve(curveId): void
            + getCurves(): QList<QString>
            + getSettings(): QVariantMap
            + setSettings(settings): void
        }
        
        ThermalCurve *-- "many" ThermalDataPoint
        ThermalProject o-- "many" ThermalCurve
    }
    
    package "Algorithm Interfaces" {
        interface IThermalAlgorithm <<é¢†åŸŸå±‚>> {
            {abstract} + process(data): QVector<ThermalDataPoint>
            {abstract} + name(): QString
            {abstract} + category(): QString
            {abstract} + parameters(): QVariantMap
            {abstract} + setParameters(params): void
        }
        
        interface ICommand <<é¢†åŸŸå±‚>> {
            {abstract} + execute(): bool
            {abstract} + undo(): void
            {abstract} + redo(): void
            {abstract} + description(): QString
        }
    }
}

' ========== åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer) ==========
package "ğŸ”§ åŸºç¡€è®¾æ–½å±‚" <<åŸºç¡€è®¾æ–½å±‚>> {
    
    package "FileIO" {
        interface IFileReader <<åŸºç¡€è®¾æ–½å±‚>> {
            {abstract} + canRead(path): bool
            {abstract} + read(path): ThermalCurve*
            {abstract} + supportedFormats(): QStringList
        }
        
        class TAInstrumentsReader <<åŸºç¡€è®¾æ–½å±‚>> {
            + canRead(path): bool
            + read(path): ThermalCurve*
            + supportedFormats(): QStringList
        }
        
        class MettlerToledoReader <<åŸºç¡€è®¾æ–½å±‚>> {
            + canRead(path): bool
            + read(path): ThermalCurve*
            + supportedFormats(): QStringList
        }
        
        class FileReaderFactory <<åŸºç¡€è®¾æ–½å±‚>> {
            - readers: QList<IFileReader*>
            --
            + registerReader(reader): void
            + getReader(path): IFileReader*
            + {static} instance(): FileReaderFactory*
        }
        
        interface IFileWriter <<åŸºç¡€è®¾æ–½å±‚>> {
            {abstract} + write(curve, path): bool
        }

        class FileWriterFactory <<åŸºç¡€è®¾æ–½å±‚>> {
            - writers: QList<IFileWriter*>
            --
            + getWriter(path): IFileWriter*
        }
        
        IFileReader <|.. TAInstrumentsReader
        IFileReader <|.. MettlerToledoReader
        FileReaderFactory o-- IFileReader
        FileWriterFactory o-- IFileWriter
    }
    
    package "Algorithm" {
        class BaselineCorrector <<åŸºç¡€è®¾æ–½å±‚>> {
            - method: QString
            - degree: int
            --
            + process(data): QVector<ThermalDataPoint>
            + linearBaseline(data): QVector
            + polynomialFit(data, degree): QVector
            + splineInterpolation(data): QVector
        }
        
        class SmoothingAlgorithm <<åŸºç¡€è®¾æ–½å±‚>> {
            - windowSize: int
            - method: QString
            --
            + process(data): QVector<ThermalDataPoint>
            + movingAverage(data): QVector
            + savitzkyGolay(data): QVector
        }
        
        class PeakDetector <<åŸºç¡€è®¾æ–½å±‚>> {
            - threshold: double
            - minPeakDistance: int
            --
            + process(data): QVector<ThermalDataPoint>
            + detectPeaks(data): QVector<Peak>
            + calculatePeakArea(peak): double
            + findPeakBoundaries(peak): QPair
        }
        
        class KineticsAnalyzer <<åŸºç¡€è®¾æ–½å±‚>> {
            - model: QString
            - heatingRate: double
            --
            + process(data): QVector<ThermalDataPoint>
            + calculateActivationEnergy(data): double
            + calculatePreExponentialFactor(data): double
            + fitKineticModel(data): Result
        }
        
        IThermalAlgorithm <|.. BaselineCorrector
        IThermalAlgorithm <|.. SmoothingAlgorithm
        IThermalAlgorithm <|.. PeakDetector
        IThermalAlgorithm <|.. KineticsAnalyzer
    }
    
    package "Utility" {
        class DataDecimator <<åŸºç¡€è®¾æ–½å±‚>> {
            - algorithm: QString
            - targetPoints: int
            --
            + decimate(data, level): QVector<ThermalDataPoint>
            + douglasPeucker(data, epsilon): QVector
            + lttbDecimate(data, targetCount): QVector
            + adaptiveDecimate(data, zoom): QVector
        }
        
        class DataInterpolator <<åŸºç¡€è®¾æ–½å±‚>> {
            - method: QString
            --
            + interpolate(data, x): double
            + linearInterpolation(data, x): double
            + splineInterpolation(data, x): double
            + resample(data, newRate): QVector
        }
        
        class StatisticsCalculator <<åŸºç¡€è®¾æ–½å±‚>> {
            + mean(data): double
            + stdDev(data): double
            + min(data): double
            + max(data): double
            + variance(data): double
            + findPeaks(data): QVector<int>
        }
    }
}

' ========== å±‚é—´ä¾èµ–å…³ç³» ==========
MainWindow ..> MainController : <<ä¿¡å·æ§½>>
ChartView ..> ChartController : <<ä¿¡å·æ§½>>
ToolPanel ..> MainController : <<ä¿¡å·æ§½>>

MainController ..> ThermalProject : ä½¿ç”¨
MainController ..> ThermalCurve : ä½¿ç”¨

ProjectManager ..> ThermalProject : ç®¡ç†
CurveManager ..> ThermalCurve : ç®¡ç†
AlgorithmService ..> IThermalAlgorithm : ä½¿ç”¨
HistoryManager ..> ICommand : æ‰§è¡Œ

AlgorithmService ..> BaselineCorrector : è°ƒç”¨
AlgorithmService ..> SmoothingAlgorithm : è°ƒç”¨
AlgorithmService ..> PeakDetector : è°ƒç”¨
AlgorithmService ..> KineticsAnalyzer : è°ƒç”¨

ProjectManager ..> FileReaderFactory : ä½¿ç”¨
ProjectManager ..> FileWriterFactory : ä½¿ç”¨

ChartView ..> DataDecimator : ä½¿ç”¨
ChartView ..> DataInterpolator : ä½¿ç”¨

FileWriterFactory o-- IFileWriter

' æ·»åŠ æ³¨é‡Šè¯´æ˜
note right of MainWindow
  <b>è¡¨ç¤ºå±‚èŒè´£:</b>
  Â· ç”¨æˆ·ç•Œé¢å±•ç¤º
  Â· ç”¨æˆ·äº¤äº’å“åº”
  Â· å‘å‡ºæ“ä½œä¿¡å·
  Â· ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
end note

note right of MainController
  <b>åº”ç”¨å±‚èŒè´£:</b>
  Â· ä¸šåŠ¡æµç¨‹åè°ƒ
  Â· è·¨æœåŠ¡è°ƒåº¦
  Â· ç”¨æˆ·æ“ä½œå¤„ç†
  Â· çŠ¶æ€ç®¡ç†
end note

note right of ThermalCurve
  <b>é¢†åŸŸå±‚èŒè´£:</b>
  Â· æ ¸å¿ƒä¸šåŠ¡æ¨¡å‹
  Â· ä¸šåŠ¡è§„åˆ™å®šä¹‰
  Â· ç®—æ³•æ¥å£æŠ½è±¡
  Â· é¢†åŸŸæ¦‚å¿µä½“ç°
  
  <b>æ•°æ®ä¸å¯å˜æ€§:</b>
  rawData - åªè¯»åŸå§‹æ•°æ®
  processedData - å¯ä¿®æ”¹å·¥ä½œæ•°æ®
end note

note right of BaselineCorrector
  <b>åŸºç¡€è®¾æ–½å±‚èŒè´£:</b>
  Â· æŠ€æœ¯å®ç°ç»†èŠ‚
  Â· ç®—æ³•å…·ä½“ä»£ç 
  Â· æ–‡ä»¶I/Oæ“ä½œ
  Â· å·¥å…·ç±»æ”¯æŒ
  Â· æ— ä¸šåŠ¡é€»è¾‘
end note

legend right
  |<#E3F2FD> è¡¨ç¤ºå±‚ | UIç»„ä»¶ (Qt Widgets/QML) |
  |<#F3E5F5> åº”ç”¨å±‚ | ä¸šåŠ¡åè°ƒå’ŒæœåŠ¡ |
  |<#FFF3E0> é¢†åŸŸå±‚ | æ ¸å¿ƒæ¨¡å‹å’Œæ¥å£ |
  |<#E8F5E9> åŸºç¡€è®¾æ–½å±‚ | æŠ€æœ¯å®ç° |

  <b>ä¾èµ–æ–¹å‘:</b> ä¸Šå±‚ â†’ ä¸‹å±‚
  <b>é€šä¿¡æ–¹å¼:</b>
  Â· ä¿¡å·æ§½ (Signal-Slot)
  Â· ç›´æ¥è°ƒç”¨ (Direct Call)
  Â· ä¾èµ–æ³¨å…¥ (Dependency Injection)
end legend

@enduml
