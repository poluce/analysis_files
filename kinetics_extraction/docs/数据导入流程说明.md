# TG分析软件 - 动力学数据导入流程

## 概述

本文档说明TG分析软件中**动力学文件数据的读取和导入流程**，仅包含核心的文件读取、解析和数据传递部分。

---

## 提取的文件

```
kinetics_extraction/
├── src/
│   ├── form.cpp                           # 数据导入窗口实现 (274行)
│   ├── form.h                             # 数据导入窗口头文件 (58行)
│   ├── form.ui                            # 数据导入窗口UI布局 (855行)
│   └── mainwindow_data_import_snippet.cpp # MainWindow中数据接收代码片段
└── docs/
    └── 数据导入流程说明.md                 # 本文档
```

---

## 完整数据导入流程

### 流程图

```
┌─────────────┐
│  用户操作   │
└──────┬──────┘
       │
       │ 1. 点击"打开文件"按钮
       ▼
┌─────────────────────────────────┐
│   MainWindow::on_toolButtonOpen_clicked()
│   - 创建Form窗口
│   - 连接dataReady信号
│   - 显示Form窗口
└──────┬──────────────────────────┘
       │
       │ 2. Form窗口显示
       ▼
┌─────────────────────────────────┐
│   Form窗口（数据导入界面）
│   - 点击"..."按钮选择文件
│   - 调用 on_pushButton_3_clicked()
└──────┬──────────────────────────┘
       │
       │ 3. 打开文件选择对话框
       ▼
┌─────────────────────────────────┐
│   QFileDialog::getOpenFileName()
│   - 支持 *.txt, *.csv 格式
└──────┬──────────────────────────┘
       │
       │ 4. 用户选择文件
       ▼
┌─────────────────────────────────┐
│   文件读取和解析
│   - 判断文件格式 (CSV/TXT)
│   - 读取文件内容 (QFile + QTextStream)
│   - 识别表头行（字母/中文开头）
│   - 识别数据行（数字开头）
│   - 确定分隔符（CSV用逗号，TXT用空格）
└──────┬──────────────────────────┘
       │
       │ 5. 解析完成
       ▼
┌─────────────────────────────────┐
│   在tableWidget中显示数据
│   - 设置表头
│   - 填充数据行
│   - 初始化列选择下拉框
└──────┬──────────────────────────┘
       │
       │ 6. 用户配置列映射
       │    - 选择温度列
       │    - 选择时间列
       │    - 选择信号列
       │    - 可选：选择速率列
       ▼
┌─────────────────────────────────┐
│   用户点击"导入"按钮
│   调用 on_pushButton_clicked()
└──────┬──────────────────────────┘
       │
       │ 7. 提取选定列数据
       ▼
┌─────────────────────────────────┐
│   构建QVariantMap数据结构
│   {
│     "温度": [100.0, 150.0, ...],
│     "时间": [0.0, 0.5, ...],
│     "TG": [100.0, 98.5, ...],
│     "速率": [10.0, ...]  // 可选
│   }
└──────┬──────────────────────────┘
       │
       │ 8. emit dataReady(QVariantMap)
       ▼
┌─────────────────────────────────┐
│   MainWindow::onDataReady()
│   - 接收QVariantMap数据
│   - 转换数据格式
│   - 重命名键名（添加索引）
│   - 添加到dataList
│   - 更新UI树状控件
└──────┬──────────────────────────┘
       │
       │ 9. 数据导入完成
       ▼
┌─────────────────────────────────┐
│   数据已存储在 dataList 中
│   可用于后续的动力学计算
└─────────────────────────────────┘
```

---

## 核心代码说明

### 1. Form窗口 - 文件读取和解析

#### 文件选择 (form.cpp:49-144)

```cpp
void Form::on_pushButton_3_clicked()
{
    // 1. 打开文件对话框
    QString fileName = QFileDialog::getOpenFileName(
        this, tr("选择文件"), "./",
        tr("Text Files (*.txt);;Comma-Separated Values (*.csv);;All Files (*)"));

    if (fileName.isEmpty())
        return;

    // 2. 显示文件路径
    ui->textEdit->setText(fileName);

    // 3. 打开文件
    QFile file(fileName);
    if (!file.open(QIODevice::ReadOnly | QIODevice::Text)) {
        QMessageBox::information(this, tr("Unable to open file"), file.errorString());
        return;
    }

    // 4. 判断分隔符
    const bool isCsv = fileName.endsWith(".csv", Qt::CaseInsensitive);
    auto splitLine = [&](const QString& s) -> QStringList {
        if (isCsv)
            return s.split(',', Qt::KeepEmptyParts);  // CSV用逗号
        return s.split(QRegExp("\\s+"), Qt::SkipEmptyParts);  // TXT用空白
    };

    // 5. 读取并分类行
    QStringList headerLines;  // 表头行
    QStringList dataLines;    // 数据行
    QTextStream in(&file);

    while (!in.atEnd()) {
        const QString line = in.readLine();
        const QString t = line.trimmed();
        if (t.isEmpty())
            continue;

        QChar c = t.at(0);
        // 判断是表头还是数据
        if (c.isLetter() || (c.unicode() >= 0x4e00 && c.unicode() <= 0x9fff)) {
            headerLines.append(t);  // 字母或中文开头 -> 表头
        } else {
            dataLines.append(t);     // 其他 -> 数据行
        }
    }
    file.close();

    // 6. 显示表头
    ui->textBrowser->setText(headerLines.join("\n"));

    // 7. 解析并显示数据
    const QStringList firstDataCols = splitLine(dataLines.at(0));
    const int colCount = firstDataCols.size();
    const int rowCount = dataLines.size();

    ui->tableWidget->clear();
    ui->tableWidget->setColumnCount(colCount);
    ui->tableWidget->setRowCount(rowCount);

    // 8. 设置表头（序号+名字）
    QStringList headerCols;
    if (!headerLines.isEmpty()) {
        headerCols = splitLine(headerLines.last());
    }
    QStringList headerLabels;
    for (int j = 0; j < colCount; ++j) {
        QString name = (j < headerCols.size() && !headerCols.at(j).trimmed().isEmpty())
            ? headerCols.at(j).trimmed()
            : tr("列%1").arg(j + 1);
        headerLabels << tr("%1:%2").arg(j + 1).arg(name);  // "1:Temperature"
    }
    ui->tableWidget->setHorizontalHeaderLabels(headerLabels);

    // 9. 填充数据
    for (int i = 0; i < dataLines.size(); ++i) {
        const QStringList cols = splitLine(dataLines.at(i));
        for (int j = 0; j < colCount; ++j) {
            const QString v = (j < cols.size()) ? cols.at(j).trimmed() : QString();
            ui->tableWidget->setItem(i, j, new QTableWidgetItem(v));
        }
    }

    // 10. 初始化列选择下拉框
    ui->comboBox->clear();
    ui->comboBox_3->clear();
    ui->comboBox_5->clear();
    ui->comboBox_8->clear();
    for (int i = 1; i <= colCount; ++i) {
        const QString s = QString::number(i);
        ui->comboBox->addItem(s);      // 温度列
        ui->comboBox_3->addItem(s);    // 时间列
        ui->comboBox_5->addItem(s);    // 信号列
        ui->comboBox_8->addItem(s);    // 速率列
    }
}
```

**关键点**：
- **分隔符识别**: CSV文件用逗号，TXT文件用空白符
- **表头识别**: 以字母或中文开头的行
- **数据行识别**: 以数字开头的行
- **UI显示**: 在QTableWidget中显示解析后的数据

---

#### 数据提交 (form.cpp:145-224)

```cpp
void Form::on_pushButton_clicked()
{
    // 1. 检查必选项
    if (ui->checkBox->isChecked() && ui->checkBox_3->isChecked()) {
        // 2. 获取选择的列号（从1开始，需要减1转为索引）
        int column1 = ui->comboBox->currentText().toInt() - 1;    // 温度列
        int column2 = ui->comboBox_3->currentText().toInt() - 1;  // 时间列
        int column3 = ui->comboBox_5->currentText().toInt() - 1;  // 信号列
        int column4 = ui->comboBox_8->currentText().toInt() - 1;  // 速率列

        QVariantMap columnsData;  // 数据容器

        QList<QVariant> temperatureData;
        QList<QVariant> timeData;
        QList<QVariant> customData;
        QList<QVariant> velocityData;

        // 3. 从表格中提取数据
        for (int i = 0; i < ui->tableWidget->rowCount(); ++i) {
            // 温度
            if (ui->tableWidget->item(i, column1)) {
                double tempValue = ui->tableWidget->item(i, column1)->text().toDouble();
                temperatureData << tempValue;
            }

            // 时间（乘以0.1转换单位）
            if (ui->tableWidget->item(i, column2)) {
                double timeValue = ui->tableWidget->item(i, column2)->text().toDouble();
                timeData << timeValue * 0.1;
            }

            // 信号列（TG/DTA等）
            if (ui->tableWidget->item(i, column3)) {
                double customValue = ui->tableWidget->item(i, column3)->text().toDouble();
                customData << customValue;
            }

            // 速率列（可选）
            if (ui->checkBox_5->isChecked() && ui->tableWidget->item(i, column4)) {
                double velocityValue = ui->tableWidget->item(i, column4)->text().toDouble();
                velocityData << velocityValue;
            }
        }

        // 4. 检查信号列名称和单位
        QString customColumnName = ui->lineEdit_5->text();
        if (customColumnName.isEmpty()) {
            QMessageBox::warning(this, "警告", "信号列名字不能为空。");
            return;
        }
        QString customColumnName1 = ui->lineEdit_4->text();
        if (customColumnName1.isEmpty()) {
            QMessageBox::warning(this, "警告", "信号列单位不能为空。");
            return;
        }

        // 5. 构建数据Map
        columnsData["温度"] = QVariant(temperatureData);
        columnsData["时间"] = QVariant(timeData);
        columnsData[customColumnName] = QVariant(customData);

        if (!velocityData.isEmpty()) {
            columnsData["速率"] = QVariant(velocityData);
        }

        // 6. 发射信号，传递数据
        emit dataReady(columnsData);
        this->close();  // 关闭窗口
    } else {
        // 未勾选必选项
        if (!ui->checkBox->isChecked()) {
            QMessageBox::warning(this, "警告", "请选择温度列！");
        }
        if (!ui->checkBox_3->isChecked()) {
            QMessageBox::warning(this, "警告", "请选择信号列是否连续！");
        }
    }
}
```

**关键数据结构**：
```cpp
QVariantMap columnsData = {
    "温度": [100.0, 150.0, 200.0, ...],
    "时间": [0.0, 5.0, 10.0, ...],        // 注意：乘以了0.1
    "TG":   [100.0, 98.5, 95.2, ...],     // 信号列，名字可自定义
    "速率": [10.0, 10.0, 10.0, ...]       // 可选
};
```

---

### 2. MainWindow - 数据接收

#### 打开Form窗口 (mainwindow.cpp:2097-2107)

```cpp
void MainWindow::on_toolButtonOpen_clicked()
{
    // 1. 创建Form窗口（如果不存在）
    if (!form) {
        form = new Form;
        // 2. 连接信号与槽
        connect(form, &Form::dataReady, this, &MainWindow::onDataReady);
    }
    // 3. 显示窗口
    form->show();
}
```

---

#### 接收数据 (mainwindow.cpp:2032-2096)

```cpp
void MainWindow::onDataReady(const QVariantMap& data)
{
    // 1. 获取当前数据集的索引（用于区分多个导入文件）
    int index = dataList.size() + 1;

    // 2. 重命名键名，添加索引
    QVariantMap newData;
    temperatureKey = QString("温度%1").arg(index);      // "温度1", "温度2", ...
    timeKey = QString("时间%1").arg(index);            // "时间1", "时间2", ...
    customColumnKey = QString("%1%2").arg(form->lineEdit_5()).arg(index);  // "TG1", "TG2", ...
    velocityKey = QString("速率%1").arg(index);        // "速率1", "速率2", ...

    // 3. 转换数据格式：QVariantList -> QList<double>
    QList<double> temperatureData;
    QList<double> timeData;
    QList<double> customData;
    QList<double> velocityData;

    // 温度数据
    foreach (const QVariant& v, data.value("温度").toList()) {
        temperatureData << v.toDouble();
    }
    // 时间数据
    foreach (const QVariant& v, data.value("时间").toList()) {
        timeData << v.toDouble();
    }
    // 信号数据（TG/DTA等）
    foreach (const QVariant& v, data.value(form->lineEdit_5()).toList()) {
        customData << v.toDouble();
    }
    // 速率数据（可选）
    if (data.contains("速率")) {
        foreach (const QVariant& v, data.value("速率").toList()) {
            velocityData << v.toDouble();
        }
    }

    // 4. 存储转换后的数据（使用新的键名）
    newData[temperatureKey] = QVariant::fromValue(temperatureData);
    newData[timeKey] = QVariant::fromValue(timeData);
    newData[customColumnKey] = QVariant::fromValue(customData);
    if (!velocityData.isEmpty()) {
        newData[velocityKey] = QVariant::fromValue(velocityData);
    }

    // 5. 添加到全局数据列表
    this->dataList.append(newData);

    // 6. 获取文件路径
    QString textFromLineEdit = form->textEdit();

    // 7. 更新UI树状控件（显示导入的数据）
    QTreeWidgetItem* textEditItem = new QTreeWidgetItem(ui->treeWidget);
    textEditItem->setText(0, textFromLineEdit);  // 显示文件路径
    textEditItem->setToolTip(0, textFromLineEdit);
    textEditItem->setFlags(Qt::ItemIsSelectable | Qt::ItemIsEnabled);

    // 添加子项：温度
    QTreeWidgetItem* temperatureItem = new QTreeWidgetItem(textEditItem);
    temperatureItem->setText(0, temperatureKey);
    temperatureItem->setFlags(temperatureItem->flags() | Qt::ItemIsUserCheckable);
    temperatureItem->setCheckState(0, Qt::Unchecked);

    // 添加子项：时间
    QTreeWidgetItem* timeItem = new QTreeWidgetItem(textEditItem);
    timeItem->setText(0, timeKey);
    timeItem->setFlags(timeItem->flags() | Qt::ItemIsUserCheckable);
    timeItem->setCheckState(0, Qt::Unchecked);

    // 添加子项：信号
    QTreeWidgetItem* customColumnItem = new QTreeWidgetItem(textEditItem);
    customColumnItem->setText(0, customColumnKey);
    customColumnItem->setFlags(customColumnItem->flags() | Qt::ItemIsUserCheckable);
    customColumnItem->setCheckState(0, Qt::Unchecked);
}
```

**数据转换说明**：
```
Form发送的数据:
{
  "温度": [100.0, 150.0, ...],
  "时间": [0.0, 5.0, ...],
  "TG": [100.0, 98.5, ...]
}

MainWindow存储的数据:
{
  "温度1": [100.0, 150.0, ...],
  "时间1": [0.0, 5.0, ...],
  "TG1": [100.0, 98.5, ...]
}
```

---

## 数据格式要求

### 支持的文件格式

#### TXT文件
```
Temperature  Time   TG      DTG
100.0       0.0    100.0   0.0
150.0       50.0   98.5    -3.0
200.0       100.0  95.2    -6.6
```

#### CSV文件
```
Temperature,Time,TG,DTG
100.0,0.0,100.0,0.0
150.0,50.0,98.5,-3.0
200.0,100.0,95.2,-6.6
```

### 数据要求

| 项目 | 说明 |
|------|------|
| 表头 | 以字母或中文开头，如 "Temperature" 或 "温度" |
| 数据行 | 以数字开头 |
| 分隔符 | CSV用逗号，TXT用空格或制表符 |
| 必需列 | 温度、时间、至少一个信号列（TG/DTA等） |
| 可选列 | 加热速率 |

---

## Qt依赖

```cpp
#include <QWidget>
#include <QFile>
#include <QFileDialog>
#include <QTextStream>
#include <QTableWidget>
#include <QTreeWidget>
#include <QVariantMap>
#include <QMessageBox>
```

---

## 信号与槽

```cpp
// Form窗口
signals:
    void dataReady(const QVariantMap &data);

// MainWindow
private slots:
    void onDataReady(const QVariantMap& data);

// 连接
connect(form, &Form::dataReady, this, &MainWindow::onDataReady);
```

---

## 常见问题

### 1. 时间单位为什么乘以0.1？
```cpp
timeData << timeValue * 0.1;
```
这是硬编码的单位转换，可能需要根据实际情况调整。

### 2. 如何支持多文件导入？
`dataList` 是一个 `QList<QVariantMap>`，每次导入都会添加一个新的 `QVariantMap`，通过索引区分不同文件。

### 3. 数据存储在哪里？
```cpp
QList<QVariantMap> dataList;  // MainWindow的成员变量
```
每个文件的数据存储为一个 `QVariantMap`，包含温度、时间、信号等数据。

---

## 重构建议

1. **文件解析器独立**
   ```cpp
   class DataFileParser {
   public:
       static QVariantMap parseFile(const QString& filePath);
   };
   ```

2. **数据模型类**
   ```cpp
   class TGData {
   public:
       QList<double> temperature;
       QList<double> time;
       QList<double> signal;
       QString fileName;
   };
   ```

3. **错误处理增强**
   - 文件不存在
   - 格式错误
   - 数据为空

---

## 总结

这套代码实现了完整的动力学文件数据导入流程：
1. ✓ 文件选择（支持TXT/CSV）
2. ✓ 自动解析（识别表头和数据）
3. ✓ UI配置（列映射）
4. ✓ 数据传递（信号槽机制）
5. ✓ 数据存储（QVariantMap）

代码简洁清晰，适合作为重构的基础。
