# ç®—æ³•æ¡†æ¶é‡æ„ä¼˜åŒ–æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v3.0ï¼ˆå…¨æ–°æ¶æ„ï¼Œæ— å…¼å®¹å±‚ï¼‰
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-18
> **çŠ¶æ€**: å¾…å®æ–½
> **æ ¸å¿ƒåŸåˆ™**: å½»åº•é‡æ„ï¼Œä¸åšå…¼å®¹ï¼Œç›´æ¥åˆ‡åˆ°"çº¯ä¸Šä¸‹æ–‡ + è‡ªæè¿° + ç»Ÿä¸€ç»“æœ"æ¶æ„

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### âœ… å¿…é¡»éµå®ˆ

1. **å•ä¸€æ•°æ®æº** - åªä½¿ç”¨é¢†åŸŸå±‚çš„ `AlgorithmDescriptor`
2. **æ— å…¼å®¹å±‚** - ç›´æ¥åˆ‡æ¢åˆ°æ–°æ¶æ„ï¼Œä¸ä¿ç•™æ—§ä»£ç 
3. **ç®€æ´åº”ç”¨å±‚** - é¿å…è¾…åŠ©ç±»ç´¯ç§¯
4. **ç®—æ³•è‡ªæè¿°** - ç®—æ³•è‡ªå·±æä¾› `descriptor()`

### âŒ ä¸¥æ ¼ç¦æ­¢

1. **ç¦æ­¢åˆ›å»ºé€‚é…å™¨** - ä¸è¦åˆ›å»º `DescriptorAdapter` ä¹‹ç±»çš„ç±»
2. **ç¦æ­¢åŒé‡è·¯å¾„** - ä¸è¦ä¿ç•™æ—§çš„æ‰§è¡Œè·¯å¾„
3. **ç¦æ­¢é‡å¤å®šä¹‰** - ä¸è¦åœ¨åº”ç”¨å±‚é‡å¤å®šä¹‰æè¿°ç¬¦
4. **ç¦æ­¢å…ƒæ•°æ®æ³¨å†Œè¡¨** - ç®—æ³•è‡ªæè¿°å³å¯

---

## ç›®å½•

- [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
- [äºŒã€å½“å‰é—®é¢˜åˆ†æ](#äºŒå½“å‰é—®é¢˜åˆ†æ)
- [ä¸‰ã€æ ¸å¿ƒè®¾è®¡ç†å¿µ](#ä¸‰æ ¸å¿ƒè®¾è®¡ç†å¿µ)
- [å››ã€è®¾è®¡æ–¹æ¡ˆ](#å››è®¾è®¡æ–¹æ¡ˆ)
  - [4.1 ç®—æ³•è‡ªæè¿°æœºåˆ¶](#41-ç®—æ³•è‡ªæè¿°æœºåˆ¶)
  - [4.2 åŠ¨æ€å‚æ•°å¯¹è¯æ¡†](#42-åŠ¨æ€å‚æ•°å¯¹è¯æ¡†)
  - [4.3 ç®€åŒ–çš„ AlgorithmCoordinator](#43-ç®€åŒ–çš„-algorithmcoordinator)
- [äº”ã€åˆ é™¤å’Œç®€åŒ–æ¸…å•](#äº”åˆ é™¤å’Œç®€åŒ–æ¸…å•)
- [å…­ã€å®Œæ•´å®æ–½è®¡åˆ’](#å…­å®Œæ•´å®æ–½è®¡åˆ’)
- [ä¸ƒã€ä»£ç ç¤ºä¾‹](#ä¸ƒä»£ç ç¤ºä¾‹)
- [å…«ã€é¢„æœŸæ”¶ç›Š](#å…«é¢„æœŸæ”¶ç›Š)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 é‡æ„ç›®æ ‡

æœ¬æ¬¡é‡æ„æ—¨åœ¨**å½»åº•ç®€åŒ–ç®—æ³•æ‰§è¡Œæ¡†æ¶**ï¼Œé€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒè®¾è®¡ï¼š

1. **ç®—æ³•å®Œå…¨è‡ªæè¿°** - ç®—æ³•å£°æ˜è‡ªå·±éœ€è¦ä»€ä¹ˆäº¤äº’
2. **åŠ¨æ€å‚æ•°å¯¹è¯æ¡†** - æ ¹æ®ç®—æ³•æè¿°è‡ªåŠ¨ç”Ÿæˆ UI
3. **ç®€åŒ– Coordinator** - å˜ä¸ºçº¯æ‰§è¡Œå™¨ï¼Œæ— åˆ¤æ–­é€»è¾‘

**å…³é”®å†³ç­–**ï¼š
- âŒ **ä¸åšå…¼å®¹å±‚** - ç›´æ¥åˆ‡æ¢åˆ°æ–°æ¶æ„
- âŒ **ä¸ä¿ç•™æ—§ä»£ç ** - åˆ é™¤æ‰€æœ‰å†—ä½™ç±»
- âŒ **ä¸åˆ›å»ºé€‚é…å™¨** - é¿å…æŠ€æœ¯å€ºåŠ¡ç´¯ç§¯

### 1.2 æ ¸å¿ƒç†å¿µ

> **ç®—æ³•çŸ¥é“è‡ªå·±éœ€è¦ä»€ä¹ˆï¼ŒCoordinator åªæ˜¯æŒ‰ç…§ç®—æ³•çš„è¦æ±‚æ¥æ‰§è¡Œã€‚**

```
ç®—æ³•è‡ªæè¿°ï¼ˆé¢†åŸŸå±‚ï¼‰
         â†“
ä¸Šä¸‹æ–‡é©±åŠ¨ï¼ˆåº”ç”¨å±‚ï¼‰
         â†“
åŠ¨æ€å¯¹è¯æ¡†ï¼ˆè‡ªåŠ¨ç”Ÿæˆ UIï¼‰
         â†“
ç»Ÿä¸€ç»“æœè¾“å‡ºï¼ˆé¢†åŸŸå±‚ï¼‰
```

---

## äºŒã€å½“å‰é—®é¢˜åˆ†æ

### 2.1 å…¼å®¹å±‚å †ç§¯é—®é¢˜

#### é‡å¤çš„æè¿°ç¬¦å®šä¹‰

**é¢†åŸŸå±‚**ï¼ˆdomain/algorithm/ï¼‰:
- âœ… `AlgorithmDescriptor` - ç®—æ³•è‡ªæè¿°ç»“æ„
- âœ… `AlgorithmParameterDefinition` - å‚æ•°å®šä¹‰

**åº”ç”¨å±‚**ï¼ˆapplication/algorithm/ï¼‰:
- âŒ `App::AlgorithmDescriptor` - **é‡å¤å®šä¹‰ï¼**
- âŒ `App::ParameterDescriptor` - **é‡å¤å®šä¹‰ï¼**
- âŒ `MetadataDescriptorRegistry` - **å†—ä½™æ³¨å†Œè¡¨ï¼**

**é—®é¢˜**: ä¸¤å¥—æè¿°ç¬¦ç³»ç»Ÿå¹¶å­˜ï¼Œå¯¼è‡´ä»£ç å†—ä½™å’Œç»´æŠ¤æˆæœ¬å¢åŠ ã€‚

---

### 2.2 ä»£ç é‡ç»Ÿè®¡

#### AlgorithmCoordinator

| æ–‡ä»¶ | è¡Œæ•° |
|------|------|
| AlgorithmCoordinator.h | 278 è¡Œ |
| AlgorithmCoordinator.cpp | 445 è¡Œ |
| **æ€»è®¡** | **723 è¡Œ** |

#### åº”ç”¨å±‚æ€»ä½“

| ç»„ä»¶ | æ–‡ä»¶æ•° | ä»£ç é‡ |
|------|--------|--------|
| **æ ¸å¿ƒæ–‡ä»¶** | 6 ä¸ª | ~800 è¡Œ |
| **å…ƒæ•°æ®ç›¸å…³** | 4 ä¸ª | ~460 è¡Œ |
| **å…¼å®¹é€‚é…** | 3 ä¸ª | ~200 è¡Œ |
| **å¯¹è¯æ¡†ç±»** | è‹¥å¹² | ~400 è¡Œ |
| **æ€»è®¡** | **15+ ä¸ª** | **~1700+ è¡Œ** |

---

### 2.3 å¤æ‚åº¦åˆ†æ

#### é—®é¢˜ 1: å¤æ‚çš„çŠ¶æ€ç®¡ç†

```cpp
enum class PendingPhase {
    None,
    AwaitParameters,   // ç­‰å¾…å‚æ•°è¾“å…¥
    AwaitPoints        // ç­‰å¾…ç‚¹é€‰
};

struct MetadataPendingRequest {
    QString algorithmName;
    QString curveId;
    QVariantMap parameters;
    bool needsPointSelection = false;
    int requiredPointCount = 0;
    QString pointSelectionHint;
    QVector<ThermalDataPoint> collectedPoints;
    PendingPhase phase = PendingPhase::None;  // âŒ å¤æ‚çŠ¶æ€æœº
};
```

#### é—®é¢˜ 2: Coordinator åšäº†å¤ªå¤šåˆ¤æ–­

```cpp
void AlgorithmCoordinator::runByName(const QString& algorithmName) {
    auto descriptor = descriptorFor(algorithmName);

    // âŒ Coordinator åœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å‚æ•°
    if (!descriptor.parameters.isEmpty()) {
        // è¯·æ±‚å‚æ•°å¯¹è¯æ¡†
    }

    // âŒ Coordinator åœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦ç‚¹é€‰
    if (descriptor.interaction == AlgorithmInteraction::PointSelection) {
        // è¯·æ±‚ç‚¹é€‰
    }

    // âŒ Coordinator åœ¨åˆ¤æ–­äº¤äº’é¡ºåº
    if (needsParameters && needsPoints) {
        // å…ˆå‚æ•°åç‚¹é€‰ï¼Ÿè¿˜æ˜¯åè¿‡æ¥ï¼Ÿ
    }
}
```

**è¿åå¼€é—­åŸåˆ™**ï¼š
- æ·»åŠ æ–°äº¤äº’ç±»å‹éœ€è¦ä¿®æ”¹ Coordinator
- Coordinator éœ€è¦ç†è§£ç®—æ³•çš„äº¤äº’é€»è¾‘

#### é—®é¢˜ 3: ä¸ºæ¯ä¸ªç®—æ³•å†™å¯¹è¯æ¡†ç±»

```cpp
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªç®—æ³•ä¸€ä¸ªå¯¹è¯æ¡†ç±»
class MovingAverageDialog : public QDialog {
    // 50-100 è¡Œä»£ç 
};

class BaselineCorrectionDialog : public QDialog {
    // åˆæ˜¯ 50-100 è¡Œä»£ç 
};
```

å‡è®¾ 5 ä¸ªç®—æ³•éœ€è¦å‚æ•°ï¼š**400 è¡Œå¯¹è¯æ¡†ä»£ç ï¼**

---

## ä¸‰ã€æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 3.1 ç®—æ³•å®Œå…¨è‡ªæè¿°

**ç®—æ³•é€šè¿‡ `descriptor()` å£°æ˜è‡ªå·±çš„äº¤äº’éœ€æ±‚**ï¼š

```cpp
class BaselineCorrectionAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "baseline_correction";
        desc.displayName = "åŸºçº¿æ ¡æ­£";

        // âœ… ç®—æ³•è‡ªå·±å‘Šè¯‰ Coordinator éœ€è¦ä»€ä¹ˆ
        desc.needsParameters = false;      // ä¸éœ€è¦å‚æ•°å¯¹è¯æ¡†
        desc.needsPointSelection = true;   // éœ€è¦ç‚¹é€‰
        desc.requiredPointCount = 2;       // éœ€è¦2ä¸ªç‚¹
        desc.pointSelectionHint = "è¯·é€‰æ‹©åŸºçº¿èµ·ç‚¹å’Œç»ˆç‚¹";

        return desc;
    }
};
```

### 3.2 åŠ¨æ€å‚æ•°å¯¹è¯æ¡†

**æ ¹æ®ç®—æ³•æè¿°è‡ªåŠ¨ç”Ÿæˆ QDialog**ï¼ˆQt å®˜æ–¹æ¨èæ–¹å¼ï¼‰ï¼š

```cpp
// MainController æ ¹æ® descriptor åŠ¨æ€åˆ›å»ºå¯¹è¯æ¡†
void MainController::onRequestParameterDialog(
    const QString& algorithmName,
    const AlgorithmDescriptor& descriptor)
{
    QDialog* dlg = new QDialog(m_mainWindow);
    QFormLayout* form = new QFormLayout(dlg);

    // âœ… æ ¹æ® descriptor.parameters è‡ªåŠ¨åˆ›å»ºæ§ä»¶
    for (const auto& param : descriptor.parameters) {
        QWidget* widget = createParameterWidget(param, dlg);
        form->addRow(param.displayName + ":", widget);
    }

    // æ— éœ€å†™å¯¹è¯æ¡†ç±»ï¼
}
```

### 3.3 Coordinator å˜ä¸ºçº¯æ‰§è¡Œå™¨

**å®Œå…¨ä¾èµ–ç®—æ³•çš„è‡ªæè¿°ä¿¡æ¯ï¼Œæ— åˆ¤æ–­é€»è¾‘**ï¼š

```cpp
class AlgorithmCoordinator {
    void run(const QString& algorithmName);  // å”¯ä¸€å…¥å£

private:
    void processNextStep() {
        // âœ… æŒ‰ç…§ç®—æ³•æè¿°çš„é¡ºåºæ‰§è¡Œï¼Œæ— åˆ¤æ–­é€»è¾‘
        QString step = order[currentStepIndex];

        if (step == "parameters") emit requestParameterDialog(...);
        if (step == "points") emit requestPointSelection(...);
    }
};
```

---

## å››ã€è®¾è®¡æ–¹æ¡ˆ

### 4.1 ç®—æ³•è‡ªæè¿°æœºåˆ¶

#### 4.1.1 å¢å¼ºçš„ AlgorithmDescriptorï¼ˆé¢†åŸŸå±‚ï¼‰

**æ–‡ä»¶**: `domain/algorithm/algorithm_descriptor.h`

```cpp
struct AlgorithmDescriptor {
    // ==================== åŸºæœ¬ä¿¡æ¯ ====================
    QString name;          // ç®—æ³•åç§°ï¼ˆå¦‚ "differentiation"ï¼‰
    QString displayName;   // æ˜¾ç¤ºåç§°ï¼ˆå¦‚ "å¾®åˆ†"ï¼‰
    QString category;      // åˆ†ç±»ï¼ˆå¦‚ "Analysis"ï¼‰

    // ==================== äº¤äº’éœ€æ±‚ï¼ˆç®—æ³•è‡ªæè¿°ï¼‰====================

    /**
     * @brief æ˜¯å¦éœ€è¦å‚æ•°å¯¹è¯æ¡†
     */
    bool needsParameters = false;

    /**
     * @brief å‚æ•°å®šä¹‰åˆ—è¡¨ï¼ˆå¦‚æœ needsParameters = trueï¼‰
     */
    QVector<AlgorithmParameterDefinition> parameters;

    /**
     * @brief æ˜¯å¦éœ€è¦ç‚¹é€‰äº¤äº’
     */
    bool needsPointSelection = false;

    /**
     * @brief æ‰€éœ€ç‚¹æ•°ï¼ˆå¦‚æœ needsPointSelection = trueï¼‰
     */
    int requiredPointCount = 0;

    /**
     * @brief ç‚¹é€‰æç¤ºä¿¡æ¯
     */
    QString pointSelectionHint;

    /**
     * @brief æ˜¯å¦éœ€è¦é€‰æ‹©ç¬¬äºŒæ¡æ›²çº¿ï¼ˆæœªæ¥æ‰©å±•ï¼‰
     */
    bool needsCurveSelection = false;

    /**
     * @brief äº¤äº’é¡ºåºï¼ˆå¦‚æœåŒæ—¶éœ€è¦å¤šç§äº¤äº’ï¼‰
     *
     * ä¾‹å¦‚ï¼š
     * - ["parameters", "points"] - å…ˆå‚æ•°å¯¹è¯æ¡†ï¼Œå†ç‚¹é€‰
     * - ["points", "parameters"] - å…ˆç‚¹é€‰ï¼Œå†å‚æ•°å¯¹è¯æ¡†
     * - ["points"] - åªéœ€è¦ç‚¹é€‰
     *
     * å¦‚æœä¸ºç©ºï¼Œåˆ™æŒ‰é»˜è®¤é¡ºåºï¼šparameters â†’ points â†’ curve
     */
    QStringList interactionOrder;
};
```

#### 4.1.2 ç®—æ³•è‡ªæè¿°ç¤ºä¾‹

**æ— éœ€äº¤äº’çš„ç®—æ³•ï¼ˆå¾®åˆ†ï¼‰**ï¼š

```cpp
class DifferentiationAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "differentiation";
        desc.displayName = "å¾®åˆ†";
        desc.category = "Analysis";

        // âœ… æ— éœ€ä»»ä½•äº¤äº’
        desc.needsParameters = false;
        desc.needsPointSelection = false;

        return desc;
    }
};

// æ‰§è¡Œæµç¨‹ï¼š
// run("differentiation") â†’ execute() â†’ å®Œæˆ
```

**éœ€è¦å‚æ•°çš„ç®—æ³•ï¼ˆç§»åŠ¨å¹³å‡ï¼‰**ï¼š

```cpp
class MovingAverageFilterAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "moving_average";
        desc.displayName = "ç§»åŠ¨å¹³å‡";
        desc.category = "Preprocessing";

        // âœ… éœ€è¦å‚æ•°å¯¹è¯æ¡†
        desc.needsParameters = true;
        desc.parameters = {
            {"windowSize", "çª—å£å¤§å°", ParameterType::Integer, 5, 1, 100}
        };

        // ä¸éœ€è¦ç‚¹é€‰
        desc.needsPointSelection = false;

        return desc;
    }
};

// æ‰§è¡Œæµç¨‹ï¼š
// run() â†’ requestParameterDialog() â†’ submitParameters() â†’ execute()
```

**éœ€è¦ç‚¹é€‰çš„ç®—æ³•ï¼ˆåŸºçº¿æ ¡æ­£ï¼‰**ï¼š

```cpp
class BaselineCorrectionAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "baseline_correction";
        desc.displayName = "åŸºçº¿æ ¡æ­£";
        desc.category = "Preprocessing";

        // ä¸éœ€è¦å‚æ•°å¯¹è¯æ¡†
        desc.needsParameters = false;

        // âœ… éœ€è¦ç‚¹é€‰
        desc.needsPointSelection = true;
        desc.requiredPointCount = 2;
        desc.pointSelectionHint = "è¯·é€‰æ‹©åŸºçº¿èµ·ç‚¹å’Œç»ˆç‚¹";

        return desc;
    }
};

// æ‰§è¡Œæµç¨‹ï¼š
// run() â†’ requestPointSelection() â†’ submitPoints() â†’ execute()
```

**éœ€è¦å‚æ•° + ç‚¹é€‰çš„ç®—æ³•ï¼ˆå³°é¢ç§¯ï¼‰**ï¼š

```cpp
class PeakAreaAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "peak_area";
        desc.displayName = "å³°é¢ç§¯";
        desc.category = "Analysis";

        // âœ… éœ€è¦å‚æ•°å¯¹è¯æ¡†
        desc.needsParameters = true;
        desc.parameters = {
            {"baselineType", "åŸºçº¿ç±»å‹", ParameterType::Enum,
             0, {"çº¿æ€§", "å¤šé¡¹å¼"}}
        };

        // âœ… éœ€è¦ç‚¹é€‰
        desc.needsPointSelection = true;
        desc.requiredPointCount = 2;
        desc.pointSelectionHint = "è¯·é€‰æ‹©å³°çš„èµ·ç‚¹å’Œç»ˆç‚¹";

        // âœ… äº¤äº’é¡ºåºï¼šå…ˆå‚æ•°ï¼Œå†ç‚¹é€‰
        desc.interactionOrder = {"parameters", "points"};

        return desc;
    }
};

// æ‰§è¡Œæµç¨‹ï¼š
// run() â†’ requestParameterDialog() â†’ submitParameters()
//       â†’ requestPointSelection() â†’ submitPoints() â†’ execute()
```

---

### 4.2 åŠ¨æ€å‚æ•°å¯¹è¯æ¡†

#### 4.2.1 Qt å®˜æ–¹æ¨èæ–¹å¼

```cpp
// âœ… Qt å®˜æ–¹æ¨èï¼šç›´æ¥ new QDialogï¼Œç”¨ FormLayout æ‘†æ§ä»¶
QDialog dlg;
QFormLayout form(&dlg);

QLineEdit *tempEdit = new QLineEdit(&dlg);
form.addRow("æ¸©åº¦ï¼š", tempEdit);

QPushButton *btn = new QPushButton("ç¡®å®š", &dlg);
form.addRow(btn);
QObject::connect(btn, &QPushButton::clicked, &dlg, &QDialog::accept);

if (dlg.exec() == QDialog::Accepted) {
    QString temp = tempEdit->text();
}
```

**ä¼˜åŠ¿**ï¼š
- æ— éœ€å†™å•ç‹¬çš„å¯¹è¯æ¡†ç±»
- ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- æ§ä»¶ç”Ÿå‘½å‘¨æœŸç”±å¯¹è¯æ¡†ç®¡ç†

#### 4.2.2 MainController ä¸­çš„å®ç°

```cpp
// main_controller.cpp
void MainController::onRequestParameterDialog(
    const QString& algorithmName,
    const AlgorithmDescriptor& descriptor)  // âœ… ç›´æ¥ä½¿ç”¨é¢†åŸŸå±‚æè¿°ç¬¦
{
    // ==================== åˆ›å»ºå¯¹è¯æ¡† ====================
    QDialog* dlg = new QDialog(m_mainWindow);
    dlg->setWindowTitle(descriptor.displayName + " - å‚æ•°è®¾ç½®");
    dlg->setMinimumWidth(400);

    QFormLayout* form = new QFormLayout(dlg);

    // ==================== å­˜å‚¨æ§ä»¶å¼•ç”¨ ====================
    QMap<QString, QWidget*> widgets;

    // ==================== åŠ¨æ€åˆ›å»ºå‚æ•°æ§ä»¶ ====================
    for (const auto& param : descriptor.parameters) {
        QWidget* widget = createParameterWidget(param, dlg);
        if (widget) {
            form->addRow(param.displayName + ":", widget);
            widgets[param.name] = widget;
        }
    }

    // ==================== æ·»åŠ æŒ‰é’® ====================
    QDialogButtonBox* buttonBox = new QDialogButtonBox(
        QDialogButtonBox::Ok | QDialogButtonBox::Cancel, dlg);
    form->addRow(buttonBox);

    connect(buttonBox, &QDialogButtonBox::accepted, dlg, &QDialog::accept);
    connect(buttonBox, &QDialogButtonBox::rejected, dlg, &QDialog::reject);

    // ==================== æ˜¾ç¤ºå¯¹è¯æ¡†å¹¶æå–å‚æ•° ====================
    if (dlg->exec() == QDialog::Accepted) {
        QVariantMap parameters = extractParameters(widgets, descriptor.parameters);
        m_algorithmCoordinator->submitParameters(parameters);
    } else {
        m_algorithmCoordinator->cancel();
    }

    dlg->deleteLater();
}
```

#### 4.2.3 è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºå‚æ•°æ§ä»¶

```cpp
QWidget* MainController::createParameterWidget(
    const AlgorithmParameterDefinition& param,
    QWidget* parent)
{
    switch (param.type) {

    // ==================== æ•´æ•°ç±»å‹ ====================
    case ParameterType::Integer:
        {
            QSpinBox* spinBox = new QSpinBox(parent);
            spinBox->setMinimum(param.minValue.toInt());
            spinBox->setMaximum(param.maxValue.toInt());
            spinBox->setValue(param.defaultValue.toInt());
            return spinBox;
        }

    // ==================== æµ®ç‚¹ç±»å‹ ====================
    case ParameterType::Double:
        {
            QDoubleSpinBox* spinBox = new QDoubleSpinBox(parent);
            spinBox->setMinimum(param.minValue.toDouble());
            spinBox->setMaximum(param.maxValue.toDouble());
            spinBox->setValue(param.defaultValue.toDouble());
            spinBox->setDecimals(3);
            return spinBox;
        }

    // ==================== å­—ç¬¦ä¸²ç±»å‹ ====================
    case ParameterType::String:
        {
            QLineEdit* lineEdit = new QLineEdit(parent);
            lineEdit->setText(param.defaultValue.toString());
            return lineEdit;
        }

    // ==================== å¸ƒå°”ç±»å‹ ====================
    case ParameterType::Boolean:
        {
            QCheckBox* checkBox = new QCheckBox(parent);
            checkBox->setChecked(param.defaultValue.toBool());
            return checkBox;
        }

    // ==================== æšä¸¾ç±»å‹ ====================
    case ParameterType::Enum:
        {
            QComboBox* comboBox = new QComboBox(parent);
            comboBox->addItems(param.enumOptions);
            comboBox->setCurrentIndex(param.defaultValue.toInt());
            return comboBox;
        }

    default:
        return nullptr;
    }
}
```

#### 4.2.4 è¾…åŠ©æ–¹æ³•ï¼šæå–å‚æ•°å€¼

```cpp
QVariantMap MainController::extractParameters(
    const QMap<QString, QWidget*>& widgets,
    const QVector<AlgorithmParameterDefinition>& paramDefs)
{
    QVariantMap parameters;

    for (const auto& param : paramDefs) {
        if (!widgets.contains(param.name)) continue;

        QWidget* widget = widgets[param.name];
        QVariant value;

        switch (param.type) {
        case ParameterType::Integer:
            if (QSpinBox* spinBox = qobject_cast<QSpinBox*>(widget)) {
                value = spinBox->value();
            }
            break;

        case ParameterType::Double:
            if (QDoubleSpinBox* spinBox = qobject_cast<QDoubleSpinBox*>(widget)) {
                value = spinBox->value();
            }
            break;

        case ParameterType::String:
            if (QLineEdit* lineEdit = qobject_cast<QLineEdit*>(widget)) {
                value = lineEdit->text();
            }
            break;

        case ParameterType::Boolean:
            if (QCheckBox* checkBox = qobject_cast<QCheckBox*>(widget)) {
                value = checkBox->isChecked();
            }
            break;

        case ParameterType::Enum:
            if (QComboBox* comboBox = qobject_cast<QComboBox*>(widget)) {
                value = comboBox->currentIndex();
            }
            break;
        }

        if (value.isValid()) {
            parameters[param.name] = value;
        }
    }

    return parameters;
}
```

---

### 4.3 ç®€åŒ–çš„ AlgorithmCoordinator

#### 4.3.1 ç®€åŒ–çš„æ•°æ®ç»“æ„

```cpp
// âœ… ç®€åŒ–çš„å¾…å¤„ç†è¯·æ±‚
struct PendingRequest {
    QString algorithmName;
    AlgorithmDescriptor descriptor;  // ç®—æ³•çš„å®Œæ•´è‡ªæè¿°ä¿¡æ¯
    QVariantMap parameters;          // å·²æ”¶é›†çš„å‚æ•°
    QVector<ThermalDataPoint> points; // å·²æ”¶é›†çš„ç‚¹
    int currentStepIndex = 0;        // å½“å‰äº¤äº’æ­¥éª¤ç´¢å¼•
};

std::optional<PendingRequest> m_pending;

// âŒ ç§»é™¤å¤æ‚çŠ¶æ€æœº
// enum class PendingPhase { None, AwaitParameters, AwaitPoints };
```

#### 4.3.2 æ ¸å¿ƒæ‰§è¡Œé€»è¾‘

```cpp
class AlgorithmCoordinator : public QObject {
    Q_OBJECT

public:
    /**
     * @brief å”¯ä¸€çš„æ‰§è¡Œå…¥å£
     */
    void run(const QString& algorithmName);

    /**
     * @brief ç”¨æˆ·æäº¤å‚æ•°åè°ƒç”¨
     */
    void submitParameters(const QVariantMap& parameters);

    /**
     * @brief ç”¨æˆ·å®Œæˆç‚¹é€‰åè°ƒç”¨
     */
    void submitPoints(const QVector<ThermalDataPoint>& points);

    /**
     * @brief å–æ¶ˆå½“å‰æ“ä½œ
     */
    void cancel();

signals:
    void requestParameterDialog(const QString& algorithmName,
                                const AlgorithmDescriptor& descriptor);
    void requestPointSelection(const QString& algorithmName,
                               int requiredCount, const QString& hint);
    void algorithmFinished(const QString& algorithmName,
                          const AlgorithmResult& result);
    void algorithmFailed(const QString& algorithmName,
                        const QString& reason);

private:
    /**
     * @brief å¤„ç†ä¸‹ä¸€ä¸ªäº¤äº’æ­¥éª¤
     */
    void processNextStep();

    /**
     * @brief æ‰§è¡Œç®—æ³•ï¼ˆæ‰€æœ‰äº¤äº’å®Œæˆåè°ƒç”¨ï¼‰
     */
    void execute();
};
```

#### 4.3.3 å®ç°ä»£ç 

```cpp
void AlgorithmCoordinator::run(const QString& algorithmName) {
    // 1. è·å–ç®—æ³•çš„è‡ªæè¿°ä¿¡æ¯
    auto descriptor = getDescriptor(algorithmName);
    if (!descriptor.has_value()) {
        emit algorithmFailed(algorithmName, "æ‰¾ä¸åˆ°ç®—æ³•");
        return;
    }

    // 2. åˆ›å»ºå¾…å¤„ç†è¯·æ±‚
    PendingRequest pending;
    pending.algorithmName = algorithmName;
    pending.descriptor = descriptor.value();
    pending.currentStepIndex = 0;
    m_pending = pending;

    // 3. å¼€å§‹å¤„ç†äº¤äº’æµç¨‹
    processNextStep();
}

void AlgorithmCoordinator::processNextStep() {
    if (!m_pending.has_value()) return;

    auto& pending = m_pending.value();
    auto& descriptor = pending.descriptor;

    // è·å–äº¤äº’é¡ºåº
    QStringList order = descriptor.interactionOrder;
    if (order.isEmpty()) {
        // é»˜è®¤é¡ºåº
        if (descriptor.needsParameters) order << "parameters";
        if (descriptor.needsPointSelection) order << "points";
    }

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äº¤äº’éƒ½å®Œæˆ
    if (pending.currentStepIndex >= order.size()) {
        execute();  // æ‰§è¡Œç®—æ³•
        return;
    }

    // å¤„ç†å½“å‰æ­¥éª¤
    QString currentStep = order[pending.currentStepIndex];

    if (currentStep == "parameters") {
        emit requestParameterDialog(pending.algorithmName, descriptor);

    } else if (currentStep == "points") {
        emit requestPointSelection(
            pending.algorithmName,
            descriptor.requiredPointCount,
            descriptor.pointSelectionHint);
    }
}

void AlgorithmCoordinator::submitParameters(const QVariantMap& parameters) {
    if (!m_pending.has_value()) return;

    // ä¿å­˜å‚æ•°
    m_pending->parameters = parameters;

    // ç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥
    m_pending->currentStepIndex++;
    processNextStep();
}

void AlgorithmCoordinator::submitPoints(const QVector<ThermalDataPoint>& points) {
    if (!m_pending.has_value()) return;

    // éªŒè¯ç‚¹æ•°
    if (points.size() < m_pending->descriptor.requiredPointCount) {
        emit algorithmFailed(m_pending->algorithmName,
            QString("éœ€è¦è‡³å°‘ %1 ä¸ªç‚¹").arg(m_pending->descriptor.requiredPointCount));
        return;
    }

    // ä¿å­˜ç‚¹é€‰ç»“æœ
    m_pending->points = points;

    // ç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥
    m_pending->currentStepIndex++;
    processNextStep();
}

void AlgorithmCoordinator::execute() {
    if (!m_pending.has_value()) return;

    auto& pending = m_pending.value();

    // è·å–æ´»åŠ¨æ›²çº¿
    ThermalCurve* curve = m_curveManager->getActiveCurve();
    if (!curve) {
        emit algorithmFailed(pending.algorithmName, "æ²¡æœ‰æ´»åŠ¨æ›²çº¿");
        return;
    }

    // æ³¨å…¥æ•°æ®åˆ°ä¸Šä¸‹æ–‡
    m_context->setValue("activeCurve", QVariant::fromValue(curve));
    m_context->setValue("parameters", pending.parameters);
    m_context->setValue("selectedPoints", QVariant::fromValue(pending.points));

    // æäº¤åˆ°çº¿ç¨‹æ± æ‰§è¡Œ
    QString taskId = m_algorithmManager->executeAsync(
        pending.algorithmName, m_context);

    m_currentTaskId = taskId;
}
```

---

## äº”ã€åˆ é™¤å’Œç®€åŒ–æ¸…å•

### 5.1 å®Œå…¨åˆ é™¤çš„æ–‡ä»¶ï¼ˆ7ä¸ªï¼Œ~460è¡Œï¼‰

| æ–‡ä»¶ | è¡Œæ•° | åˆ é™¤åŸå›  |
|------|------|---------|
| `metadata_descriptor.h` | ~150 | ä¸ domain å±‚ AlgorithmDescriptor é‡å¤ |
| `metadata_descriptor_registry.h` | ~60 | å†—ä½™æ³¨å†Œè¡¨ï¼Œç®—æ³•è‡ªæè¿°å³å¯ |
| `metadata_descriptor_registry.cpp` | ~80 | å†—ä½™æ³¨å†Œè¡¨å®ç° |
| `register_metadata_descriptors.cpp` | ~120 | å†—ä½™æ³¨å†Œé€»è¾‘ |
| `algorithm_descriptor.h`ï¼ˆåº”ç”¨å±‚ï¼‰ | ~50 | å¦‚æœå­˜åœ¨ï¼Œåˆ é™¤ï¼ˆä¿ç•™é¢†åŸŸå±‚ç‰ˆæœ¬ï¼‰ |

**åˆ é™¤å‘½ä»¤**ï¼š
```bash
cd Analysis/src/application/algorithm
rm metadata_descriptor.h
rm metadata_descriptor_registry.h
rm metadata_descriptor_registry.cpp
rm register_metadata_descriptors.cpp
```

---

### 5.2 å¤§å¹…ç®€åŒ–çš„æ–‡ä»¶ï¼ˆ2ä¸ªï¼Œå‡å°‘423è¡Œï¼‰

| æ–‡ä»¶ | å½“å‰è¡Œæ•° | é‡æ„åè¡Œæ•° | å‡å°‘ |
|------|---------|-----------|------|
| `algorithm_coordinator.h` | 278 | ~120 | 158 |
| `algorithm_coordinator.cpp` | 445 | ~180 | 265 |
| **æ€»è®¡** | **723** | **~300** | **423** |

**åˆ é™¤çš„ä»£ç **ï¼š
- âŒ `enum class PendingPhase`
- âŒ `MetadataPendingRequest` ç»“æ„
- âŒ `handleGenericParameterSubmission()`
- âŒ `runByName()` çš„å¤æ‚åˆ¤æ–­é€»è¾‘
- âŒ æ‰€æœ‰å…ƒæ•°æ®æ³¨å†Œè¡¨ç›¸å…³ä»£ç 

---

### 5.3 ä¿ç•™çš„æ ¸å¿ƒæ–‡ä»¶ï¼ˆ6ä¸ªï¼Œ~1100è¡Œï¼‰

| æ–‡ä»¶ | èŒè´£ | è¡Œæ•° | å¤‡æ³¨ |
|------|------|------|------|
| `algorithm_context.h/cpp` | ä¸Šä¸‹æ–‡å®¹å™¨ | ~200 | ä¿æŒä¸å˜ |
| `algorithm_manager.h/cpp` | ç®—æ³•ç®¡ç†å™¨ | ~300 | è½»å¾®ç®€åŒ– |
| `algorithm_coordinator.h/cpp` | æµç¨‹åè°ƒå™¨ | ~300 | **å¤§å¹…ç®€åŒ–** |
| `algorithm_thread_manager.h/cpp` | çº¿ç¨‹ç®¡ç† | ~150 | ä¿æŒä¸å˜ |
| `algorithm_worker.h/cpp` | å·¥ä½œçº¿ç¨‹ | ~100 | ä¿æŒä¸å˜ |
| `algorithm_task.h/cpp` | ä»»åŠ¡å°è£… | ~50 | ä¿æŒä¸å˜ |

---

### 5.4 å¼•ç”¨æ›´æ–°

**æ›¿æ¢è§„åˆ™**ï¼š
```cpp
// âŒ æ—§æ–¹å¼ï¼ˆåº”ç”¨å±‚æè¿°ç¬¦ï¼‰
#include "application/algorithm/metadata_descriptor.h"
using App::AlgorithmDescriptor;
using App::ParameterDescriptor;

// âœ… æ–°æ–¹å¼ï¼ˆé¢†åŸŸå±‚æè¿°ç¬¦ï¼‰
#include "domain/algorithm/algorithm_descriptor.h"
using AlgorithmDescriptor;
using AlgorithmParameterDefinition;
```

**å½±å“æ–‡ä»¶**ï¼š
- `algorithm_coordinator.h/cpp`
- `algorithm_manager.h/cpp`
- `main_controller.h/cpp`
- æ‰€æœ‰ç®—æ³•å®ç°æ–‡ä»¶

---

## å…­ã€å®Œæ•´å®æ–½è®¡åˆ’

### Phase 1: æ¸…ç†å†—ä½™ç±»ï¼ˆ1 å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] åˆ é™¤ `metadata_descriptor.h`
- [ ] åˆ é™¤ `metadata_descriptor_registry.h/cpp`
- [ ] åˆ é™¤ `register_metadata_descriptors.cpp`
- [ ] åˆ é™¤åº”ç”¨å±‚çš„ `algorithm_descriptor.h`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- [ ] æ›´æ–°æ‰€æœ‰ `#include` å¼•ç”¨

**åˆ é™¤å‘½ä»¤**ï¼š
```bash
cd Analysis/src/application/algorithm
rm metadata_descriptor.h
rm metadata_descriptor_registry.h
rm metadata_descriptor_registry.cpp
rm register_metadata_descriptors.cpp
```

**å½±å“æ–‡ä»¶**ï¼š
- `algorithm_coordinator.h/cpp`
- `algorithm_manager.h/cpp`
- `main_controller.h/cpp`

---

### Phase 2: å¢å¼ºé¢†åŸŸå±‚ AlgorithmDescriptorï¼ˆ2 å°æ—¶ï¼‰

**æ–‡ä»¶**: `domain/algorithm/algorithm_descriptor.h`

**æ·»åŠ å­—æ®µ**ï¼š
```cpp
struct AlgorithmDescriptor {
    // ==================== åŸºæœ¬ä¿¡æ¯ ====================
    QString name;
    QString displayName;
    QString category;

    // ==================== äº¤äº’éœ€æ±‚ï¼ˆç®—æ³•è‡ªæè¿°ï¼‰====================
    bool needsParameters = false;
    QVector<AlgorithmParameterDefinition> parameters;

    bool needsPointSelection = false;
    int requiredPointCount = 0;
    QString pointSelectionHint;

    bool needsCurveSelection = false;  // æœªæ¥æ‰©å±•

    QStringList interactionOrder;  // äº¤äº’é¡ºåº
};
```

---

### Phase 3: é‡æ„ AlgorithmCoordinatorï¼ˆ4 å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] åˆ é™¤ `PendingPhase` æšä¸¾
- [ ] ç®€åŒ– `PendingRequest` ç»“æ„ï¼ˆ6 ä¸ªå­—æ®µï¼‰
- [ ] å®ç° `run()` å”¯ä¸€å…¥å£æ–¹æ³•
- [ ] å®ç° `processNextStep()` æ ¸å¿ƒé€»è¾‘
- [ ] å®ç° `submitParameters()` å’Œ `submitPoints()`
- [ ] åˆ é™¤æ‰€æœ‰åˆ¤æ–­é€»è¾‘å’Œä¸­é—´æ§½å‡½æ•°

**å½±å“èŒƒå›´**ï¼š
- `application/algorithm/algorithm_coordinator.h`ï¼ˆå‡å°‘çº¦ 150 è¡Œï¼‰
- `application/algorithm/algorithm_coordinator.cpp`ï¼ˆå‡å°‘çº¦ 270 è¡Œï¼‰

**é¢„è®¡å‡å°‘**ï¼šçº¦ 420 è¡Œä»£ç 

---

### Phase 4: å®ç°åŠ¨æ€å‚æ•°å¯¹è¯æ¡†ï¼ˆ3 å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] åœ¨ `main_controller.h` ä¸­å£°æ˜æ–¹æ³•
  - `onRequestParameterDialog()`
  - `createParameterWidget()`
  - `extractParameters()`
- [ ] åœ¨ `main_controller.cpp` ä¸­å®ç°æ–¹æ³•
- [ ] è¿æ¥ `requestParameterDialog` ä¿¡å·

**å½±å“èŒƒå›´**ï¼š
- `ui/controller/main_controller.h`ï¼ˆæ–°å¢çº¦ 20 è¡Œï¼‰
- `ui/controller/main_controller.cpp`ï¼ˆæ–°å¢çº¦ 150 è¡Œï¼‰

**åˆ é™¤çš„ä»£ç **ï¼š
- æ‰€æœ‰å¯¹è¯æ¡†ç±»æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼šçº¦ 400 è¡Œ

**å‡€æ”¶ç›Š**ï¼šå‡å°‘çº¦ 230 è¡Œä»£ç 

---

### Phase 5: æ›´æ–°æ‰€æœ‰ç®—æ³•çš„è‡ªæè¿°ï¼ˆ2 å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] DifferentiationAlgorithm: è®¾ç½® `needsParameters = false`
- [ ] IntegrationAlgorithm: è®¾ç½® `needsParameters = false`
- [ ] MovingAverageFilterAlgorithm: è®¾ç½® `needsParameters = true`ï¼Œå®šä¹‰å‚æ•°
- [ ] BaselineCorrectionAlgorithm: è®¾ç½® `needsPointSelection = true`
- [ ] PeakAreaAlgorithm: è®¾ç½® `needsParameters = true, needsPointSelection = true`

**å½±å“èŒƒå›´**ï¼š
- `infrastructure/algorithm/*.cpp`ï¼ˆæ¯ä¸ªç®—æ³•ä¿®æ”¹çº¦ 10 è¡Œï¼‰

---

### Phase 6: æ›´æ–° UI å±‚è¿æ¥ï¼ˆ1 å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] æ›´æ–° MainController ä¸­çš„ä¿¡å·è¿æ¥
- [ ] ç§»é™¤æ—§çš„ä¿¡å·å¤„ç†æ§½å‡½æ•°
- [ ] æµ‹è¯•ä¿¡å·æµå‘

**å½±å“èŒƒå›´**ï¼š
- `ui/controller/main_controller.cpp`ï¼ˆä¿®æ”¹çº¦ 30 è¡Œï¼‰

---

### Phase 7: æµ‹è¯•éªŒè¯ï¼ˆ2 å°æ—¶ï¼‰

**æµ‹è¯•æ¸…å•**ï¼š
- [ ] æ— äº¤äº’ç®—æ³•ï¼ˆå¾®åˆ†ã€ç§¯åˆ†ï¼‰
- [ ] å‚æ•°å¯¹è¯æ¡†ç®—æ³•ï¼ˆç§»åŠ¨å¹³å‡ï¼‰
  - [ ] éªŒè¯å¯¹è¯æ¡†æ­£ç¡®ç”Ÿæˆ
  - [ ] éªŒè¯å‚æ•°æ­£ç¡®æå–
- [ ] ç‚¹é€‰äº¤äº’ç®—æ³•ï¼ˆåŸºçº¿æ ¡æ­£ï¼‰
  - [ ] éªŒè¯ç‚¹é€‰æç¤ºæ­£ç¡®æ˜¾ç¤º
  - [ ] éªŒè¯ç‚¹é€‰æ•°é‡éªŒè¯
- [ ] å¤åˆäº¤äº’ç®—æ³•ï¼ˆå³°é¢ç§¯ï¼šå‚æ•° + ç‚¹é€‰ï¼‰
  - [ ] éªŒè¯äº¤äº’é¡ºåºæ­£ç¡®
  - [ ] éªŒè¯å…ˆå‚æ•°åç‚¹é€‰
- [ ] å–æ¶ˆæ“ä½œæµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

**æ€»è®¡æ—¶é—´**ï¼šçº¦ 15 å°æ—¶

---

## ä¸ƒã€ä»£ç ç¤ºä¾‹

### 7.1 å®Œæ•´çš„æ‰§è¡Œæµç¨‹

#### ç¤ºä¾‹ 1: æ— éœ€äº¤äº’çš„ç®—æ³•ï¼ˆå¾®åˆ†ï¼‰

```cpp
// 1. ç”¨æˆ·ç‚¹å‡»"å¾®åˆ†"æŒ‰é’®
coordinator->run("differentiation");

// 2. è¯»å–ç®—æ³•æè¿°
AlgorithmDescriptor desc = algorithm->descriptor();
// desc.needsParameters = false
// desc.needsPointSelection = false

// 3. interactionOrder ä¸ºç©ºï¼Œç›´æ¥æ‰§è¡Œ
processNextStep();  // â†’ execute()
```

#### ç¤ºä¾‹ 2: éœ€è¦å‚æ•°çš„ç®—æ³•ï¼ˆç§»åŠ¨å¹³å‡ï¼‰

```cpp
// 1. ç”¨æˆ·ç‚¹å‡»"ç§»åŠ¨å¹³å‡"æŒ‰é’®
coordinator->run("moving_average");

// 2. è¯»å–ç®—æ³•æè¿°
// desc.needsParameters = true
// desc.interactionOrder = ["parameters"]

// 3. å‘å‡ºä¿¡å·ï¼Œè¯·æ±‚å‚æ•°å¯¹è¯æ¡†
emit requestParameterDialog("moving_average", desc);

// 4. MainController åŠ¨æ€åˆ›å»ºå¯¹è¯æ¡†
QDialog* dlg = new QDialog(parent);
QFormLayout* form = new QFormLayout(dlg);

// æ ¹æ® desc.parameters åˆ›å»ºæ§ä»¶
QSpinBox* spinBox = new QSpinBox(dlg);
form->addRow("çª—å£å¤§å°:", spinBox);

// 5. ç”¨æˆ·è¾“å…¥å¹¶ç‚¹å‡»ç¡®å®š
if (dlg->exec() == QDialog::Accepted) {
    QVariantMap params;
    params["windowSize"] = spinBox->value();

    // 6. æäº¤å‚æ•°
    coordinator->submitParameters(params);

    // 7. ç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥ï¼ˆæ— æ›´å¤šäº¤äº’ï¼Œæ‰§è¡Œç®—æ³•ï¼‰
    processNextStep();  // â†’ execute()
}
```

#### ç¤ºä¾‹ 3: éœ€è¦ç‚¹é€‰çš„ç®—æ³•ï¼ˆåŸºçº¿æ ¡æ­£ï¼‰

```cpp
// 1. ç”¨æˆ·ç‚¹å‡»"åŸºçº¿æ ¡æ­£"æŒ‰é’®
coordinator->run("baseline_correction");

// 2. è¯»å–ç®—æ³•æè¿°
// desc.needsPointSelection = true
// desc.requiredPointCount = 2
// desc.interactionOrder = ["points"]

// 3. å‘å‡ºä¿¡å·ï¼Œè¯·æ±‚ç‚¹é€‰
emit requestPointSelection("baseline_correction", 2, "è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹");

// 4. ChartView è¿›å…¥ç‚¹é€‰æ¨¡å¼ï¼Œç”¨æˆ·é€‰æ‹©2ä¸ªç‚¹

// 5. ç”¨æˆ·å®Œæˆç‚¹é€‰
coordinator->submitPoints(points);

// 6. éªŒè¯ç‚¹æ•°
if (points.size() < 2) {
    emit algorithmFailed(...);
    return;
}

// 7. ç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥ï¼ˆæ— æ›´å¤šäº¤äº’ï¼Œæ‰§è¡Œç®—æ³•ï¼‰
processNextStep();  // â†’ execute()
```

#### ç¤ºä¾‹ 4: å¤åˆäº¤äº’ç®—æ³•ï¼ˆå³°é¢ç§¯ï¼‰

```cpp
// 1. ç”¨æˆ·ç‚¹å‡»"å³°é¢ç§¯"æŒ‰é’®
coordinator->run("peak_area");

// 2. è¯»å–ç®—æ³•æè¿°
// desc.needsParameters = true
// desc.needsPointSelection = true
// desc.interactionOrder = ["parameters", "points"]

// 3. ç¬¬ä¸€æ­¥ï¼šå‚æ•°å¯¹è¯æ¡†
emit requestParameterDialog("peak_area", desc);

// 4. ç”¨æˆ·è¾“å…¥å‚æ•°å¹¶æäº¤
coordinator->submitParameters(params);

// 5. ç¬¬äºŒæ­¥ï¼šç‚¹é€‰
processNextStep();
emit requestPointSelection("peak_area", 2, "è¯·é€‰æ‹©å³°çš„èµ·ç‚¹å’Œç»ˆç‚¹");

// 6. ç”¨æˆ·å®Œæˆç‚¹é€‰
coordinator->submitPoints(points);

// 7. æ‰§è¡Œç®—æ³•
processNextStep();  // â†’ execute()
```

---

### 7.2 æ·»åŠ æ–°ç®—æ³•ç¤ºä¾‹

**åœºæ™¯**ï¼šæ·»åŠ ä¸€ä¸ªéœ€è¦å‚æ•°å’Œæ›²çº¿é€‰æ‹©çš„æ–°ç®—æ³•

```cpp
// 1. å®ç°ç®—æ³•ç±»
class CurveDifferenceAlgorithm : public IThermalAlgorithm {
public:
    AlgorithmDescriptor descriptor() const override {
        AlgorithmDescriptor desc;
        desc.name = "curve_difference";
        desc.displayName = "æ›²çº¿å·®å€¼";
        desc.category = "Analysis";

        // âœ… å£°æ˜éœ€è¦å‚æ•°
        desc.needsParameters = true;
        desc.parameters = {
            {"mode", "è®¡ç®—æ¨¡å¼", ParameterType::Enum,
             0, {"ç»å¯¹å·®", "ç›¸å¯¹å·®"}}
        };

        // âœ… å£°æ˜éœ€è¦æ›²çº¿é€‰æ‹©
        desc.needsCurveSelection = true;

        // âœ… å®šä¹‰äº¤äº’é¡ºåº
        desc.interactionOrder = {"curve", "parameters"};

        return desc;
    }

    AlgorithmResult executeWithContext(AlgorithmContext* context) override {
        // å®ç°ç®—æ³•é€»è¾‘
    }
};

// 2. æ³¨å†Œç®—æ³•
algorithmManager->registerAlgorithm(new CurveDifferenceAlgorithm());

// 3. å®Œæˆï¼æ— éœ€ä¿®æ”¹ Coordinator æˆ–æ·»åŠ å¯¹è¯æ¡†ç±»
```

---

## å…«ã€é¢„æœŸæ”¶ç›Š

### 8.1 ä»£ç é‡å‡å°‘

| ç»„ä»¶ | å½“å‰è¡Œæ•° | é‡æ„åè¡Œæ•° | å‡å°‘é‡ | å‡å°‘æ¯”ä¾‹ |
|------|---------|-----------|--------|---------|
| **AlgorithmCoordinator.h** | 278 | ~120 | 158 | 57% |
| **AlgorithmCoordinator.cpp** | 445 | ~180 | 265 | 60% |
| **å…ƒæ•°æ®ç›¸å…³æ–‡ä»¶** | ~460 | 0 | 460 | 100% |
| **å¯¹è¯æ¡†ç±»** | ~400 | 0 | 400 | 100% |
| **MainControllerï¼ˆå‚æ•°å¤„ç†ï¼‰** | ~100 | ~150 | -50 | -50% |
| **ç®—æ³•è‡ªæè¿°** | 0 | ~50 | -50 | -100% |
| **åº”ç”¨å±‚æ€»è®¡** | **~1700** | **~1100** | **~600** | **35%** |

**å‡€å‡å°‘**ï¼šçº¦ 600 è¡Œä»£ç ï¼ˆ35%ï¼‰

---

### 8.2 æ–‡ä»¶æ•°é‡å‡å°‘

| æ–‡ä»¶ç±»åˆ« | æ—§æ¶æ„ | æ–°æ¶æ„ | å˜åŒ– |
|---------|--------|--------|------|
| **æ ¸å¿ƒæ–‡ä»¶** | 6 ä¸ª | 6 ä¸ª | 0 |
| **å…ƒæ•°æ®ç›¸å…³** | 4 ä¸ª | 0 ä¸ª | **-4** âœ… |
| **å…¼å®¹é€‚é…** | è‹¥å¹² | 0 ä¸ª | **å…¨éƒ¨åˆ é™¤** âœ… |
| **å¯¹è¯æ¡†ç±»** | è‹¥å¹² | 0 ä¸ª | **å…¨éƒ¨åˆ é™¤** âœ… |
| **æ€»è®¡** | **15+ ä¸ª** | **6 ä¸ª** | **-9+ ä¸ª** |

---

### 8.3 æ¶æ„ä¼˜åŠ¿

| ç‰¹æ€§ | å½“å‰æ¶æ„ | æ–°æ¶æ„ |
|------|---------|--------|
| **æ‰§è¡Œå…¥å£** | 3 ä¸ª | 1 ä¸ª âœ… |
| **çŠ¶æ€ç®¡ç†** | å¤æ‚çŠ¶æ€æœº | ç®€å•ç´¢å¼• âœ… |
| **åˆ¤æ–­é€»è¾‘** | Coordinator åˆ¤æ–­ | ç®—æ³•è‡ªæè¿° âœ… |
| **å¯¹è¯æ¡†ç±»** | æ¯ç®—æ³• 1 ä¸ª | 0 ä¸ªï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰âœ… |
| **æè¿°ç¬¦å®šä¹‰** | 2 å¥—ï¼ˆé‡å¤ï¼‰ | 1 å¥—ï¼ˆé¢†åŸŸå±‚ï¼‰âœ… |
| **æ‰©å±•æ€§** | éœ€è¦ä¿®æ”¹å¤šå¤„ | åªä¿®æ”¹ç®—æ³• âœ… |
| **SOLID åŸåˆ™** | éƒ¨åˆ†ç¬¦åˆ | å®Œå…¨ç¬¦åˆ âœ… |

---

### 8.4 ç»´æŠ¤æ€§æå‡

**æ·»åŠ æ–°ç®—æ³•**ï¼š
```cpp
// âŒ æ—§æ–¹å¼
1. å®ç°ç®—æ³•ç±»ï¼ˆ50 è¡Œï¼‰
2. åˆ›å»ºå¯¹è¯æ¡†ç±»ï¼ˆ80 è¡Œï¼‰
3. ä¿®æ”¹ Coordinatorï¼ˆ20 è¡Œï¼‰
4. ä¿®æ”¹ MainControllerï¼ˆ30 è¡Œï¼‰
5. æ³¨å†Œå…ƒæ•°æ®ï¼ˆ20 è¡Œï¼‰
æ€»è®¡ï¼š200 è¡Œ

// âœ… æ–°æ–¹å¼
1. å®ç°ç®—æ³•ç±»ï¼ˆ50 è¡Œï¼‰
2. å®ç° descriptor()ï¼ˆ15 è¡Œï¼‰
æ€»è®¡ï¼š65 è¡Œ

å‡å°‘ï¼š135 è¡Œï¼ˆ68%ï¼‰
```

**æ·»åŠ æ–°äº¤äº’ç±»å‹**ï¼š
```cpp
// âŒ æ—§æ–¹å¼
1. ä¿®æ”¹ PendingPhase æšä¸¾
2. ä¿®æ”¹ MetadataPendingRequest ç»“æ„
3. ä¿®æ”¹ Coordinator çš„å¤šä¸ªæ–¹æ³•
4. ä¿®æ”¹ä¿¡å·å®šä¹‰

// âœ… æ–°æ–¹å¼
1. åœ¨ AlgorithmDescriptor ä¸­æ·»åŠ å­—æ®µ
2. åœ¨ processNextStep() ä¸­æ·»åŠ  1 ä¸ª if åˆ†æ”¯
```

---

### 8.5 ä¾èµ–å…³ç³»ç®€åŒ–

**æ—§æ¶æ„ï¼ˆå¤æ‚ï¼‰**ï¼š
```
åº”ç”¨å±‚ â”€â”€â”¬â”€â†’ App::AlgorithmDescriptor ï¼ˆé‡å¤å®šä¹‰ï¼‰
         â”œâ”€â†’ MetadataDescriptorRegistry ï¼ˆå†—ä½™æ³¨å†Œè¡¨ï¼‰
         â”œâ”€â†’ domain::AlgorithmDescriptor
         â””â”€â†’ å¤šå¥—ç³»ç»Ÿå¹¶å­˜
```

**æ–°æ¶æ„ï¼ˆç®€æ´ï¼‰**ï¼š
```
åº”ç”¨å±‚ â”€â”€â†’ domain::AlgorithmDescriptor
         ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
```

---

### 8.6 æ€§èƒ½å½±å“

**æ— è´Ÿé¢å½±å“**ï¼š
- åŠ¨æ€åˆ›å»ºå¯¹è¯æ¡†çš„å¼€é”€å¯å¿½ç•¥ï¼ˆç”¨æˆ·ç‚¹å‡»é¢‘ç‡ä½ï¼‰
- ç®—æ³•è‡ªæè¿°ä¿¡æ¯ç¼“å­˜åœ¨ descriptor ä¸­
- `processNextStep()` é€»è¾‘ç®€å•ï¼ŒO(1) å¤æ‚åº¦

---

### 8.7 é£é™©è¯„ä¼°

| é£é™© | ä¸¥é‡æ€§ | è§£å†³æ–¹æ¡ˆ |
|------|--------|---------|
| **ä¿¡å·è¿æ¥ä¿®æ”¹** | ä¸­ | å®Œæ•´çš„å›å½’æµ‹è¯• |
| **ç°æœ‰ç®—æ³•è¿ç§»** | ä½ | é€ä¸ªæ›´æ–° descriptor() |
| **UI å±‚é€‚é…** | ä½ | MainController ç»Ÿä¸€å¤„ç† |
| **å…¼å®¹æ€§ç ´å** | æ—  | ä¸åšå…¼å®¹ï¼Œç›´æ¥åˆ‡æ¢ |

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒæ”¹è¿›

âœ… **ç®—æ³•å®Œå…¨è‡ªæè¿°** - æ˜¯å¦éœ€è¦äº¤äº’ã€æ€ä¹ˆäº¤äº’ã€äº¤äº’é¡ºåºéƒ½ç”±ç®—æ³•å®šä¹‰
âœ… **åŠ¨æ€å‚æ•°å¯¹è¯æ¡†** - æ ¹æ®æè¿°è‡ªåŠ¨ç”Ÿæˆ UIï¼Œæ— éœ€å†™å¯¹è¯æ¡†ç±»
âœ… **ç®€åŒ– Coordinator** - å˜ä¸ºçº¯æ‰§è¡Œå™¨ï¼Œæ— åˆ¤æ–­é€»è¾‘ï¼Œå‡å°‘ 420 è¡Œä»£ç 
âœ… **å®Œå…¨ç¬¦åˆ SOLID** - å¼€é—­åŸåˆ™ã€å•ä¸€èŒè´£ã€ä¾èµ–å€’ç½®
âœ… **åˆ é™¤å†—ä½™ç±»** - 7 ä¸ªæ–‡ä»¶ï¼Œ~460 è¡Œä»£ç 
âœ… **å•ä¸€æ•°æ®æº** - åªä½¿ç”¨é¢†åŸŸå±‚ AlgorithmDescriptor

### 9.2 é¢„æœŸæ”¶ç›Š

ğŸ“‰ **ä»£ç é‡å‡å°‘ 35%**ï¼ˆ~1700 è¡Œ â†’ ~1100 è¡Œï¼‰
ğŸ“‰ **æ–‡ä»¶æ•°é‡å‡å°‘ 60%**ï¼ˆ15+ ä¸ª â†’ 6 ä¸ªï¼‰
ğŸš€ **æ·»åŠ æ–°ç®—æ³•å‡å°‘ 68% ä»£ç **ï¼ˆ200 è¡Œ â†’ 65 è¡Œï¼‰
ğŸ”§ **ç»´æŠ¤æˆæœ¬é™ä½ 90%**
âš¡ **æ— æ€§èƒ½æŸå¤±**

### 9.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**å»ºè®®ç«‹å³å®æ–½**ï¼ŒæŒ‰ç…§ Phase 1-7 é€æ­¥å®Œæˆï¼š

1. Phase 1: æ¸…ç†å†—ä½™ç±»ï¼ˆ1hï¼‰
2. Phase 2: å¢å¼º AlgorithmDescriptorï¼ˆ2hï¼‰
3. Phase 3: é‡æ„ AlgorithmCoordinatorï¼ˆ4hï¼‰
4. Phase 4: å®ç°åŠ¨æ€å‚æ•°å¯¹è¯æ¡†ï¼ˆ3hï¼‰
5. Phase 5: æ›´æ–°ç®—æ³•è‡ªæè¿°ï¼ˆ2hï¼‰
6. Phase 6: æ›´æ–° UI å±‚è¿æ¥ï¼ˆ1hï¼‰
7. Phase 7: æµ‹è¯•éªŒè¯ï¼ˆ2hï¼‰

**æ€»è®¡**ï¼š15 å°æ—¶ï¼ˆçº¦ 2 ä¸ªå·¥ä½œæ—¥ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0ï¼ˆå…¨æ–°æ¶æ„ï¼Œæ— å…¼å®¹å±‚ï¼‰
**åˆ›å»ºæ—¥æœŸ**: 2025-11-18
**ä½œè€…**: Claude Code
**çŠ¶æ€**: å¾…å®¡æ‰¹å¹¶å®æ–½
**ä¼˜å…ˆçº§**: é«˜
**æ ¸å¿ƒåŸåˆ™**: å½»åº•é‡æ„ï¼Œä¸åšå…¼å®¹ï¼Œä¿æŒç®€æ´
