# 调试日志说明文档

## 概述

已为所有关键功能路径添加详细的调试日志，帮助追踪峰面积计算和基线绘制功能的执行流程。

## 添加调试日志的文件

### 1. PlotWidget.cpp
**功能**: 曲线显示和点拾取核心逻辑

**添加的日志位置**:
- `startPointPicking()` - 开始点拾取模式
  - 记录需要的点数
  - 记录光标变化

- `cancelPointPicking()` - 取消点拾取模式
  - 记录取消操作

- `mousePressEvent()` - 鼠标点击事件
  - 记录鼠标原始坐标和转换后的坐标
  - 记录找到的点的信息（曲线ID、数据坐标）
  - 记录点的添加过程
  - 记录是否完成拾取
  - 记录错误情况（未找到点、点击不同曲线）

- `findNearestPointOnCurves()` - 查找最近点
  - 记录搜索的屏幕坐标
  - 记录检查的曲线数量和每条曲线的点数
  - 记录最小距离和距离阈值
  - 记录是否超过阈值
  - 记录最终找到的点

- `eventFilter()` - 绘制覆盖层
  - 记录每次Paint事件
  - 记录当前拾取点数和注释线数
  - 记录绘制过程

- `drawPointMarkers()` - 绘制点标记
  - 记录绘制的点数
  - 记录目标曲线ID
  - 记录每个点的坐标转换过程（数据坐标→场景坐标→视口坐标）
  - 记录错误情况（系列对象不存在）

- `drawAnnotationLines()` - 绘制注释线
  - 记录注释线数量
  - 记录每条线的详细信息（ID、曲线ID、起点、终点）
  - 记录坐标转换过程
  - 记录错误情况（曲线系列不存在）

- `addAnnotationLine()` - 添加注释线
  - 记录添加的注释线ID、曲线ID和数据点

- `removeAnnotation()` - 移除注释线
  - 记录移除的注释线ID

- `clearAllAnnotations()` - 清除所有注释线
  - 记录清除操作

### 2. PeakAreaDialog.cpp
**功能**: 峰面积计算对话框

**添加的日志位置**:
- `showPickingPrompt()` - 显示点拾取提示
  - 记录显示操作

- `updateProgress()` - 更新进度
  - 记录当前进度（已选/总数）

- `showResult()` - 显示结果
  - 记录面积值和单位
  - 记录UI更新状态（结果标签可见、确定按钮启用）

### 3. MainController.cpp
**功能**: 业务逻辑控制器

**添加的日志位置**:
- `onPeakAreaRequested()` - 开始峰面积计算
  - 记录流程开始
  - 记录活动曲线信息（名称、ID）
  - 记录对话框创建
  - 记录信号发送
  - 记录错误情况（无活动曲线）

- `onPointsPickedForPeakArea()` - 峰面积点拾取完成
  - 记录收到的信号
  - 记录当前拾取目的（用于判断是否处理）
  - 记录曲线信息和所有点的坐标
  - 记录曲线数据点数
  - 记录积分范围（X1、X2）
  - 记录积分过程（梯形段数量）
  - 记录计算结果（面积、单位）
  - 记录结果显示调用
  - 记录错误情况（曲线不存在、对话框为空）

- `onBaselineRequested()` - 开始基线绘制
  - 记录流程开始
  - 记录活动曲线信息
  - 记录信号发送
  - 记录错误情况（无活动曲线）

- `onPointsPickedForBaseline()` - 基线点拾取完成
  - 记录收到的信号
  - 记录当前拾取目的
  - 记录曲线信息和所有点的坐标
  - 记录命令创建和执行
  - 记录错误情况（PlotWidget为空、点数不足、命令执行失败）

### 4. mainwindow.cpp
**功能**: 主窗口和信号连接

**添加的日志位置**:
- `initComponents()` - 信号连接
  - 记录峰面积按钮点击
  - 记录基线按钮点击
  - 记录点拾取进度更新
  - 记录信号连接完成

## 日志级别说明

- **qDebug()**: 正常流程信息，追踪执行路径
- **qInfo()**: 重要的业务操作完成信息
- **qWarning()**: 警告，表示可恢复的错误或异常情况
- **qCritical()**: 严重错误（代码中未使用）

## 如何查看日志

### 方法1：在 Qt Creator 中运行
1. 打开 Qt Creator
2. 加载项目 Analysis.pro
3. 点击运行（绿色三角）
4. 在底部的"应用程序输出"窗口查看日志

### 方法2：命令行运行
```bash
cd Analysis/release
./Analysis.exe
```
日志会输出到控制台

### 方法3：重定向到文件
```bash
cd Analysis/release
./Analysis.exe > debug.log 2>&1
```
日志会保存到 debug.log 文件

## 典型调试场景

### 场景1：峰面积计算没有结果

**应该看到的日志流程**:
1. `MainWindow: 峰面积按钮被点击`
2. `MainController::onPeakAreaRequested - 开始峰面积计算流程`
3. `活动曲线: XXX, ID: XXX`
4. `发送信号 requestStartPointPicking(2)`
5. `PlotWidget::startPointPicking() - 开始点拾取模式，需要点数: 2`
6. **（用户点击第一个点）**
7. `PlotWidget::mousePressEvent - 点拾取模式，鼠标位置: ...`
8. `PlotWidget::findNearestPointOnCurves - 查找最近点...`
9. `找到点: 曲线ID=XXX, 数据坐标=...`
10. `已添加点，当前已选 1/2 个点`
11. `PlotWidget::eventFilter - Paint 事件，开始绘制覆盖层`
12. `PlotWidget::drawPointMarkers - 绘制 1 个点标记`
13. **（用户点击第二个点）**
14. `点拾取完成，发射信号 pointsPickedOnCurve`
15. `MainController::onPointsPickedForPeakArea - 收到信号`
16. `开始梯形积分计算...`
17. `积分完成: 计算了 XXX 个梯形段，总面积 = XXX`
18. `调用 m_peakAreaDialog->showResult()`
19. `PeakAreaDialog::showResult - 显示结果: 面积=XXX`

**如果某个步骤缺失，说明问题出在该步骤**:
- 如果没有步骤1，检查按钮信号连接
- 如果没有步骤5，检查 `requestStartPointPicking` 信号连接
- 如果步骤8没有找到点，检查距离阈值和曲线可见性
- 如果没有步骤15，检查 `pointsPickedOnCurve` 信号连接
- 如果没有步骤19，检查对话框是否为空

### 场景2：基线绘制没有显示

**应该看到的日志流程**:
1. `MainWindow: 基线按钮被点击`
2. `MainController::onBaselineRequested - 开始基线绘制流程`
3. `发送信号 requestStartPointPicking(2)`
4. **（点拾取过程，同上）**
5. `MainController::onPointsPickedForBaseline - 收到信号`
6. `创建 BaselineCommand`
7. `执行 BaselineCommand`
8. `BaselineCommand: 执行成功，基线ID: ...`
9. `PlotWidget: 添加注释线 XXX 在曲线 XXX 数据点: ...`
10. `PlotWidget::eventFilter - Paint 事件，开始绘制覆盖层`
11. `PlotWidget::drawAnnotationLines - 绘制 1 条注释线`
12. `数据坐标 → 场景坐标 → 视口坐标 ...`

**如果基线不可见但命令执行成功**:
- 检查步骤10-12是否正常
- 检查坐标转换是否合理
- 检查视口坐标是否在屏幕可见范围内

### 场景3：点击曲线没有反应

**应该看到的日志**:
1. `PlotWidget::mousePressEvent - 点拾取模式，鼠标位置: ...`
2. `PlotWidget::findNearestPointOnCurves - 查找最近点...`
3. `检查曲线: XXX, 点数: XXX`
4. `最小距离: XXX 像素`
5. `距离阈值: XXX 像素`

**如果没有找到点**:
- 检查"最小距离"是否远大于"距离阈值"（默认20像素）
- 检查是否有可见的曲线被检查
- 尝试点击更靠近曲线的位置

## 调试技巧

1. **使用 grep 过滤日志**:
   ```bash
   ./Analysis.exe 2>&1 | grep "PlotWidget"
   ./Analysis.exe 2>&1 | grep "MainController"
   ```

2. **只看错误和警告**:
   ```bash
   ./Analysis.exe 2>&1 | grep -E "(错误|警告|warning|error)"
   ```

3. **追踪特定功能**:
   ```bash
   ./Analysis.exe 2>&1 | grep -E "(峰面积|基线)"
   ```

4. **查看坐标转换**:
   ```bash
   ./Analysis.exe 2>&1 | grep "坐标"
   ```

## 常见问题排查

### 问题1：点标记不显示
**检查点**:
- eventFilter 是否被调用？（看是否有 "Paint 事件" 日志）
- drawPointMarkers 是否被调用？（看是否有 "绘制点标记" 日志）
- 坐标转换是否正确？（检查视口坐标是否在合理范围内，如 0-800）
- m_targetCurveId 是否为空？

### 问题2：基线不显示
**检查点**:
- BaselineCommand 是否执行成功？
- addAnnotationLine 是否被调用？
- drawAnnotationLines 是否被调用？
- 坐标转换是否正确？

### 问题3：峰面积结果不正确
**检查点**:
- 积分范围（X1、X2）是否正确？
- 梯形段数量是否合理？（应该是X1到X2范围内的数据点数-1）
- 曲线数据点数是否足够？

## 注意事项

1. **Release 模式下某些日志可能被优化掉**，建议使用 Debug 模式测试
2. **日志会影响性能**，生产环境可以考虑移除或使用条件编译
3. **中文日志在某些终端可能显示为乱码**，可以使用支持UTF-8的终端或重定向到文件后用支持UTF-8的编辑器打开

## 下一步

如果日志显示某个步骤出现问题，可以：
1. 在该位置添加更详细的日志
2. 使用 Qt Creator 的调试器设置断点
3. 检查相关变量的值
4. 查看堆栈跟踪

祝调试顺利！🎯
