# 外推温度功能说明

## 功能概述

**外推温度算法**用于计算热分析曲线的 **Onset（起始温度）** 或 **Endset（结束温度）**，这是热分析中确定反应起始/结束点的标准方法。

## 使用方法

### 1. 启动外推温度工具

- 点击工具栏上的"**外推温度**"按钮
- 或通过菜单选择算法

### 2. 选择点

系统会提示：**"请选择3个点：前2个点定义切线区域，第3个点定义基线水平"**

- **第1-2个点**：在曲线的前沿或后沿选择，用于拟合切线
  - 建议选择斜率变化明显的区域
  - 两个点之间应有足够的数据点（至少 10 个以上）
- **第3个点**：在平稳的基线区域选择，定义基线水平
  - 对于 Onset 温度：选择反应前的平稳区域
  - 对于 Endset 温度：选择反应后的平稳区域

### 3. 查看结果

算法会自动计算并显示：

1. **外推点标注**（红色）：切线与基线的交点
2. **切线可视化**：拟合的切线（延伸显示）
3. **数值标签**：外推温度数值（浮动标签）
4. **辅助标注**：切线起点、终点、基线点

## 算法原理

### 核心步骤

1. **提取拟合区域**：
   - 根据用户选择的前2个点，提取该温度范围内的所有数据点

2. **最小二乘法拟合切线**：
   ```
   y = k * x + b
   ```
   - 计算斜率 k 和截距 b

3. **计算交点**：
   - 切线方程：`y = k * x + b`
   - 基线方程：`y = baselineY`（用户第3个点的 Y 值）
   - 外推温度：`x = (baselineY - b) / k`

### 适用场景

- **TGA（热重分析）**：
  - 计算分解起始温度
  - 计算分解结束温度

- **DSC（差示扫描量热）**：
  - 计算熔融起始温度
  - 计算结晶起始温度
  - 计算玻璃化转变温度

- **ARC（加速量热仪）**：
  - 计算反应起始温度

## 注意事项

### 1. 关于基线

当前版本使用**简化基线**（单个点定义的水平线）。

如果需要更精确的基线：
1. 先使用"**基线校正**"功能绘制基线曲线
2. 然后执行外推温度算法
3. 未来版本将支持直接引用基线曲线

### 2. 切线区域选择

- ✅ **推荐**：选择斜率稳定、变化显著的区域
- ❌ **避免**：选择噪声较大或曲率变化剧烈的区域

### 3. 点选顺序

必须严格按照顺序选择：
1. 第1个点：切线区域起点
2. 第2个点：切线区域终点
3. 第3个点：基线水平点

## 技术实现

### 文件位置

- **算法实现**：
  - `Analysis/src/infrastructure/algorithm/temperature_extrapolation_algorithm.h`
  - `Analysis/src/infrastructure/algorithm/temperature_extrapolation_algorithm.cpp`

- **算法注册**：
  - `Analysis/src/application/application_context.cpp`

- **UI 集成**：
  - `Analysis/src/ui/main_window.cpp`

### 算法特性

- **算法类型**：B 类算法（交互式，需要用户选点）
- **输入类型**：`InputType::PointSelection`（需要选择3个点）
- **输出类型**：`OutputType::Annotation`
- **结果类型**：`ResultType::Composite`（混合输出：标注点 + 切线 + 数值）

### 上下文驱动执行

算法采用**纯上下文驱动模式**：

```cpp
// 阶段1：验证数据完整性
bool prepareContext(AlgorithmContext* context) override;

// 阶段2：执行计算
AlgorithmResult executeWithContext(AlgorithmContext* context) override;
```

从上下文中拉取：
- `ContextKeys::ActiveCurve` - 活动曲线
- `ContextKeys::SelectedPoints` - 用户选择的3个点

## 示例结果

```
外推温度 = 350.25 °C

元数据：
- slope (斜率): -0.0123
- intercept (截距): 4.5678
- baselineY (基线高度): 0.5
- 切线方程: y = -0.0123x + 4.5678
```

## 未来改进

1. **支持基线曲线引用**：
   - 允许用户选择已有的基线曲线
   - 自动计算切线与基线曲线的交点

2. **切线拟合优化**：
   - 提供多种拟合方法（线性、多项式）
   - 显示拟合质量指标（R²）

3. **批量计算**：
   - 支持一次性计算多个外推点
   - 导出外推温度表格

4. **可视化增强**：
   - 切线可拖动调整
   - 实时显示拟合参数

## 参考文献

- ASTM E928: 热重分析中外推起始温度的标准测试方法
- ISO 11357-1: 差示扫描量热法中外推起始温度和结束温度的确定

---

**版本**: v1.0.0
**日期**: 2025-11-12
**作者**: Claude Code
