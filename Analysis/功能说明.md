# Analysis 热分析软件 - 功能说明文档

**版本**: v0.1.0-alpha
**最后更新**: 2025-11-01

## 版本更新记录

### v0.1.0-alpha (2025-11-01)
- ✅ **重大重构**: 将单一 `CurveType` 枚举拆分为 `InstrumentType` 和 `SignalType` 双枚举
  - 解决了语义混乱问题（仪器类型 vs 信号处理类型）
  - 支持 TGA/DSC/ARC 三种仪器类型
  - 支持 Raw/Derivative 两种信号类型
- ✅ **动态单位系统**: 实现 Y 轴标签根据曲线类型自动推断
- ✅ **算法通用化**: 微分/积分算法适用所有仪器类型，无需特殊逻辑
- ✅ 修复了 DTG 枚举缺失导致的编译错误
- ✅ 完善了文档和架构说明

---

## 目录

0. [版本更新记录](#版本更新记录)
1. [软件概述](#软件概述)
2. [核心功能](#核心功能)
3. [用户界面](#用户界面)
4. [数据导入](#数据导入)
5. [曲线管理](#曲线管理)
6. [算法功能](#算法功能)
7. [项目浏览器](#项目浏览器)
8. [技术架构](#技术架构)
9. [设计亮点](#设计亮点)

---

## 软件概述

Analysis 是一款用于热分析数据处理的桌面应用软件，支持导入、可视化和分析热重分析(TGA)、差示扫描量热(DSC)等热分析数据。

### 支持的仪器类型和信号类型

本软件采用**双枚举设计**，将仪器类型和信号处理类型分离：

#### 仪器类型 (InstrumentType)
- **TGA** (Thermogravimetric Analysis - 热重分析) - 测量质量 vs 温度
- **DSC** (Differential Scanning Calorimetry - 差示扫描量热) - 测量热流 vs 温度
- **ARC** (Accelerating Rate Calorimetry - 加速量热仪) - 测量压力 vs 温度

#### 信号类型 (SignalType)
- **Raw** (原始信号) - 直接从仪器获得的数据
- **Derivative** (微分信号) - 通过算法派生的微分数据

#### 组合示例
- **TGA + Raw** = 原始质量数据
- **TGA + Derivative** = 微分质量数据（传统的 DTG）
- **DSC + Raw** = 原始热流数据
- **DSC + Derivative** = 微分热流数据（dDSC）
- **ARC + Raw** = 原始压力数据
- **ARC + Derivative** = 微分压力数据（dARC）

---

## 核心功能

### 1. 数据导入
- 支持文本文件导入 (.txt, .csv)
- 智能列识别和映射
- 实时数据预览
- 自动跳过表头行
- 支持自定义列分隔符

### 2. 曲线可视化
- 基于 Qt Charts 的交互式图表
- 多曲线同时显示
- 曲线颜色自动分配
- 支持曲线选择和高亮
- 曲线可见性控制（通过 checkbox）

### 3. 数据处理算法
目前支持以下算法：

#### 3.1 微分算法 (Differentiation)
- **功能**: 计算曲线的导数，将原始信号转换为微分信号
- **方法**: 大窗口平滑中心差分法
- **参数**:
  - `halfWin`: 半窗口大小，默认 50 点
  - `dt`: 虚拟时间步长，默认 0.1
  - `enableDebug`: 调试输出开关
- **输出**: 微分曲线（Raw → Derivative）
  - TGA 原始数据 → dTG（质量变化率）
  - DSC 原始数据 → dDSC（热流变化率）
  - ARC 原始数据 → dARC（压力变化率）
- **适用范围**: 支持所有仪器类型

#### 3.2 移动平均滤波 (Moving Average Filter)
- **功能**: 平滑数据曲线，去除噪声
- **方法**: 移动平均窗口法
- **参数**:
  - `window`: 窗口大小（点数），默认 5，范围 1-999
- **输出**: 平滑后的曲线（信号类型保持不变）
- **适用范围**: 支持所有仪器类型和信号类型

#### 3.3 积分算法 (Integration)
- **功能**: 对曲线进行数值积分，将微分信号还原为原始信号
- **方法**: 梯形法则
- **参数**: 无
- **输出**: 积分曲线（Derivative → Raw）
  - dTG（质量变化率）→ TGA（质量）
  - dDSC（热流变化率）→ DSC（热流）
  - dARC（压力变化率）→ ARC（压力）
- **适用范围**: 支持所有仪器类型的微分信号

---

## 用户界面

### 主窗口布局

```
┌─────────────────────────────────────────────────────┐
│  [文件] [视图] [数学工具]  <-- 功能区 Ribbon        │
├──────────┬──────────────────────────┬───────────────┤
│          │                          │               │
│  项目    │                          │    属性       │
│  浏览器  │      图表显示区域        │    面板       │
│          │    (PlotWidget)          │               │
│  (树形)  │                          │               │
│          │                          │               │
├──────────┴──────────────────────────┴───────────────┤
│  状态栏: 准备就绪 | 缩放: 100% | v0.1.0-alpha      │
└─────────────────────────────────────────────────────┘
```

### 功能区选项卡

#### 文件选项卡
- 新建项目
- 打开
- 保存
- **导入数据...** （主要功能入口）
- 导出图表

#### 视图选项卡
- 放大
- 缩小
- 适应视图
- 平移工具
- 选择工具

#### 数学工具选项卡
- 基线校正（待实现）
- 归一化（待实现）
- **微分算法**
- **移动平均滤波...**
- **积分**
- 动力学计算...（待实现）

---

## 数据导入

### 导入流程

1. **打开导入对话框**
   - 点击功能区 → 文件 → 导入数据...
   - 或使用快捷方式

2. **选择文件**
   - 支持 .txt、.csv 等文本格式
   - 浏览并选择数据文件

3. **配置导入参数**
   - 设置跳过行数（默认 1）
   - 选择分隔符（Tab、逗号、空格等）
   - 映射数据列：
     - 温度列
     - 时间列
     - 数值列

4. **预览数据**
   - 查看前 10 行数据
   - 确认列映射正确

5. **导入**
   - 点击"导入"按钮
   - 数据自动加载到图表
   - 曲线显示在项目浏览器

### 支持的数据格式

```
# 示例：TGA 数据文件
Temperature(°C)    Time(min)    Weight(%)
25.0               0.0          100.0
30.5               0.5          99.8
...
```

---

## 曲线管理

### 曲线结构

每个曲线 (`ThermalCurve`) 包含：
- **唯一 ID**: 自动生成的 UUID
- **名称**: 可编辑的曲线名称
- **仪器类型** (InstrumentType): TGA、DSC、ARC
- **信号类型** (SignalType): Raw（原始）、Derivative（微分）
- **原始数据**: 导入的原始数据（只读）
- **处理数据**: 算法处理后的数据
- **元数据**: 设备信息、样品信息等
- **父曲线 ID**: 用于标识算法生成的子曲线

#### 动态单位推断
曲线根据**仪器类型**和**信号类型**自动推断 Y 轴标签和单位：
- TGA + Raw → "质量 (%)" 或 "质量 (mg)"
- TGA + Derivative → "质量变化率 (%/°C)"
- DSC + Raw → "热流 (W/g)"
- DSC + Derivative → "热流变化率 (W/g/°C)"
- ARC + Raw → "压力 (Pa)"
- ARC + Derivative → "压力变化率 (Pa/°C)"

### 曲线操作

- **查看**: 在图表中显示曲线
- **隐藏**: 通过 checkbox 取消勾选隐藏曲线
- **选择**: 点击曲线设为活动曲线
- **删除**: 右键菜单 → 删除

---

## 算法功能

### 算法执行流程

1. **选择活动曲线**
   - 在图表中点击曲线
   - 或在项目浏览器中选择

2. **选择算法**
   - 功能区 → 数学工具 → 选择算法
   - 对于有参数的算法（如移动平均），弹出参数对话框

3. **执行算法**
   - 算法在活动曲线上执行
   - 生成新的曲线

4. **查看结果**
   - 新曲线自动添加到项目浏览器
   - 显示为原始曲线的子节点
   - 命名格式：`原曲线名称 (算法名称)`
   - 自动在图表中显示

### 算法特性

- **父子关系**: 算法生成的曲线与原曲线建立父子关系
- **仪器类型继承**: 算法不改变仪器类型，子曲线继承父曲线的仪器类型
- **信号类型转换**: 算法根据处理类型转换信号类型
  - **微分算法**: Raw → Derivative（适用所有仪器类型）
  - **积分算法**: Derivative → Raw（适用所有仪器类型）
  - **滤波算法**: 信号类型保持不变
- **参数保存**: 算法参数可配置和调整
- **可扩展**: 支持添加新算法
- **通用化设计**: 所有算法适用于所有仪器类型，无需针对特定仪器编写特殊逻辑

---

## 项目浏览器

### 树形结构显示

项目浏览器以树形结构展示曲线及其衍生曲线：

```
□ Sample_TGA_001.txt
  ├─ □ Sample_TGA_001.txt (moving_average)
  ├─ □ Sample_TGA_001.txt (differentiation)
  │   └─ □ Sample_TGA_001.txt (differentiation) (integration)
  └─ □ Sample_TGA_001.txt (moving_average) (differentiation)
```

### 功能特性

1. **Checkbox 控制**
   - 勾选/取消勾选控制曲线显示
   - 支持父曲线和子曲线独立控制

2. **层级展示**
   - 原始曲线作为顶层节点
   - 算法生成的曲线作为子节点
   - 支持多层嵌套（对同一曲线应用多次算法）

3. **右键菜单**
   - 删除曲线
   - 删除时自动删除图表中的显示

4. **自动更新**
   - 新增曲线自动添加
   - 删除曲线自动移除
   - 树结构实时同步

---

## 技术架构

### 分层架构

项目采用清晰的分层架构：

```
┌─────────────────────────────────────┐
│         UI Layer (用户界面层)        │
│  - MainWindow                       │
│  - PlotWidget                       │
│  - ProjectExplorer                  │
│  - CurveTreeModel                   │
│  - DataImportWidget                 │
│  - MainController                   │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│    Application Layer (应用层)       │
│  - CurveManager                     │
│  - AlgorithmService                 │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│       Domain Layer (领域层)         │
│  - ThermalCurve                     │
│  - ThermalDataPoint                 │
│  - IThermalAlgorithm (接口)         │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Infrastructure Layer (基础设施层) │
│  - TextFileReader                   │
│  - DifferentiationAlgorithm         │
│  - MovingAverageFilterAlgorithm     │
│  - IntegrationAlgorithm             │
└─────────────────────────────────────┘
```

### 核心组件说明

#### UI Layer（用户界面层）
- **MainWindow**: 主窗口，管理整体布局
- **PlotWidget**: 图表显示组件，基于 Qt Charts
- **ProjectExplorer**: 项目浏览器，树形视图
- **CurveTreeModel**: 自定义树模型，支持父子关系和 checkbox
- **DataImportWidget**: 数据导入对话框
- **MainController**: 主控制器，协调 UI 和业务逻辑

#### Application Layer（应用层）
- **CurveManager**: 曲线管理服务
  - 管理所有曲线的生命周期
  - 提供曲线的增删改查
  - 管理活动曲线
  - 发射曲线变化信号

- **AlgorithmService**: 算法服务
  - 管理和注册所有算法
  - 执行算法并创建新曲线
  - 自动设置父子关系
  - 推导输出曲线类型

#### Domain Layer（领域层）
- **ThermalCurve**: 热分析曲线模型
  - 存储曲线数据（原始 + 处理后）
  - 管理曲线元数据
  - 支持父子关系
  - **双枚举设计**: InstrumentType + SignalType
  - **动态单位推断**: 根据类型自动生成 Y 轴标签
  ```cpp
  class ThermalCurve {
      InstrumentType m_instrumentType;  // 仪器类型
      SignalType m_signalType;          // 信号类型
      QString getYAxisLabel() const;    // 动态获取Y轴标签
  };
  ```

- **ThermalDataPoint**: 数据点结构
  ```cpp
  struct ThermalDataPoint {
      double temperature;  // 温度
      double time;         // 时间
      double value;        // 测量值（通用字段）
      QVariantMap metadata; // 扩展元数据
  };
  ```

- **IThermalAlgorithm**: 算法接口
  - 定义算法标准
  - 支持参数配置
  - 信号类型推导（Raw ↔ Derivative）
  ```cpp
  virtual SignalType getOutputSignalType(SignalType inputType) const = 0;
  ```

#### Infrastructure Layer（基础设施层）
- **TextFileReader**: 文本文件读取器
- **各种算法实现**: 具体算法的实现类

### 设计模式

1. **策略模式**: 算法可插拔设计
2. **观察者模式**: 信号槽机制
3. **单例模式**: AlgorithmService
4. **MVC 模式**: Model-View-Controller 分离
5. **工厂模式**: 曲线创建

---

## 数据流向

### 导入数据流

```
用户选择文件
    ↓
DataImportWidget (预览)
    ↓
TextFileReader (读取)
    ↓
ThermalCurve (创建)
    ↓
CurveManager (管理)
    ↓
信号: curveAdded
    ↓
├─→ CurveTreeModel (更新树)
└─→ PlotWidget (显示图表)
```

### 算法执行流

```
用户选择算法
    ↓
MainWindow (触发)
    ↓
MainController (协调)
    ↓
AlgorithmService (执行)
    ↓
├─ 获取活动曲线
├─ 执行算法处理
├─ 创建新曲线
├─ 设置 parentId
├─ 推导曲线类型
└─ 添加到 CurveManager
    ↓
信号: curveAdded
    ↓
├─→ CurveTreeModel (添加为子节点)
└─→ PlotWidget (显示新曲线)
```

---

## 编译和运行

### 环境要求
- Qt 5.14.2 或更高版本
- MinGW 7.3.0 或 MSVC 2019+
- C++17 标准

### 编译步骤

#### Windows (MinGW)
```batch
cd Analysis
build.bat
```

#### 手动编译
```batch
cd Analysis
mkdir build-debug
cd build-debug
qmake ../Analysis.pro
mingw32-make
```

### 运行
```batch
cd Analysis/build-debug/release
Analysis.exe
```

---

## 已知限制

1. 目前仅支持单项目模式（导入新数据会清空已有曲线）
2. 图表缩放和平移功能待完善
3. 基线校正、归一化等高级功能待实现
4. 动力学计算功能待实现
5. 项目保存/加载功能待实现
6. 曲线导出功能待实现

---

## 后续开发计划

### 短期计划
- [ ] 项目保存和加载
- [ ] 曲线导出（CSV、Excel）
- [ ] 图表导出（PNG、PDF）
- [ ] 更多数据文件格式支持
- [ ] 撤销/重做功能

### 中期计划
- [ ] 基线校正算法
- [ ] 归一化算法
- [ ] 峰值检测
- [ ] 面积计算
- [ ] 多项目支持

### 长期计划
- [ ] 动力学分析（Kissinger、Ozawa 等）
- [ ] 数据库支持
- [ ] 批处理功能
- [ ] 插件系统
- [ ] 报告生成

---

## 文件结构

```
Analysis/
├── src/
│   ├── ui/                          # UI 层
│   │   ├── MainWindow.h/cpp         # 主窗口
│   │   ├── PlotWidget.h/cpp         # 图表组件
│   │   ├── ProjectExplorer.h/cpp    # 项目浏览器
│   │   ├── CurveTreeModel.h/cpp     # 树形模型
│   │   ├── DataImportWidget.h/cpp   # 导入对话框
│   │   ├── main.cpp                 # 程序入口
│   │   └── controller/
│   │       └── MainController.h/cpp # 主控制器
│   │
│   ├── application/                 # 应用层
│   │   ├── curve/
│   │   │   └── CurveManager.h/cpp   # 曲线管理器
│   │   └── algorithm/
│   │       └── AlgorithmService.h/cpp # 算法服务
│   │
│   ├── domain/                      # 领域层
│   │   ├── model/
│   │   │   ├── ThermalCurve.h/cpp   # 曲线模型
│   │   │   └── ThermalDataPoint.h   # 数据点
│   │   └── algorithm/
│   │       └── IThermalAlgorithm.h  # 算法接口
│   │
│   └── infrastructure/              # 基础设施层
│       ├── io/
│       │   ├── IFileReader.h        # 读取器接口
│       │   └── TextFileReader.h/cpp # 文本读取器
│       └── algorithm/
│           ├── DifferentiationAlgorithm.h/cpp       # 微分算法
│           ├── MovingAverageFilterAlgorithm.h/cpp   # 滤波算法
│           └── IntegrationAlgorithm.h/cpp           # 积分算法
│
├── Analysis.pro                     # Qt 项目文件
├── build.bat                        # 编译脚本
├── rebuild.bat                      # 重新编译脚本
├── clean.bat                        # 清理脚本
└── 功能说明.md                      # 本文档
```

---

## 设计亮点

### 1. 双枚举分离设计

传统热分析软件通常使用单一枚举表示曲线类型（如 TGA、DSC、DTG），但这会导致语义混乱：
- **问题**: TGA/DSC 是仪器类型，而 DTG 是数据处理结果
- **问题**: 难以扩展新的仪器类型或处理方法

本软件采用**双枚举设计**，将概念清晰分离：

```cpp
enum class InstrumentType { TGA, DSC, ARC };  // 仪器类型
enum class SignalType { Raw, Derivative };     // 信号处理状态
```

**优势**:
- ✅ 语义清晰，概念不混淆
- ✅ 易于扩展新仪器类型（添加新的 InstrumentType）
- ✅ 易于扩展新处理方法（添加新的 SignalType，如 Integral、Normalized）
- ✅ 算法通用化，无需针对特定仪器编写特殊逻辑
- ✅ 类型安全，编译期检查

### 2. 动态单位推断系统

Y 轴标签和单位根据曲线类型自动生成：

```cpp
QString ThermalCurve::getYAxisLabel() const {
    // 根据 InstrumentType + SignalType 动态推断
    // TGA + Raw → "质量 (%)" 或 "质量 (mg)"
    // TGA + Derivative → "质量变化率 (%/°C)"
    // DSC + Raw → "热流 (W/g)"
    // ...
}
```

**优势**:
- ✅ 消除硬编码，代码简洁
- ✅ UI 层无需关心单位逻辑
- ✅ 单位始终正确，避免人为错误
- ✅ 易于维护和修改

### 3. 算法通用化设计

所有算法（微分、积分、滤波）适用于所有仪器类型：

```cpp
// 微分算法
SignalType getOutputSignalType(SignalType input) {
    return (input == Raw) ? Derivative : input;
}
// 对 TGA/DSC/ARC 均适用，无需特殊处理
```

**优势**:
- ✅ 代码复用性高
- ✅ 减少维护成本
- ✅ 新增仪器类型时无需修改算法代码
- ✅ 算法逻辑清晰，易于理解

### 4. 数据不可变性设计

曲线同时存储原始数据和处理数据：

```cpp
QVector<ThermalDataPoint> m_rawData;      // 只读，不可变
QVector<ThermalDataPoint> m_processedData; // 可修改
```

**优势**:
- ✅ 支持撤销/重做功能
- ✅ 数据安全，原始数据不会丢失
- ✅ 便于对比处理前后的差异

### 5. 父子关系追踪

算法生成的曲线自动关联到父曲线：

```cpp
newCurve.setParentId(parentCurve->id());
```

**优势**:
- ✅ 清晰的数据血缘关系
- ✅ 树形结构展示，易于理解
- ✅ 支持多层嵌套处理
- ✅ 便于追踪数据来源

### 6. 分层架构设计

UI → Application → Domain → Infrastructure

**优势**:
- ✅ 职责分离，模块独立
- ✅ 易于测试
- ✅ 易于扩展
- ✅ 代码可维护性高

---

## 联系和反馈

如有问题或建议，请通过以下方式联系：
- 项目仓库: [待添加]
- 问题跟踪: [待添加]

---

**文档结束**
