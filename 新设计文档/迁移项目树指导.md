# ProjectTreeManager ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

`ProjectTreeManager` æ˜¯åŸºäº `QStandardItemModel` çš„æ›²çº¿æ ‘ç®¡ç†å™¨,ç›¸æ¯”è‡ªå®šä¹‰çš„ `CurveTreeModel`:
- âœ… ä»£ç é‡å‡å°‘çº¦ 40%
- âœ… ä½¿ç”¨ Qt å®˜æ–¹æµ‹è¯•è¿‡çš„ç¨³å®šç»„ä»¶
- âœ… è‡ªåŠ¨å†…å­˜ç®¡ç†,æ— éœ€æ‰‹åŠ¨å¤„ç† TreeItem
- âœ… æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```cpp
#include "ProjectTreeManager.h"
#include <QTreeView>

// åˆ›å»ºç®¡ç†å™¨
ProjectTreeManager* treeManager = new ProjectTreeManager(curveManager, this);

// è®¾ç½®åˆ° QTreeView
QTreeView* treeView = new QTreeView(this);
treeView->setModel(treeManager->model());

// å±•å¼€æ‰€æœ‰é¡¹ç›®èŠ‚ç‚¹
treeView->expandAll();
```

### 2. ç›‘å¬æ›²çº¿å‹¾é€‰çŠ¶æ€å˜åŒ–

```cpp
// æ–¹å¼1: ä½¿ç”¨ ProjectTreeManager çš„ä¿¡å·(æ¨è)
connect(treeManager, &ProjectTreeManager::curveCheckStateChanged,
        this, [](const QString& curveId, bool checked) {
    qDebug() << "æ›²çº¿" << curveId << (checked ? "å·²å‹¾é€‰" : "å·²å–æ¶ˆå‹¾é€‰");
    // æ›´æ–°å›¾è¡¨æ˜¾ç¤ºç­‰...
});

// æ–¹å¼2: ç›´æ¥ç›‘å¬æ¨¡å‹çš„å˜åŒ–
connect(treeManager->model(), &QStandardItemModel::itemChanged,
        this, [=](QStandardItem* item) {
    if (item->isCheckable()) {
        QString curveId = item->data(Qt::UserRole).toString();
        bool checked = (item->checkState() == Qt::Checked);
        qDebug() << "æ›²çº¿" << curveId << "çŠ¶æ€:" << checked;
    }
});
```

### 3. è·å–å·²å‹¾é€‰çš„æ›²çº¿

```cpp
// è·å–æ‰€æœ‰å·²å‹¾é€‰æ›²çº¿çš„IDåˆ—è¡¨
QStringList checkedIds = treeManager->getCheckedCurveIds();

for (const QString& curveId : checkedIds) {
    qDebug() << "å·²å‹¾é€‰:" << curveId;
}
```

### 4. ç¨‹åºåŒ–è®¾ç½®æ›²çº¿å‹¾é€‰çŠ¶æ€

```cpp
// å‹¾é€‰æŸæ¡æ›²çº¿
treeManager->setCurveChecked("curve_001", true);

// å–æ¶ˆå‹¾é€‰
treeManager->setCurveChecked("curve_001", false);
```

### 5. å“åº”å³é”®èœå•ç­‰æ“ä½œ

```cpp
// åœ¨ QTreeView çš„ä¸Šä¸‹æ–‡èœå•ä¸­ä½¿ç”¨
void MyWidget::onTreeViewContextMenu(const QPoint& pos)
{
    QModelIndex index = treeView->indexAt(pos);
    if (!index.isValid()) {
        return;
    }

    // è·å–æ›²çº¿ID
    QString curveId = treeManager->getCurveId(index);
    if (curveId.isEmpty()) {
        // è¿™æ˜¯é¡¹ç›®èŠ‚ç‚¹,ä¸æ˜¯æ›²çº¿èŠ‚ç‚¹
        return;
    }

    // æ˜¾ç¤ºå³é”®èœå•
    QMenu menu;
    QAction* deleteAction = menu.addAction("åˆ é™¤æ›²çº¿");
    
    connect(deleteAction, &QAction::triggered, [=]() {
        curveManager->removeCurve(curveId);
    });
    
    menu.exec(treeView->viewport()->mapToGlobal(pos));
}
```

---

## ğŸ“ ä» CurveTreeModel è¿ç§»

### è¿ç§»æ­¥éª¤

#### Step 1: æ›¿æ¢å¤´æ–‡ä»¶å¼•ç”¨

```cpp
// æ—§ä»£ç 
#include "CurveTreeModel.h"

// æ–°ä»£ç 
#include "ProjectTreeManager.h"
```

#### Step 2: æ›´æ–°å¯¹è±¡åˆ›å»º

```cpp
// æ—§ä»£ç 
CurveTreeModel* model = new CurveTreeModel(curveManager, this);
treeView->setModel(model);

// æ–°ä»£ç 
ProjectTreeManager* treeManager = new ProjectTreeManager(curveManager, this);
treeView->setModel(treeManager->model());
```

#### Step 3: æ›´æ–° API è°ƒç”¨

```cpp
// è·å–å·²å‹¾é€‰æ›²çº¿
// æ—§: model->getCheckedCurveIds()
// æ–°: treeManager->getCheckedCurveIds()
QStringList checkedIds = treeManager->getCheckedCurveIds();

// è®¾ç½®æ›²çº¿å‹¾é€‰çŠ¶æ€
// æ—§: model->setCurveChecked(curveId, true)
// æ–°: treeManager->setCurveChecked(curveId, true)
treeManager->setCurveChecked(curveId, true);

// è·å–ç´¢å¼•å¯¹åº”çš„æ›²çº¿ID
// æ—§: model->getCurveId(index)
// æ–°: treeManager->getCurveId(index)
QString curveId = treeManager->getCurveId(index);

// åˆ·æ–°æ ‘
// æ—§: model->refresh()
// æ–°: treeManager->refresh()
treeManager->refresh();
```

#### Step 4: æ›´æ–°ä¿¡å·è¿æ¥

```cpp
// æ›²çº¿å‹¾é€‰çŠ¶æ€å˜åŒ–ä¿¡å·å®Œå…¨å…¼å®¹,æ— éœ€ä¿®æ”¹
connect(treeManager, &ProjectTreeManager::curveCheckStateChanged,
        this, &MyWidget::onCurveCheckStateChanged);
```

### API å¯¹ç…§è¡¨

| æ—§ API (CurveTreeModel) | æ–° API (ProjectTreeManager) | è¯´æ˜ |
|------------------------|--------------------------|------|
| `model->getCheckedCurveIds()` | `treeManager->getCheckedCurveIds()` | å®Œå…¨ç›¸åŒ |
| `model->setCurveChecked()` | `treeManager->setCurveChecked()` | å®Œå…¨ç›¸åŒ |
| `model->getCurveId()` | `treeManager->getCurveId()` | å®Œå…¨ç›¸åŒ |
| `model->refresh()` | `treeManager->refresh()` | å®Œå…¨ç›¸åŒ |
| `treeView->setModel(model)` | `treeView->setModel(treeManager->model())` | éœ€è¦è°ƒç”¨ `model()` |
| `model->data()` | `treeManager->model()->data()` | ç›´æ¥ä½¿ç”¨åº•å±‚æ¨¡å‹ |

---

## ğŸ¯ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰æ˜¾ç¤ºæ ·å¼

```cpp
// è®¾ç½®æ›²çº¿èŠ‚ç‚¹çš„å›¾æ ‡
QStandardItem* curveItem = ...; // ä» model ä¸­è·å–
curveItem->setIcon(QIcon(":/icons/curve.png"));

// è®¾ç½®é¡¹ç›®èŠ‚ç‚¹çš„å­—ä½“
QFont boldFont;
boldFont.setBold(true);
projectItem->setFont(boldFont);
```

### 2. æ‰¹é‡æ“ä½œ

```cpp
// å…¨é€‰æ‰€æœ‰æ›²çº¿
void selectAllCurves()
{
    QStringList allCurveIds;
    const QMap<QString, ThermalCurve>& curves = curveManager->getAllCurves();
    
    for (auto it = curves.begin(); it != curves.end(); ++it) {
        treeManager->setCurveChecked(it.key(), true);
    }
}

// å…¨ä¸é€‰
void deselectAllCurves()
{
    QStringList checkedIds = treeManager->getCheckedCurveIds();
    for (const QString& curveId : checkedIds) {
        treeManager->setCurveChecked(curveId, false);
    }
}
```

### 3. å±•å¼€/æŠ˜å æ§åˆ¶

```cpp
// å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
treeView->expandAll();

// æŠ˜å æ‰€æœ‰èŠ‚ç‚¹
treeView->collapseAll();

// åªå±•å¼€é¡¹ç›®èŠ‚ç‚¹(ç¬¬ä¸€å±‚)
for (int i = 0; i < treeManager->model()->rowCount(); ++i) {
    QModelIndex projectIndex = treeManager->model()->index(i, 0);
    treeView->expand(projectIndex);
}
```

### 4. è¿‡æ»¤/æœç´¢

```cpp
// ä½¿ç”¨ QSortFilterProxyModel æ·»åŠ æœç´¢åŠŸèƒ½
QSortFilterProxyModel* proxyModel = new QSortFilterProxyModel(this);
proxyModel->setSourceModel(treeManager->model());
proxyModel->setFilterCaseSensitivity(Qt::CaseInsensitive);
proxyModel->setRecursiveFilteringEnabled(true); // Qt 5.10+

treeView->setModel(proxyModel);

// æœç´¢æ›²çº¿
void searchCurve(const QString& keyword)
{
    proxyModel->setFilterWildcard(keyword);
    treeView->expandAll();
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é¿å…é¢‘ç¹ refresh()

```cpp
// âŒ ä¸å¥½çš„åšæ³•
for (const QString& curveId : curveIds) {
    curveManager->addCurve(curve);  // æ¯æ¬¡éƒ½ä¼šè§¦å‘ onCurveAdded
    treeManager->refresh();  // æ¯æ¬¡éƒ½é‡å»º,å¾ˆæ…¢!
}

// âœ… å¥½çš„åšæ³•
// æ–¹å¼1: ä¸æ‰‹åŠ¨ refresh,è®©ä¿¡å·è‡ªåŠ¨æ›´æ–°
for (const QString& curveId : curveIds) {
    curveManager->addCurve(curve);  // onCurveAdded ä¼šè‡ªåŠ¨å¢é‡æ›´æ–°
}

// æ–¹å¼2: æ‰¹é‡æ·»åŠ åç»Ÿä¸€ refresh
for (const QString& curveId : curveIds) {
    curveManager->addCurveWithoutSignal(curve);
}
treeManager->refresh();  // åªé‡å»ºä¸€æ¬¡
```

### 2. ä½¿ç”¨å»¶è¿ŸåŠ è½½(å¦‚æœæ›²çº¿æ•°é‡è¶…è¿‡ 1000 æ¡)

```cpp
// é¡¹ç›®èŠ‚ç‚¹é»˜è®¤æŠ˜å ,ç”¨æˆ·å±•å¼€æ—¶æ‰åŠ è½½å­æ›²çº¿
connect(treeView, &QTreeView::expanded, [=](const QModelIndex& index) {
    // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    // å¦‚æœæ²¡æœ‰,ä» CurveManager åŠ è½½è¯¥é¡¹ç›®çš„æ›²çº¿
});
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå‹¾é€‰çŠ¶æ€æ²¡æœ‰ä¿å­˜?

**A:** `ProjectTreeManager` ä¸ä¼šè‡ªåŠ¨æŒä¹…åŒ–å‹¾é€‰çŠ¶æ€ã€‚å¦‚æœéœ€è¦ä¿å­˜,è¯·åœ¨åº”ç”¨ä¸­è‡ªå·±å®ç°:

```cpp
// ä¿å­˜è®¾ç½®
void saveSettings()
{
    QSettings settings;
    QStringList checkedIds = treeManager->getCheckedCurveIds();
    settings.setValue("checkedCurves", checkedIds);
}

// æ¢å¤è®¾ç½®
void loadSettings()
{
    QSettings settings;
    QStringList checkedIds = settings.value("checkedCurves").toStringList();
    
    for (const QString& curveId : checkedIds) {
        treeManager->setCurveChecked(curveId, true);
    }
}
```

### Q2: refresh() ä¼šä¸¢å¤±å‹¾é€‰çŠ¶æ€å—?

**A:** ä¼šçš„! `buildTree()` ä¼šé‡å»ºæ•´ä¸ªæ ‘,æ‰€æœ‰å‹¾é€‰çŠ¶æ€ä¼šé‡ç½®ã€‚å¦‚æœéœ€è¦ä¿ç•™,è¯·è¿™æ ·åš:

```cpp
// ä¿å­˜å‹¾é€‰çŠ¶æ€
QStringList checkedIds = treeManager->getCheckedCurveIds();

// åˆ·æ–°
treeManager->refresh();

// æ¢å¤å‹¾é€‰çŠ¶æ€
for (const QString& curveId : checkedIds) {
    treeManager->setCurveChecked(curveId, true);
}
```

### Q3: å¦‚ä½•ç¦ç”¨æŸäº›æ›²çº¿çš„å‹¾é€‰?

**A:** ä¿®æ”¹ `createCurveItem` æ–¹æ³•:

```cpp
QStandardItem* ProjectTreeManager::createCurveItem(const ThermalCurve& curve, bool checked)
{
    QStandardItem* item = new QStandardItem(curve.name());
    
    // æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦å¯å‹¾é€‰
    if (curve.isReadOnly()) {
        item->setCheckable(false);
        item->setEnabled(false);  // ç°è‰²æ˜¾ç¤º
    } else {
        item->setCheckable(true);
        item->setCheckState(checked ? Qt::Checked : Qt::Unchecked);
    }
    
    item->setEditable(false);
    item->setData(curve.id(), Qt::UserRole);
    
    return item;
}
```

---

## ğŸ“¦ å®Œæ•´ç¤ºä¾‹

```cpp
// MyWidget.h
#include <QWidget>
#include "ProjectTreeManager.h"

class MyWidget : public QWidget
{
    Q_OBJECT
public:
    explicit MyWidget(CurveManager* curveManager, QWidget* parent = nullptr);

private slots:
    void onCurveCheckStateChanged(const QString& curveId, bool checked);
    void onSelectAllClicked();
    void onDeselectAllClicked();

private:
    CurveManager* m_curveManager;
    ProjectTreeManager* m_treeManager;
    QTreeView* m_treeView;
};

// MyWidget.cpp
#include "MyWidget.h"
#include <QVBoxLayout>
#include <QPushButton>

MyWidget::MyWidget(CurveManager* curveManager, QWidget* parent)
    : QWidget(parent)
    , m_curveManager(curveManager)
{
    // åˆ›å»ºæ ‘ç®¡ç†å™¨
    m_treeManager = new ProjectTreeManager(curveManager, this);
    
    // åˆ›å»ºæ ‘è§†å›¾
    m_treeView = new QTreeView(this);
    m_treeView->setModel(m_treeManager->model());
    m_treeView->expandAll();
    
    // åˆ›å»ºæŒ‰é’®
    QPushButton* selectAllBtn = new QPushButton("å…¨é€‰", this);
    QPushButton* deselectAllBtn = new QPushButton("å…¨ä¸é€‰", this);
    
    // å¸ƒå±€
    QVBoxLayout* layout = new QVBoxLayout(this);
    
    QHBoxLayout* btnLayout = new QHBoxLayout();
    btnLayout->addWidget(selectAllBtn);
    btnLayout->addWidget(deselectAllBtn);
    
    layout->addWidget(m_treeView);
    layout->addLayout(btnLayout);
    
    // è¿æ¥ä¿¡å·
    connect(m_treeManager, &ProjectTreeManager::curveCheckStateChanged,
            this, &MyWidget::onCurveCheckStateChanged);
    connect(selectAllBtn, &QPushButton::clicked,
            this, &MyWidget::onSelectAllClicked);
    connect(deselectAllBtn, &QPushButton::clicked,
            this, &MyWidget::onDeselectAllClicked);
}

void MyWidget::onCurveCheckStateChanged(const QString& curveId, bool checked)
{
    qDebug() << "æ›²çº¿" << curveId << (checked ? "å·²æ˜¾ç¤º" : "å·²éšè—");
    // æ›´æ–°å›¾è¡¨...
}

void MyWidget::onSelectAllClicked()
{
    const QMap<QString, ThermalCurve>& curves = m_curveManager->getAllCurves();
    for (auto it = curves.begin(); it != curves.end(); ++it) {
        m_treeManager->setCurveChecked(it.key(), true);
    }
}

void MyWidget::onDeselectAllClicked()
{
    QStringList checkedIds = m_treeManager->getCheckedCurveIds();
    for (const QString& curveId : checkedIds) {
        m_treeManager->setCurveChecked(curveId, false);
    }
}
```

---

## ğŸ“ æ€»ç»“

### ä¸ CurveTreeModel å¯¹æ¯”

| ç‰¹æ€§ | CurveTreeModel | ProjectTreeManager |
|------|---------------|------------------|
| ä»£ç é‡ | ~280 è¡Œ | ~170 è¡Œ |
| å­¦ä¹ æ›²çº¿ | éœ€è¦ç†è§£ QAbstractItemModel | åªéœ€äº†è§£ QStandardItem |
| ç»´æŠ¤æˆæœ¬ | é«˜(è‡ªå·±ç»´æŠ¤ç´¢å¼•é€»è¾‘) | ä½(Qt å®˜æ–¹ç»´æŠ¤) |
| æ‰©å±•æ€§ | éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç  | ä¿®æ”¹ QStandardItem å±æ€§å³å¯ |
| æ€§èƒ½ | ç¨å¥½(æ›´ç›´æ¥) | è¶³å¤Ÿå¥½(10000èŠ‚ç‚¹ä»¥å†…) |

### ä½•æ—¶ä½¿ç”¨å“ªä¸ª?

- **ProjectTreeManager (æ¨è)**: 99% çš„åœºæ™¯
  - æ›²çº¿æ•°é‡ < 10,000
  - éœ€è¦å¿«é€Ÿå¼€å‘
  - å›¢é˜Ÿæˆå‘˜ Qt ç»éªŒä¸€èˆ¬

- **CurveTreeModel**: ç‰¹æ®Šåœºæ™¯
  - æ›²çº¿æ•°é‡ > 100,000(éœ€è¦æè‡´æ€§èƒ½)
  - éœ€è¦éå¸¸ç‰¹æ®Šçš„æ•°æ®ç»“æ„
  - å›¢é˜Ÿæœ‰ Qt ä¸“å®¶

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- Qt å®˜æ–¹æ–‡æ¡£: [QStandardItemModel](https://doc.qt.io/qt-5/qstandarditemmodel.html)
- Qt å®˜æ–¹æ–‡æ¡£: [Model/View Programming](https://doc.qt.io/qt-5/model-view-programming.html)
- Qt ç¤ºä¾‹: Simple Tree Model Example
