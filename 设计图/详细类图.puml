@startuml DSC_TGA_Layer_Architecture

' å¸ƒå±€è®¾ç½®
top to bottom direction

skinparam monochrome false
skinparam shadowing false
skinparam packageStyle rectangle
skinparam defaultFontName Microsoft YaHei
skinparam defaultFontSize 14
skinparam classAttributeIconSize 0
skinparam ClassAttributeFontSize 12
skinparam ClassPadding 8
skinparam RoundCorner 8
skinparam nodesep 80
skinparam ranksep 250
skinparam linetype ortho
skinparam ArrowColor #555555
skinparam ArrowThickness 1.5
skinparam ClassBorderColor #999999
skinparam PackageBorderColor #666666
skinparam PackageBorderThickness 2
skinparam PackageTitleFontSize 18
skinparam PackageFontStyle bold
skinparam NoteBackgroundColor #FFFFF5
skinparam NoteBorderColor #DDDDCC
skinparam LegendBackgroundColor #FAFAFA
skinparam LegendBorderColor #E0E0E0

title DSC/TGAçƒ­åˆ†æè½¯ä»¶ - å››å±‚æ¶æ„å›¾(ç±»å…³ç³»è¯¦è§£)\n(åŸºäºQt/C++å¼€å‘)\n\n<b>æ‰§è¡Œé¡ºåºï¼šç¬¬ä¸€å±‚(è¡¨ç¤ºå±‚) â–¼ ç¬¬äºŒå±‚(åº”ç”¨å±‚) â–¼ ç¬¬ä¸‰å±‚(é¢†åŸŸå±‚) â–¼ ç¬¬å››å±‚(åŸºç¡€è®¾æ–½å±‚)</b>

' ========== ç¬¬ä¸€å±‚ï¼šè¡¨ç¤ºå±‚ ==========
package "ã€ç¬¬ä¸€å±‚ã€‘ğŸ–¥ï¸ è¡¨ç¤ºå±‚ (Presentation Layer)\nè´Ÿè´£UIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’" #E3F2FD {
    ' ç»Ÿé¢†ç±» - MainWindow
    class MainWindow {
        --æˆå‘˜å˜é‡--
        - chartView: ChartView*
        - toolPanel: ToolPanel*
        - menuBar: QMenuBar*
        --æ–¹æ³•--
        + setupUI(): void
        + updateCurveList(): void
        --ä¿¡å·--
        <<signal>> openFileRequested()
        <<signal>> saveProjectRequested()
    }

    ' å­ç»„ä»¶ - æ°´å¹³æ’åˆ—
    together {
        class ChartView {
            --æˆå‘˜å˜é‡--
            - chart: QChart*
            - series: QMap<QString, QLineSeries*>
            - decimator: DataDecimator*
            --æ–¹æ³•--
            + addCurve(id, data): void
            + updateCurve(id): void
            --ä¿¡å·--
            <<signal>> regionSelected(id, start, end)
        }

        class ToolPanel {
            --æˆå‘˜å˜é‡--
            - paramLayout: QFormLayout*
            - resultTable: QTableWidget*
            --æ–¹æ³•--
            + showAlgorithmParams(algo): void
        }
    }

    MainWindow *-down- ChartView : ç»„åˆ(æ‹¥æœ‰)
    MainWindow *-down- ToolPanel : ç»„åˆ(æ‹¥æœ‰)
    MainWindow -[hidden]down-> ChartView
    MainWindow -[hidden]down-> ToolPanel
}

' ========== ç¬¬äºŒå±‚ï¼šåº”ç”¨å±‚ ==========
package "ã€ç¬¬äºŒå±‚ã€‘âš™ï¸ åº”ç”¨å±‚ (Application Layer)\nè´Ÿè´£ä¸šåŠ¡åè°ƒå’Œæµç¨‹ç¼–æ’" #F3E5F5 {
    ' ç»Ÿé¢†ç±» - Controllersï¼ˆåè°ƒå™¨ï¼‰
    together {
        class MainController {
            --æˆå‘˜å˜é‡(ä¾èµ–æ³¨å…¥)--
            - projectManager: ProjectManager*
            - curveManager: CurveManager*
            - algorithmService: AlgorithmService*
            - historyManager: HistoryManager*
            --æ–¹æ³•--
            + handleOpenFile(): void
            + handleSaveProject(): void
            + handleUndo(): void
        }

        class ChartController {
            --æˆå‘˜å˜é‡--
            - curveManager: CurveManager*
            - algorithmService: AlgorithmService*
            - historyManager: HistoryManager*
            --æ–¹æ³•--
            + handleRegionSelection(id, start, end): void
            + calculatePeakArea(region): double
        }
    }

    ' æœåŠ¡ç±» - Managers & Servicesï¼ˆè¢«åè°ƒçš„æœåŠ¡ï¼‰
    together {
        class ProjectManager <<Singleton>> {
        --æˆå‘˜å˜é‡--
        - currentProject: ThermalProject*
        - recentProjects: QStringList
        - fileReaderFactory: FileReaderFactory*
        - fileWriterFactory: FileWriterFactory*
        --æ–¹æ³•--
        + instance(): ProjectManager*
        + createProject(): ThermalProject*
        + openProject(path): bool
        + saveProject(): bool
        --ä¿¡å·--
        <<signal>> projectOpened(project)
    }

    class CurveManager <<Singleton>> {
        --æˆå‘˜å˜é‡--
        - curves: QMap<QString, ThermalCurve*>
        - activeCurveId: QString
        --æ–¹æ³•--
        + instance(): CurveManager*
        + addCurve(curve): QString
        + getCurve(id): ThermalCurve*
        + getActiveCurve(): ThermalCurve*
        --ä¿¡å·--
        <<signal>> curveDataChanged(id)
    }

    class AlgorithmService <<Singleton>> {
        --æˆå‘˜å˜é‡--
        - algorithms: QMap<QString, IThermalAlgorithm*>
        - threadPool: QThreadPool*
        --æ–¹æ³•--
        + instance(): AlgorithmService*
        + registerAlgorithm(algo): void
        + executeAsync(name, data): void
        --ä¿¡å·--
        <<signal>> algorithmFinished(result)
    }

        class HistoryManager <<Singleton>> {
            --æˆå‘˜å˜é‡--
            - undoStack: QStack<ICommand*>
            - redoStack: QStack<ICommand*>
            --æ–¹æ³•--
            + instance(): HistoryManager*
            + execute(cmd): bool
            + undo(): void
            + redo(): void
        }
    }

    MainController -down-> ProjectManager : ä½¿ç”¨
    MainController -down-> CurveManager : ä½¿ç”¨
    MainController -down-> AlgorithmService : ä½¿ç”¨
    MainController -down-> HistoryManager : ä½¿ç”¨
    ChartController -down-> CurveManager : ä½¿ç”¨
    ChartController -down-> AlgorithmService : ä½¿ç”¨
    ChartController -down-> HistoryManager : ä½¿ç”¨

    ' å±‚å†…å¸ƒå±€ï¼šControllers åœ¨ä¸Šï¼ŒServices åœ¨ä¸‹
    MainController -[hidden]down-> ProjectManager
    MainController -[hidden]down-> CurveManager
    ChartController -[hidden]down-> AlgorithmService
    ChartController -[hidden]down-> HistoryManager
}

' ========== ç¬¬ä¸‰å±‚ï¼šé¢†åŸŸå±‚ ==========
package "ã€ç¬¬ä¸‰å±‚ã€‘ğŸ¯ é¢†åŸŸå±‚ (Domain Layer)\næ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œå®ä½“æ¨¡å‹" #FFF3E0 {
    ' ç»Ÿé¢†ç±» - èšåˆæ ¹å’Œæ ¸å¿ƒå®ä½“
    together {
        class ThermalProject <<AggregateRoot>> {
            --æˆå‘˜å˜é‡--
            - projectId: QString
            - projectName: QString
            - curves: QList<QString>  {æ›²çº¿IDåˆ—è¡¨}
            - settings: QVariantMap
            --æ–¹æ³•--
            + addCurve(curveId): void
            + removeCurve(curveId): void
            + getCurves(): QList<QString>
        }

        class ThermalCurve <<Entity>> {
            --æˆå‘˜å˜é‡--
            - id: QString
            - name: QString
            - rawData: QVector<ThermalDataPoint>  {åªè¯»}
            - processedData: QVector<ThermalDataPoint>
            - metadata: QVariantMap
            --æ–¹æ³•--
            + getRawData(): const QVector&
            + getProcessedData(): QVector&
            + setProcessedData(data): void
            + resetToRaw(): void
        }
    }

    ' å€¼å¯¹è±¡
    class ThermalDataPoint <<ValueObject>> {
        --æˆå‘˜å˜é‡(åªè¯»)--
        - temperature: double
        - value: double
        - time: double
        - metadata: QVariantMap
        --æ–¹æ³•--
        + getTemperature(): double
        + getValue(): double
        + getTime(): double
    }

    ' é¢†åŸŸæ¥å£å®šä¹‰
    together {
        interface IThermalAlgorithm {
            --çº¯è™šå‡½æ•°--
            + {abstract} process(data): QVector<ThermalDataPoint>
            + {abstract} name(): QString
            + {abstract} parameters(): QVariantMap
            + {abstract} setParameters(params): void
        }

        interface ICommand {
            --çº¯è™šå‡½æ•°--
            + {abstract} execute(): bool
            + {abstract} undo(): void
            + {abstract} redo(): void
            + {abstract} description(): QString
        }
    }

    ThermalCurve *-down- "many" ThermalDataPoint : åŒ…å«(ç»„åˆ)
    ThermalProject o-down- "many" ThermalCurve : å¼•ç”¨(èšåˆ)

    ' å±‚å†…å¸ƒå±€ï¼šèšåˆæ ¹/å®ä½“ åœ¨ä¸Šï¼Œå€¼å¯¹è±¡ åœ¨ä¸­ï¼Œæ¥å£ åœ¨ä¸‹
    ThermalProject -[hidden]down-> ThermalDataPoint
    ThermalCurve -[hidden]down-> ThermalDataPoint
    ThermalDataPoint -[hidden]down-> IThermalAlgorithm
    ThermalDataPoint -[hidden]down-> ICommand
}

' ========== ç¬¬å››å±‚ï¼šåŸºç¡€è®¾æ–½å±‚ ==========
package "ã€ç¬¬å››å±‚ã€‘ğŸ”§ åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)\næŠ€æœ¯å®ç°å’Œåº•å±‚æ”¯æŒ" #E8F5E9 {
    ' ç»Ÿé¢†ç±» - å·¥å‚ï¼ˆFactoryï¼‰
    together {
        class FileReaderFactory <<Singleton>> {
            --æˆå‘˜å˜é‡--
            - readers: QList<IFileReader*>
            --æ–¹æ³•--
            + instance(): FileReaderFactory*
            + registerReader(reader): void
            + getReader(path): IFileReader*
        }

        class FileWriterFactory <<Singleton>> {
            --æˆå‘˜å˜é‡--
            - writers: QList<IFileWriter*>
            --æ–¹æ³•--
            + instance(): FileWriterFactory*
            + registerWriter(writer): void
            + getWriter(path): IFileWriter*
        }
    }

    ' æ¥å£å®šä¹‰
    together {
        interface IFileReader {
            + {abstract} canRead(path): bool
            + {abstract} read(path): ThermalCurve*
            + {abstract} supportedFormats(): QStringList
        }

        interface IFileWriter {
            + {abstract} canWrite(path): bool
            + {abstract} write(path, curve): bool
            + {abstract} supportedFormats(): QStringList
        }
    }

    ' å…·ä½“å®ç°ç±»
    together {
        class TAInstrumentsReader {
            + canRead(path): bool
            + read(path): ThermalCurve*
        }

        class MettlerToledoReader {
            + canRead(path): bool
            + read(path): ThermalCurve*
        }

        class ProjectFileWriter {
            + canWrite(path): bool
            + write(path, project): bool
        }
    }

    ' Algorithmç»„
    together {
        class BaselineCorrector {
            --æˆå‘˜å˜é‡--
            - method: BaselineType
            - degree: int
            --æ–¹æ³•--
            + process(data): QVector<ThermalDataPoint>
            + linearBaseline(data): QVector
            + polynomialFit(data): QVector
        }

        class SmoothingAlgorithm {
            --æˆå‘˜å˜é‡--
            - windowSize: int
            - method: SmoothType
            --æ–¹æ³•--
            + process(data): QVector<ThermalDataPoint>
            + movingAverage(data): QVector
            + savitzkyGolay(data): QVector
        }

        class PeakDetector {
            --æˆå‘˜å˜é‡--
            - threshold: double
            - minPeakDistance: int
            --æ–¹æ³•--
            + process(data): QVector<ThermalDataPoint>
            + detectPeaks(data): QVector<Peak>
            + calculatePeakArea(peak): double
        }

        class KineticsAnalyzer {
            --æˆå‘˜å˜é‡--
            - model: KineticModel
            - heatingRate: double
            --æ–¹æ³•--
            + process(data): QVector<ThermalDataPoint>
            + calculateActivationEnergy(): double
        }
    }

    ' Commandç»„ (å‘½ä»¤æ¨¡å¼å…·ä½“å®ç°)
    together {
        class AlgorithmCommand {
            --æˆå‘˜å˜é‡--
            - curveId: QString
            - algorithm: IThermalAlgorithm*
            - originalData: QVector<ThermalDataPoint>
            - processedData: QVector<ThermalDataPoint>
            --æ–¹æ³•--
            + execute(): bool
            + undo(): void
            + redo(): void
            + description(): QString
        }

        class BaselineCorrectionCommand {
            + execute(): bool
            + undo(): void
            + redo(): void
        }

        class SmoothingCommand {
            + execute(): bool
            + undo(): void
            + redo(): void
        }
    }

    ' Utilityç»„
    together {
        class DataDecimator {
            --æ–¹æ³•--
            + {static} decimate(data, maxPoints): QVector
            + {static} douglasPeucker(data, epsilon): QVector
            + {static} adaptiveDecimate(data, zoom): QVector
        }

        class DataInterpolator {
            --æ–¹æ³•--
            + {static} interpolate(data, x): double
            + {static} linearInterpolation(data, x): double
            + {static} splineInterpolation(data, x): double
        }
    }

    IFileReader <|-down- TAInstrumentsReader : å®ç°
    IFileReader <|-down- MettlerToledoReader : å®ç°
    FileReaderFactory o-down- IFileReader : èšåˆ(æ³¨å†Œå¤šä¸ª)

    IFileWriter <|-down- ProjectFileWriter : å®ç°
    FileWriterFactory o-down- IFileWriter : èšåˆ(æ³¨å†Œå¤šä¸ª)

    IThermalAlgorithm <|-down- BaselineCorrector : å®ç°
    IThermalAlgorithm <|-down- SmoothingAlgorithm : å®ç°
    IThermalAlgorithm <|-down- PeakDetector : å®ç°
    IThermalAlgorithm <|-down- KineticsAnalyzer : å®ç°

    ICommand <|-down- AlgorithmCommand : å®ç°
    AlgorithmCommand <|-down- BaselineCorrectionCommand : ç»§æ‰¿
    AlgorithmCommand <|-down- SmoothingCommand : ç»§æ‰¿

    ' å±‚å†…å¸ƒå±€ï¼šå·¥å‚ åœ¨æœ€ä¸Šï¼Œæ¥å£ åœ¨ä¸­ï¼Œå…·ä½“å®ç° åœ¨ä¸‹
    FileReaderFactory -[hidden]down-> IFileReader
    FileWriterFactory -[hidden]down-> IFileWriter
    IFileReader -[hidden]down-> TAInstrumentsReader
    IFileWriter -[hidden]down-> ProjectFileWriter
    TAInstrumentsReader -[hidden]right-> MettlerToledoReader
}

' ========== å¸ƒå±€æ§åˆ¶(éšè—çº¿) ==========
' å¼ºåˆ¶å››å±‚ä»ä¸Šåˆ°ä¸‹æ’åˆ— - ä½¿ç”¨æ¯å±‚çš„ä»£è¡¨ç±»
' ç¬¬ä¸€å±‚åœ¨æœ€ä¸Šæ–¹
ToolPanel -[hidden]down-> MainController
ToolPanel -[hidden]down-> ProjectManager
ToolPanel -[hidden]down-> CurveManager
ToolPanel -[hidden]down-> AlgorithmService
ChartView -[hidden]down-> ChartController
ChartView -[hidden]down-> MainController
MainWindow -[hidden]down-> CurveManager
MainWindow -[hidden]down-> ProjectManager
MainWindow -[hidden]down-> AlgorithmService

' ç¬¬äºŒå±‚åœ¨ç¬¬ä¸€å±‚ä¸‹æ–¹ï¼ˆå¢åŠ æ›´å¤šè¿æ¥ï¼‰
MainController -[hidden]down-> ThermalProject
MainController -[hidden]down-> ThermalCurve
ProjectManager -[hidden]down-> ThermalCurve
ProjectManager -[hidden]down-> ThermalDataPoint
CurveManager -[hidden]down-> ThermalDataPoint
CurveManager -[hidden]down-> IThermalAlgorithm
AlgorithmService -[hidden]down-> IThermalAlgorithm
AlgorithmService -[hidden]down-> ICommand
ChartController -[hidden]down-> ThermalCurve
HistoryManager -[hidden]down-> ICommand

' ç¬¬ä¸‰å±‚åœ¨ç¬¬äºŒå±‚ä¸‹æ–¹ï¼ˆå¢åŠ æ›´å¤šè¿æ¥ï¼‰
ThermalCurve -[hidden]down-> BaselineCorrector
ThermalCurve -[hidden]down-> SmoothingAlgorithm
ThermalProject -[hidden]down-> FileReaderFactory
ThermalProject -[hidden]down-> TAInstrumentsReader
IThermalAlgorithm -[hidden]down-> SmoothingAlgorithm
IThermalAlgorithm -[hidden]down-> BaselineCorrector
IThermalAlgorithm -[hidden]down-> PeakDetector
ICommand -[hidden]down-> AlgorithmCommand
ICommand -[hidden]down-> BaselineCorrectionCommand
ThermalDataPoint -[hidden]down-> DataDecimator

' ========== è·¨å±‚ä¾èµ–å…³ç³» ==========

' è¡¨ç¤ºå±‚ -> åº”ç”¨å±‚ (ä¿¡å·æ§½è¿æ¥)
MainWindow ..> MainController : <<signal-slot>>
ChartView ..> ChartController : <<signal-slot>>

' è¡¨ç¤ºå±‚ <- åº”ç”¨å±‚ (ç›‘å¬æ•°æ®å˜åŒ–)
MainWindow ..> CurveManager : <<ç›‘å¬ä¿¡å·>>
ChartView ..> CurveManager : <<ç›‘å¬ä¿¡å·>>
ToolPanel ..> AlgorithmService : <<ç›‘å¬ä¿¡å·>>

' è¡¨ç¤ºå±‚ -> åŸºç¡€è®¾æ–½å±‚ (ç›´æ¥ä½¿ç”¨å·¥å…·ç±»)
ChartView --> DataDecimator : ä½¿ç”¨(æŠ½ç¨€æ˜¾ç¤º)

' åº”ç”¨å±‚ -> é¢†åŸŸå±‚
ProjectManager --> ThermalProject : ç®¡ç†
CurveManager --> ThermalCurve : ç®¡ç†
AlgorithmService --> IThermalAlgorithm : ä½¿ç”¨(å¤šæ€)
HistoryManager --> ICommand : ä½¿ç”¨(å¤šæ€)

' åº”ç”¨å±‚ -> åŸºç¡€è®¾æ–½å±‚
ProjectManager --> FileReaderFactory : ä½¿ç”¨
ProjectManager --> FileWriterFactory : ä½¿ç”¨
AlgorithmService o-- IThermalAlgorithm : èšåˆ(æ³¨å†Œå¤šä¸ªç®—æ³•å®ç°)

' åŸºç¡€è®¾æ–½å±‚ -> é¢†åŸŸå±‚ (ä¾èµ–é¢†åŸŸå¯¹è±¡)
BaselineCorrector ..> ThermalDataPoint : ä½¿ç”¨
SmoothingAlgorithm ..> ThermalDataPoint : ä½¿ç”¨
PeakDetector ..> ThermalDataPoint : ä½¿ç”¨
KineticsAnalyzer ..> ThermalDataPoint : ä½¿ç”¨
AlgorithmCommand ..> ThermalDataPoint : ä½¿ç”¨
TAInstrumentsReader ..> ThermalCurve : åˆ›å»º
MettlerToledoReader ..> ThermalCurve : åˆ›å»º
ProjectFileWriter ..> ThermalProject : åºåˆ—åŒ–

' å›¾ä¾‹è¯´æ˜
legend right
  <b>UMLå…³ç³»ç¬¦å·:</b>
  <&arrow-right> â€”â†’  ä¾èµ–(uses)
  <&arrow-right> ..>  ä¾èµ–(signal/slot)
  <&arrow-right> *--  ç»„åˆ(å¼ºæ‹¥æœ‰,ç”Ÿå‘½å‘¨æœŸä¸€è‡´)
  <&arrow-right> o--  èšåˆ(å¼±æ‹¥æœ‰,å¯ç‹¬ç«‹å­˜åœ¨)
  <&arrow-right> <|.. å®ç°æ¥å£

  <b>æˆå‘˜å˜é‡ç±»å‹:</b>
  - member: Type*  (æŒ‡é’ˆæˆå‘˜)
  - member: Type&  (å¼•ç”¨æˆå‘˜)
  - member: QList<Type*>  (å®¹å™¨)

  <b>å±‚æ¬¡èŒè´£:</b>
  <#E3F2FD>è¡¨ç¤ºå±‚</> - UIå±•ç¤º,åªå‘ä¿¡å·
  <#F3E5F5>åº”ç”¨å±‚</> - ä¸šåŠ¡åè°ƒ,ä¾èµ–æ³¨å…¥
  <#FFF3E0>é¢†åŸŸå±‚</> - æ ¸å¿ƒæ¨¡å‹,å®šä¹‰æ¥å£
  <#E8F5E9>åŸºç¡€è®¾æ–½å±‚</> - æŠ€æœ¯å®ç°,å®ç°æ¥å£

  <b>æ¶æ„åŸåˆ™:</b>
  Â· ä¸Šå±‚ä¾èµ–ä¸‹å±‚
  Â· ä¾èµ–å€’ç½®(DIP): é¢†åŸŸå±‚å®šä¹‰æ¥å£,åŸºç¡€è®¾æ–½å±‚å®ç°
  Â· å•ä¸€èŒè´£(SRP): æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªå˜åŒ–åŸå› 
endlegend

@enduml
